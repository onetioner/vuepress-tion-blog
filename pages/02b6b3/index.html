<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第3章-媒资管理模块 | Onetion blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/vuepress-tion-blog/img/favicon.ico">
    <meta name="description" content="暂无描述。">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/vuepress-tion-blog/assets/css/0.styles.e8f25b53.css" as="style"><link rel="preload" href="/vuepress-tion-blog/assets/js/app.985e0c44.js" as="script"><link rel="preload" href="/vuepress-tion-blog/assets/js/2.1e9277be.js" as="script"><link rel="preload" href="/vuepress-tion-blog/assets/js/207.6c3f0adc.js" as="script"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/10.d8aaa1e2.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/100.573bf337.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/101.d7a8d195.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/102.fbe95517.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/103.9c535674.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/104.32351bcc.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/105.b6592589.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/106.8d41efa5.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/107.81a457e6.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/108.8ec864e5.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/109.51239835.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/11.a042cecb.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/110.cacfe028.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/111.0c6750bc.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/112.10684042.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/113.9f9d8990.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/114.f63027de.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/115.f2a98bd3.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/116.1596b700.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/117.7474ad53.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/118.75dfe374.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/119.69b852f5.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/12.b59eab1d.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/120.21dce642.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/121.6383cf7a.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/122.aecc2d6d.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/123.8e4b47dc.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/124.ebeb3341.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/125.d30e0414.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/126.88154b46.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/127.f11c43ad.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/128.d2af5d75.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/129.4ec987d8.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/13.a5c5a2c7.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/130.852e041a.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/131.a2838818.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/132.e76fcb34.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/133.576684f3.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/134.b610dab9.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/135.6ddc8624.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/136.169f274d.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/137.bc17c8fb.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/138.613e8ec5.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/139.a5f28e09.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/14.d548163d.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/140.6f0e2449.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/141.25fa2479.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/142.dbbf3675.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/143.50d1c2c7.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/144.ba7322be.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/145.9b01e005.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/146.a3b7fa06.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/147.10ebf0da.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/148.f1813bc1.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/149.558a4638.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/15.9cd1a424.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/150.9fb25f94.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/151.7aa93b4c.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/152.532b2a06.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/153.b44e17d2.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/154.22bb2b40.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/155.72912290.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/156.8fb9164a.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/157.2993ac86.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/158.941ffddc.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/159.9949acea.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/16.0c491dca.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/160.b0734e8c.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/161.64295a7b.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/162.af6a1a02.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/163.8a084ab0.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/164.b3a5ce11.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/165.006ba217.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/166.8673b3eb.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/167.174f47d0.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/168.ab558478.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/169.2924afe0.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/17.bc0ce024.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/170.938fb8fd.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/171.dba8105e.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/172.3ed2b9da.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/173.21e26430.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/174.cf558b90.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/175.e2dbf973.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/176.99fdd868.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/177.b749e041.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/178.50873a04.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/179.2b2b20b8.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/18.3daae30f.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/180.e02057f8.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/181.4db698f3.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/182.5f8824c7.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/183.6edf3c7c.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/184.1bd636af.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/185.36ff0829.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/186.5cf6e096.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/187.a5a1b8ff.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/188.afbe2342.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/189.03172795.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/19.3baab1b3.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/190.cdbd5be0.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/191.f0b571be.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/192.b17d8025.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/193.71f932fa.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/194.8c1effb7.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/195.97749178.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/196.1c2212a2.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/197.b11aec90.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/198.c944c329.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/199.89d6fb24.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/20.04915620.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/200.1f73ae03.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/201.a76ba977.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/202.6506ac4e.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/203.58b5a385.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/204.5c93632e.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/205.266be28d.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/206.8351bc41.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/208.98b8311d.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/209.c7197c50.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/21.612e714c.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/210.85568730.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/211.57ca633f.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/22.73e68385.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/23.e2dc9896.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/24.dd12884f.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/25.1657ab7c.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/26.fa7585ce.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/27.a745f91e.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/28.9fd9565c.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/29.4a93ed10.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/3.e80e214b.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/30.48d9f0d9.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/31.d1533b42.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/32.577b9985.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/33.804f824e.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/34.6673d1e7.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/35.467aab87.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/36.1ff1934f.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/37.94917ddd.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/38.267be9e6.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/39.6db92b69.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/4.5c19aee3.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/40.4baf779a.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/41.d1f2437d.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/42.7abdd1fb.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/43.daec0261.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/44.e62a9c60.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/45.2d73beaf.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/46.96498038.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/47.84482418.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/48.ec50c17c.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/49.865f9ad3.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/5.9fe40e58.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/50.6bccd4b4.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/51.2f1f7e9d.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/52.53c5b275.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/53.648f4af7.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/54.a8f675df.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/55.857005bf.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/56.21b8b93d.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/57.4267e8e7.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/58.6f22a666.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/59.7ce4c5d3.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/6.7a1e80d8.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/60.bb4d7708.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/61.3ae45564.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/62.36c8a921.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/63.0cf0550f.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/64.c236b268.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/65.3dd549de.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/66.132faef6.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/67.02c3c837.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/68.38da0121.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/69.cfea652f.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/7.e4a9cefa.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/70.115de5a1.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/71.2c0ab68b.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/72.6150c1bb.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/73.485cff3f.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/74.c0d67eb7.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/75.207d3d40.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/76.c4152b85.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/77.fd3d4523.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/78.fb0e3bfd.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/79.0c70e8a7.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/8.1c6e1779.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/80.8d44c6b0.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/81.3764c177.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/82.43478cb4.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/83.c46fe3ff.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/84.aed40128.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/85.9f8f2508.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/86.d250fe69.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/87.c7dfc942.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/88.0ac96029.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/89.5d8f5e20.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/9.4da03d4f.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/90.054f7950.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/91.e05ad0c1.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/92.52f350fe.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/93.26b6b24e.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/94.99e6ce73.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/95.ea8c8ea4.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/96.98e7d194.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/97.14c4ed1b.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/98.f5cdc1ab.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/99.f92a6d95.js">
    <link rel="stylesheet" href="/vuepress-tion-blog/assets/css/0.styles.e8f25b53.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuepress-tion-blog/" class="home-link router-link-active"><img src="/vuepress-tion-blog/img/logo.png" alt="Onetion blog" class="logo"> <span class="site-name can-hide">Onetion blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vuepress-tion-blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文档中心" class="dropdown-title"><a href="/vuepress-tion-blog/learn/" class="link-title">文档中心</a> <span class="title" style="display:none;">文档中心</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>前端文章</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vuepress-tion-blog/pages/8143cc480faf9a11/" class="nav-link">JavaScript</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/javase/" class="nav-link">《JavaSE笔记》</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/javaweb/" class="nav-link">《JavaWeb》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/maven/" class="nav-link">《Maven》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/git/" class="nav-link">《Git》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/ssm/" class="nav-link">《SSM》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/mybatisplus/" class="nav-link">《MybatisPlus》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/reggietakeout/" class="nav-link">《ReggieTakeOut》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/microservice/" class="nav-link">《MicroService》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/xuechengplus/" class="nav-link">《XueChengPlus》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/flume/" class="nav-link">《Flume》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/python/" class="nav-link">《Python》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/scala/" class="nav-link">《Scala》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/linux/" class="nav-link">《Linux》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/hadoop/" class="nav-link">《Hadoop》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/designpatterns/" class="nav-link">《Java设计模式》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/htmlcssweb/" class="nav-link">《HTML-CSS-WEB》笔记</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="页面" class="dropdown-title"><a href="/vuepress-tion-blog/ui/" class="link-title">页面</a> <span class="title" style="display:none;">页面</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/8309a5b876fc95e3/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/0a83b083bdf257cb/" class="nav-link">CSS</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/vuepress-tion-blog/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/9a7ee40fc232253e/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/vuepress-tion-blog/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/baaa02/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/vuepress-tion-blog/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/vuepress-tion-blog/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/vuepress-tion-blog/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://jsd.cdn.zzko.cn/gh/xugaoyi/image_store/blog/20200103123203.jpg"> <div class="blogger-info"><h3>Evan Xu</h3> <span>前端界的小学生</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/vuepress-tion-blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文档中心" class="dropdown-title"><a href="/vuepress-tion-blog/learn/" class="link-title">文档中心</a> <span class="title" style="display:none;">文档中心</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>前端文章</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vuepress-tion-blog/pages/8143cc480faf9a11/" class="nav-link">JavaScript</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/javase/" class="nav-link">《JavaSE笔记》</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/javaweb/" class="nav-link">《JavaWeb》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/maven/" class="nav-link">《Maven》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/git/" class="nav-link">《Git》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/ssm/" class="nav-link">《SSM》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/mybatisplus/" class="nav-link">《MybatisPlus》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/reggietakeout/" class="nav-link">《ReggieTakeOut》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/microservice/" class="nav-link">《MicroService》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/xuechengplus/" class="nav-link">《XueChengPlus》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/flume/" class="nav-link">《Flume》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/python/" class="nav-link">《Python》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/scala/" class="nav-link">《Scala》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/linux/" class="nav-link">《Linux》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/hadoop/" class="nav-link">《Hadoop》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/designpatterns/" class="nav-link">《Java设计模式》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/htmlcssweb/" class="nav-link">《HTML-CSS-WEB》笔记</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="页面" class="dropdown-title"><a href="/vuepress-tion-blog/ui/" class="link-title">页面</a> <span class="title" style="display:none;">页面</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/8309a5b876fc95e3/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/0a83b083bdf257cb/" class="nav-link">CSS</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/vuepress-tion-blog/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/9a7ee40fc232253e/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/vuepress-tion-blog/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/baaa02/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/vuepress-tion-blog/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/vuepress-tion-blog/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/vuepress-tion-blog/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/vuepress-tion-blog/pages/6c93bc/" class="sidebar-link">学成在线项目开发工具配置v1.0</a></li><li><a href="/vuepress-tion-blog/pages/2e1f68/" class="sidebar-link">第1章-项目环境搭建v1.0</a></li><li><a href="/vuepress-tion-blog/pages/e2fb10/" class="sidebar-link">第2章-内容管理</a></li><li><a href="/vuepress-tion-blog/pages/a5a8d0/" class="sidebar-link">第2章-内容管理-实战</a></li><li><a href="/vuepress-tion-blog/pages/02b6b3/" aria-current="page" class="active sidebar-link">第3章-媒资管理模块</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_1-模块需求分析" class="sidebar-link">1. 模块需求分析</a></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_1-1-模块介绍" class="sidebar-link">1.1 模块介绍</a></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_1-2-业务流程" class="sidebar-link">1.2 业务流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_1-2-1-上传图片" class="sidebar-link">1.2.1 上传图片</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_1-2-2-上传视频" class="sidebar-link">1.2.2 上传视频</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_1-2-3-处理视频" class="sidebar-link">1.2.3 处理视频</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_1-2-4-审核媒资" class="sidebar-link">1.2.4 审核媒资</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_1-2-5-绑定媒资" class="sidebar-link">1.2.5 绑定媒资</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_1-3-数据模型" class="sidebar-link">1.3 数据模型</a></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_2-1-架构的问题分析" class="sidebar-link">2.1 架构的问题分析</a></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_2-2-搭建nacos" class="sidebar-link">2.2 搭建Nacos</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_2-2-1-服务发现中心" class="sidebar-link">2.2.1 服务发现中心</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_2-2-2-配置中心" class="sidebar-link">2.2.2 配置中心</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/02b6b3/#_2-2-2-1-配置三要素" class="sidebar-link">2.2.2.1 配置三要素</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/02b6b3/#_2-2-2-2-配置content-service" class="sidebar-link">2.2.2.2 配置content-service</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/02b6b3/#_2-2-2-3-配置content-api" class="sidebar-link">2.2.2.3 配置content-api</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_2-2-3-公用配置" class="sidebar-link">2.2.3 公用配置</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_2-2-4-系统管理配置" class="sidebar-link">2.2.4 系统管理配置</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_2-2-5-配置优先级" class="sidebar-link">2.2.5 配置优先级</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_2-2-6-导入配置文件" class="sidebar-link">2.2.6 导入配置文件</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_2-3-搭建gateway" class="sidebar-link">2.3 搭建Gateway</a></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_3-1-什么是分布式文件系统" class="sidebar-link">3.1 什么是分布式文件系统</a></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_3-2-minio" class="sidebar-link">3.2 MinIO</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_3-2-2-数据恢复演示" class="sidebar-link">3.2.2 数据恢复演示</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_3-2-4-测试docker环境" class="sidebar-link">3.2.4 测试Docker环境</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_3-2-5-sdk" class="sidebar-link">3.2.5 SDK</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/02b6b3/#_3-2-5-1上传文件" class="sidebar-link">3.2.5.1上传文件</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/02b6b3/#_3-2-5-2-删除文件" class="sidebar-link">3.2.5.2 删除文件</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/02b6b3/#_3-2-5-3-查询文件" class="sidebar-link">3.2.5.3 查询文件</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_4-1-需求分析" class="sidebar-link">4.1 需求分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_4-1-1-业务流程" class="sidebar-link">4.1.1 业务流程</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_4-1-2-数据模型" class="sidebar-link">4.1.2 数据模型</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_4-2-准备环境" class="sidebar-link">4.2 准备环境</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_4-3-接口定义" class="sidebar-link">4.3 接口定义</a></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_4-4-接口开发" class="sidebar-link">4.4 接口开发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_4-4-1-dao开发" class="sidebar-link">4.4.1 DAO开发</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_4-4-2-service开发" class="sidebar-link">4.4.2 Service开发</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_4-4-3-完善接口层" class="sidebar-link">4.4.3 完善接口层</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_4-4-4-service代码优化" class="sidebar-link">4.4.4 Service代码优化</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_4-4-4-service事务优化" class="sidebar-link">4.4.4 Service事务优化</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_4-5-接口测试" class="sidebar-link">4.5 接口测试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_4-6-bug修复" class="sidebar-link">4.6 bug修复</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_5-1-需求分析" class="sidebar-link">5.1 需求分析</a></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_5-2-理解断点续传" class="sidebar-link">5.2 理解断点续传</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_5-2-1-什么是断点续传" class="sidebar-link">5.2.1 什么是断点续传</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_5-2-2-分块与合并测试" class="sidebar-link">5.2.2 分块与合并测试</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_5-2-3-上传视频流程" class="sidebar-link">5.2.3 上传视频流程</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_5-3-接口定义" class="sidebar-link">5.3 接口定义</a></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_5-4-接口开发" class="sidebar-link">5.4 接口开发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_5-4-1-dao开发" class="sidebar-link">5.4.1 DAO开发</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_5-4-2-service开发" class="sidebar-link">5.4.2 Service开发</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/02b6b3/#_5-4-2-1-接口定义" class="sidebar-link">5.4.2.1 接口定义</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/02b6b3/#_5-4-2-2-检查文件和分块" class="sidebar-link">5.4.2.2 检查文件和分块</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/02b6b3/#_5-4-2-3-上传分块" class="sidebar-link">5.4.2.3 上传分块</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/02b6b3/#_5-4-2-4-下载分块" class="sidebar-link">5.4.2.4 下载分块</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/02b6b3/#_5-4-2-5-合并分块" class="sidebar-link">5.4.2.5 合并分块</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_5-4-3-接口层完善" class="sidebar-link">5.4.3 接口层完善</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_5-5-接口测试" class="sidebar-link">5.5 接口测试</a></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_6-1-需求分析" class="sidebar-link">6.1 需求分析</a></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_6-2-接口定义" class="sidebar-link">6.2 接口定义</a></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_6-3-接口开发" class="sidebar-link">6.3 接口开发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_6-3-1-dao开发" class="sidebar-link">6.3.1 DAO开发</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_6-3-2-service开发" class="sidebar-link">6.3.2 Service开发</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_6-3-3-接口层完善" class="sidebar-link">6.3.3 接口层完善</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_6-3-4-接口测试" class="sidebar-link">6.3.4 接口测试</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_7-1-视频编码技术" class="sidebar-link">7.1 视频编码技术</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_7-1-1-什么是视频编码" class="sidebar-link">7.1.1 什么是视频编码</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_7-1-2-ffmpeg的基本使用" class="sidebar-link">7.1.2 FFmpeg的基本使用</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_7-2-分布式任务处理" class="sidebar-link">7.2 分布式任务处理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_7-2-1-什么是分布式任务调度" class="sidebar-link">7.2.1 什么是分布式任务调度</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_7-2-2-xxl-job介绍" class="sidebar-link">7.2.2 XXL-JOB介绍</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_7-2-3-搭建xxl-job" class="sidebar-link">7.2.3 搭建XXL-JOB</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/02b6b3/#_7-2-3-1-调度中心" class="sidebar-link">7.2.3.1 调度中心</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/02b6b3/#_7-2-3-2-执行器" class="sidebar-link">7.2.3.2 执行器</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/02b6b3/#_7-2-3-3-执行任务" class="sidebar-link">7.2.3.3 执行任务</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_7-2-5-分片广播" class="sidebar-link">7.2.5 分片广播</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_7-3-需求分析" class="sidebar-link">7.3 需求分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_7-3-1-作业分片方案" class="sidebar-link">7.3.1 作业分片方案</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_7-3-2-业务流程" class="sidebar-link">7.3.2 业务流程</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_7-4-service开发" class="sidebar-link">7.4 Service开发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_7-4-1-dao开发" class="sidebar-link">7.4.1 DAO开发</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_7-4-2-service开发" class="sidebar-link">7.4.2 Service开发</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_7-5-任务开发" class="sidebar-link">7.5 任务开发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_7-5-1-视频处理工具类" class="sidebar-link">7.5.1 视频处理工具类</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_7-5-1-任务类" class="sidebar-link">7.5.1 任务类</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_7-6-视频处理测试" class="sidebar-link">7.6 视频处理测试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_7-6-1-上传视频代码完善" class="sidebar-link">7.6.1 上传视频代码完善</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_7-6-2-视频处理调度策略" class="sidebar-link">7.6.2 视频处理调度策略</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_8-1-需求分析" class="sidebar-link">8.1 需求分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_8-1-1-业务流程" class="sidebar-link">8.1.1 业务流程</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_8-1-2-数据模型" class="sidebar-link">8.1.2 数据模型</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_8-2-接口定义" class="sidebar-link">8.2 接口定义</a></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/02b6b3/#_8-3-接口开发" class="sidebar-link">8.3 接口开发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_8-3-1-dao开发" class="sidebar-link">8.3.1 DAO开发</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_8-3-2-service开发" class="sidebar-link">8.3.2 Service开发</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_8-3-3-接口层完善" class="sidebar-link">8.3.3 接口层完善</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/02b6b3/#_8-3-4-接口测试" class="sidebar-link">8.3.4 接口测试</a></li></ul></li></ul></li><li><a href="/vuepress-tion-blog/pages/7a3e9f/" class="sidebar-link">第4章-课程发布</a></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/vuepress-tion-blog/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/vuepress-tion-blog/note/xuechengplus/#《XueChengPlus》笔记" data-v-06225672>《XueChengPlus》笔记</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/onetioner" target="_blank" title="作者" class="beLink" data-v-06225672>onetion</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2025-01-15</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">第3章-媒资管理模块<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="第3章-媒资管理模块"><a href="#第3章-媒资管理模块" class="header-anchor">#</a> 第3章 媒资管理模块</h1> <h2 id="_1-模块需求分析"><a href="#_1-模块需求分析" class="header-anchor">#</a> 1. 模块需求分析</h2> <h2 id="_1-1-模块介绍"><a href="#_1-1-模块介绍" class="header-anchor">#</a> 1.1 模块介绍</h2> <p>媒资管理系统是每个在线教育平台所必须具备的，查阅百度百科对它的定义如下：</p> <p>媒体资源管理(Media Asset Management，MAM)系统是建立在多媒体、网络、数据库和数字存储等先进技术基础上的一个对各种媒体及内容(如视/音频资料、文本文件、图表等)进行数字化存储、管理以及应用的总体解决方案，包括数字媒体的采集、编目、管理、传输和编码转换等所有环节。其主要是满足<a href="https://baike.baidu.com/item/%E5%AA%92%E4%BD%93?fromModule=lemma_inlink" target="_blank" rel="noopener noreferrer">媒体<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>资源拥有者收集、保存、查找、编辑、发布各种信息的要求，为媒体资源的使用者提供访问内容的便捷方法，实现对媒体资源的高效管理，大幅度提高媒体资源的价值。</p> <p>每个教学机构都可以在媒资系统管理自己的教学资源，包括：视频、教案等文件。</p> <p>目前媒资管理的主要管理对象是视频、图片、文档等，包括：媒资文件的查询、文件上传、视频处理等。</p> <p>媒资查询：教学机构查询自己所拥有的媒资信息。</p> <p>文件上传：包括上传图片、上传文档、上传视频。</p> <p>视频处理：视频上传成功，系统自动对视频进行编码处理。</p> <p>文件删除：教学机构删除自己上传的媒资文件。</p> <p>下图是课程编辑与发布的整体流程，通过下图可以看到媒资在整体流程的位置：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151533273.png" alt="image-20250115153357226"></p> <h2 id="_1-2-业务流程"><a href="#_1-2-业务流程" class="header-anchor">#</a> 1.2 业务流程</h2> <h3 id="_1-2-1-上传图片"><a href="#_1-2-1-上传图片" class="header-anchor">#</a> 1.2.1 上传图片</h3> <p>教学机构人员在课程信息编辑页面上传课程图片，课程图片统一记录在媒资管理系统。</p> <p>下图是上传图片的界面：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151534871.png" alt="image-20250115153432840"></p> <h3 id="_1-2-2-上传视频"><a href="#_1-2-2-上传视频" class="header-anchor">#</a> 1.2.2 上传视频</h3> <p>1、教学机构人员进入媒资管理列表查询自己上传的媒资文件。</p> <p>点击“媒资管理”</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151535786.png" alt="image-20250115153519751"></p> <p>进入媒资管理列表页面查询本机构上传的媒资文件。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151535440.png" alt="image-20250115153534410"></p> <p>2、教育机构用户在&quot;媒资管理&quot;页面中点击 &quot;上传视频&quot; 按钮。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151535155.png" alt="image-20250115153547125"></p> <p>点击“上传视频”打开上传页面</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151535304.png" alt="image-20250115153558273"></p> <p>3、选择要上传的文件，自动执行文件上传。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151536585.png" alt="image-20250115153610555"></p> <p>4、视频上传成功会自动处理，处理完成可以预览视频。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151536629.png" alt="image-20250115153621602"></p> <h3 id="_1-2-3-处理视频"><a href="#_1-2-3-处理视频" class="header-anchor">#</a> 1.2.3 处理视频</h3> <p>对需要转码处理的视频系统会自动对其处理，处理后生成视频的URL。</p> <p>处理视频没有用户界面，完全是后台自动执行。</p> <h3 id="_1-2-4-审核媒资"><a href="#_1-2-4-审核媒资" class="header-anchor">#</a> 1.2.4 审核媒资</h3> <p>1.运营用户登入运营平台并进入媒资管理页面，查找待审核媒资</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151537835.png" alt="image-20250115153714794"></p> <p>2.点击列表中媒资名称链接，可预览该媒资，若是视频，则播放视频。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151537553.png" alt="image-20250115153727520"></p> <p>3.点击列表中某媒资后的&quot;审核&quot; 按钮，既完成媒资的审批过程。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151537787.png" alt="image-20250115153738756"></p> <p>点击“审核”，选择审核结果，输入审核意见。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151537601.png" alt="image-20250115153748564"></p> <h3 id="_1-2-5-绑定媒资"><a href="#_1-2-5-绑定媒资" class="header-anchor">#</a> 1.2.5 绑定媒资</h3> <p>课程计划创建好后需要绑定媒资文件，比如：如果课程计划绑定了视频文件，进入课程在线学习界面后点课程计划名称则在线播放视频。如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151538068.png" alt="image-20250115153823032"></p> <p>如何将课程计划绑定媒资呢？</p> <p>1.教育机构用户进入课程管理页面并编辑某一个课程，在&quot;课程大纲&quot;标签页的某一小节后可点击”添加视频“。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151538677.png" alt="image-20250115153835643"></p> <p>2.弹出添加视频对话框，可通过视频关键字搜索已审核通过的视频媒资。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151538069.png" alt="image-20250115153848037"></p> <p>3.选择视频媒资，点击提交按钮，完成课程计划绑定媒资流程。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151538323.png" alt="image-20250115153859288"></p> <p>课程计划关联视频后如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151539365.png" alt="image-20250115153912337"></p> <h2 id="_1-3-数据模型"><a href="#_1-3-数据模型" class="header-anchor">#</a> 1.3 数据模型</h2> <p>本模块媒资文件相关的数据表如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151539504.png" alt="image-20250115153936422"></p> <p>媒资文件表：存储文件信息，包括图片、视频、文档等。</p> <p>media_process: 待处理视频表。</p> <p>media_process_history: 视频处理历史表，记录已经处理成功的视频信息。</p> <p>媒资文件与课程计划绑定关系表如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151539249.png" alt="image-20250115153950175"></p> <h1 id="_2-搭建模块环境"><a href="#_2-搭建模块环境" class="header-anchor">#</a> 2 搭建模块环境</h1> <h2 id="_2-1-架构的问题分析"><a href="#_2-1-架构的问题分析" class="header-anchor">#</a> 2.1 架构的问题分析</h2> <p>当前要开发的是媒资管理服务，目前为止共三个三微服务：内容管理、系统管理、媒资管理，如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151540955.png" alt="image-20250115154033921"></p> <p>后期还会添加更多的微服务，当前这种由前端直接请求微服务的方式存在弊端：</p> <p>如果在前端对每个请求地址都配置绝对路径，非常不利于系统维护，比如下边代码中请求系统管理服务的地址使用的是localhost</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151540893.png" alt="image-20250115154048856"></p> <p>当系统上线后这里需要改成公网的域名，如果这种地址非常多则非常麻烦。</p> <p>基于这个问题可以采用网关来解决，如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151541163.png" alt="image-20250115154102129"></p> <p>这样在前端的代码中只需要指定每个接口的相对路径，如下所示：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151541245.png" alt="image-20250115154119207"></p> <p>在前端代码的一个固定的地方在接口地址前统一加网关的地址，每个请求统一到网关，由网关将请求转发到具体的微服务。</p> <p>为什么所有的请求先到网关呢？</p> <p>有了网关就可以对请求进行路由，比如：可以根据请求路径路由、根据host地址路由等， 当微服务有多个实例时可以通过负载均衡算法进行路由，如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151541413.png" alt="image-20250115154131387"></p> <p>另外，网关还可以实现权限控制、限流等功能。</p> <p>项目采用Spring Cloud Gateway作为网关，网关在请求路由时需要知道每个微服务实例的地址，项目使用Nacos作用服务发现中心和配置中心，整体的架构图如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151541642.png" alt="image-20250115154142614"></p> <p>流程如下：</p> <p>1、微服务启动，将自己注册到Nacos，Nacos记录了各微服务实例的地址。</p> <p>2、网关从Nacos读取服务列表，包括服务名称、服务地址等。</p> <p>3、请求到达网关，网关将请求路由到具体的微服务。</p> <p>要使用网关首先搭建Nacos，Nacos有两个作用：</p> <p>1、服务发现中心。</p> <p>微服务将自身注册至Nacos，网关从Nacos获取微服务列表。</p> <p>2、配置中心。</p> <p>微服务众多，它们的配置信息也非常复杂，为了提供系统的可维护性，微服务的配置信息统一在Nacos配置。</p> <h2 id="_2-2-搭建nacos"><a href="#_2-2-搭建nacos" class="header-anchor">#</a> 2.2 搭建Nacos</h2> <h3 id="_2-2-1-服务发现中心"><a href="#_2-2-1-服务发现中心" class="header-anchor">#</a> 2.2.1 服务发现中心</h3> <p>根据上节讲解的网关的架构图，要使用网关首先搭建Nacos。</p> <p>首先搭建Nacos服务发现中心。</p> <p>在搭建Nacos服务发现中心之前需要搞清楚两个概念：namespace和group</p> <p>namespace：用于区分环境、比如：开发环境、测试环境、生产环境。</p> <p>group：用于区分项目，比如：xuecheng-plus项目、xuecheng2.0项目</p> <p>首先在nacos配置namespace:</p> <p>登录Centos，启动Naocs，使用sh /data/soft/restart.sh将自动启动Nacos。</p> <p>访问：http://192.168.101.65:8848/nacos/</p> <p>账号密码：nacos/nacos</p> <p>登录成功，点击左侧菜单“命名空间”进入命名空间管理界面，</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151542070.png" alt="image-20250115154250033"></p> <p>点击“新建命名空间”，填写命名空间的相关信息。如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151543612.png" alt="image-20250115154304581"></p> <p>使用相同的方法再创建“测试环境”、&quot;生产环境&quot;的命名空间。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151543235.png" alt="image-20250115154321197"></p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151543878.png" alt="image-20250115154327848"></p> <p>创建成功，如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151543508.png" alt="image-20250115154341481"></p> <p>里创建具体班级的命名空间，假如创建1010班级的命名空间，如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151543738.png" alt="image-20250115154353713"></p> <p>首先完成各服务注册到Naocs，下边将内容管理服务注册到nacos中。</p> <p>1）在xuecheng-plus-parent中添加依赖管理</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring-cloud-alibaba.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>2）在内容管理模块的接口工程、系统管理模块的接口工程中添加如下依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>3）配置nacos的地址</p> <p>在系统管理的接口工程的配置文件中配置如下信息：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>YAML
<span class="token comment">#微服务配置</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">-</span>service
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.101.65<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>在内容管理的接口工程的配置文件中配置如下信息：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>YAML
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>service
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.101.65<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>4）重启内容管理服务、系统管理服务。</p> <p>待微服务启动成功，进入Nacos服务查看服务列表</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151546396.png" alt="image-20250115154615366"></p> <p>在 “开发环境” 命名空间下有两个服务实例。微服务在Nacos注册成功。</p> <p>点击其它一个微服务的“详情”</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151546926.png" alt="image-20250115154630898"></p> <p>通过上图可以查看微服务实例的地址。</p> <h3 id="_2-2-2-配置中心"><a href="#_2-2-2-配置中心" class="header-anchor">#</a> 2.2.2 配置中心</h3> <h4 id="_2-2-2-1-配置三要素"><a href="#_2-2-2-1-配置三要素" class="header-anchor">#</a> 2.2.2.1 配置三要素</h4> <p>搭建完成Nacos服务发现中心，下边搭建Nacos为配置中心，其目的就是通过Nacos去管理项目的所有配置。</p> <p>先将项目中的配置文件分分类：</p> <p>1、每个项目特有的配置</p> <p>是指该配置只在有些项目中需要配置，或者该配置在每个项目中配置的值不同。</p> <p>比如：spring.application.name每个项目都需要配置但值不一样，以及有些项目需要连接数据而有些项目不需要，有些项目需要配置消息队列而有些项目不需要。</p> <p>2、项目所公用的配置</p> <p>是指在若干项目中配置内容相同的配置。比如：redis的配置，很多项目用的同一套redis服务所以配置也一样。</p> <p>另外还需要知道nacos如何去定位一个具体的配置文件，即配置的三要素：namespace、group、dataid.</p> <p>1、通过namespace、group找到具体的环境和具体的项目。</p> <p>2、通过dataid找到具体的配置文件，dataid有三部分组成，</p> <p>比如：content-service-dev.yaml配置文件 由（content-service）-（dev）. (yaml)三部分组成</p> <p>content-service：第一部分，它是在application.yaml中配置的应用名，即spring.application.name的值。</p> <p>dev：第二部分，它是环境名，通过spring.profiles.active指定，</p> <p>Yaml: 第三部分，它是配置文件 的后缀，目前nacos支持properties、yaml等格式类型，本项目选择yaml格式类型。</p> <p>所以，如果我们要配置content-service工程的配置文件:</p> <p>在开发环境中配置content-service-dev.yaml</p> <p>在测试环境中配置content-service-test.yaml</p> <p>在生产环境中配置content-service-prod.yaml</p> <h4 id="_2-2-2-2-配置content-service"><a href="#_2-2-2-2-配置content-service" class="header-anchor">#</a> 2.2.2.2 配置content-service</h4> <p>下边以开发环境为例对content-service工程的配置文件进行配置，进入nacos，进入开发环境。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151548067.png" alt="image-20250115154803029"></p> <p>点击 加号，添加一个配置</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151548713.png" alt="image-20250115154813683"></p> <p>输入data id、group以及配置文件内容。</p> <p>为什么没在nacos中配置下边的内容 ？</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>YAML
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>service

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>因为刚才说了dataid第一部分就是spring.application.name，nacos 客户端要根据此值确定配置文件 名称，所以spring.application.name不在nacos中配置，而是要在工程的本地进行配置。</p> <p>本地配置文件现在是application.yaml需要修改为bootstrap.yaml，因为SpringBoot读取配置文件 的顺序如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151548918.png" alt="image-20250115154850885"></p> <p>所以在content-service工程 中添加bootstrap.yaml，内容如下：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>YAML
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>service
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.101.65<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml
        <span class="token key atrule">refresh-enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token comment">#profiles默认为dev</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>最后删除原来的application.yaml。</p> <p>在内容管理模块的接口工程和service工程、系统管理的接口工程和service工程配置依赖：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>XML
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>配置完成，运行content-service工程 的单元测试文件，能否正常测试。</p> <p>通过运行观察控制台打印出下边的信息：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Plain Text
[NacosRestTemplate.java:476] - HTTP method: POST, url: http://192.168.101.65:8848/nacos/v1/cs/configs/listener, body: {Listening-Configs=content-service.yaml?xuecheng-plus-project??dev?content-service-dev.yaml?xuecheng-plus-project?88459b1483b8381eccc2ef462bd59182?dev?content-service?xuecheng-plus-project??dev?, tenant=dev}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>NacosRestTemplate.java通过Post方式去nacos读取配置信息。</p> <p>跟踪单元测试方法可以正常读取数据库的数据，说明从nacos读取配置信息正常。</p> <h4 id="_2-2-2-3-配置content-api"><a href="#_2-2-2-3-配置content-api" class="header-anchor">#</a> 2.2.2.3 配置content-api</h4> <p>以相同的方法配置content-api工程的配置文件，在nacos中的开发环境中配置content-api-dev.yaml，内容如下：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>YAML
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">servlet</span><span class="token punctuation">:</span>
    <span class="token key atrule">context-path</span><span class="token punctuation">:</span> /content
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">63040</span>

<span class="token comment"># 日志文件配置路径</span>
<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">config</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>log4j2<span class="token punctuation">-</span>dev.xml

<span class="token comment"># swagger 文档配置</span>
<span class="token key atrule">swagger</span><span class="token punctuation">:</span>
  <span class="token key atrule">title</span><span class="token punctuation">:</span> <span class="token string">&quot;学成在线内容管理系统&quot;</span>
  <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">&quot;内容系统管理系统对课程相关信息进行业务管理数据&quot;</span>
  <span class="token key atrule">base-package</span><span class="token punctuation">:</span> com.xuecheng.content
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">version</span><span class="token punctuation">:</span> 1.0.0

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>在content-api工程 的本地配置bootstrap.yaml，内容如下：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>YAML
<span class="token comment">#server:</span>
<span class="token comment">#  servlet:</span>
<span class="token comment">#    context-path: /content</span>
<span class="token comment">#  port: 63040</span>
<span class="token comment">#微服务配置</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>api
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.101.65<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml
        <span class="token key atrule">refresh-enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">extension-configs</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>service<span class="token punctuation">-</span>$<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>.yaml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev

<span class="token comment"># 日志文件配置路径</span>
<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">config</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>log4j2<span class="token punctuation">-</span>dev.xml

<span class="token comment"># swagger 文档配置</span>
<span class="token key atrule">swagger</span><span class="token punctuation">:</span>
  <span class="token key atrule">title</span><span class="token punctuation">:</span> <span class="token string">&quot;学成在线内容管理系统&quot;</span>
  <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">&quot;内容系统管理系统对课程相关信息进行业务管理数据&quot;</span>
  <span class="token key atrule">base-package</span><span class="token punctuation">:</span> com.xuecheng.content
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">version</span><span class="token punctuation">:</span> 1.0.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>注意：因为api接口工程依赖了service工程 的jar，所以这里使用extension-configs扩展配置文件 的方式引用service工程所用到的配置文件。连接不到数据库</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>YAML
        <span class="token key atrule">extension-configs</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>service<span class="token punctuation">-</span>$<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>.yaml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>如果添加多个扩展文件，继续在下添加即可，如下：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>YAML
        <span class="token key atrule">extension-configs</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>service<span class="token punctuation">-</span>$<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>.yaml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> 填写文件 dataid
            <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>启动content-api工程，查询控制台是否打印出了请求nacos的日志，如下:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>Bash
<span class="token punctuation">[</span>NacosRestTemplate.java:476<span class="token punctuation">]</span> - HTTP method: POST, url: http://192.168.101.65:8848/nacos/v1/cs/configs/listener
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>并使用Httpclient测试课程查询接口是否可以正常查询。</p> <h3 id="_2-2-3-公用配置"><a href="#_2-2-3-公用配置" class="header-anchor">#</a> 2.2.3 公用配置</h3> <p>还有一个优化的点是如何在nacos中配置项目的公用配置呢？</p> <p>nacos提供了shared-configs可以引入公用配置。</p> <p>在content-api中配置了swagger，所有的接口工程 都需要配置swagger，这里就可以将swagger的配置定义为一个公用配置，哪个项目用引入即可。</p> <p>单独在xuecheng-plus-common分组下创建xuecheng-plus的公用配置，进入nacos的开发环境，添加swagger-dev.yaml公用配置</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151553561.png" alt="image-20250115155313520"></p> <p>删除接口工程中对swagger的配置。</p> <p>项目使用shared-configs可以引入公用配置。在接口工程的本地配置文件 中引入公用配置，如下：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>api
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.101.65<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml
        <span class="token key atrule">refresh-enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">extension-configs</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>service<span class="token punctuation">-</span>$<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>.yaml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">shared-configs</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> swagger<span class="token punctuation">-</span>$<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>.yaml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>common
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> logging<span class="token punctuation">-</span>$<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>.yaml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>common
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>再以相同 的方法配置日志的公用配置。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151553844.png" alt="image-20250115155350809"></p> <p>在接口工程和业务工程，引入loggin-dev.yaml公用配置文件</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151554830.png" alt="image-20250115155403797"></p> <p>配置完成，重启content-api接口工程，访问http://localhost:63040/content/swagger-ui.html 查看swagger接口文档是否可以正常访问，查看控制台log4j2日志输出是否正常。</p> <h3 id="_2-2-4-系统管理配置"><a href="#_2-2-4-系统管理配置" class="header-anchor">#</a> 2.2.4 系统管理配置</h3> <p>按照上边的方法 自行将系统管理服务的配置信息在nacos上进行配置。</p> <h3 id="_2-2-5-配置优先级"><a href="#_2-2-5-配置优先级" class="header-anchor">#</a> 2.2.5 配置优先级</h3> <p>到目前为止已将所有微服务的配置统一在nacos进行配置，用到的配置文件有本地的配置文件 bootstrap.yaml和nacos上的配置文件，引入配置文件的形式有：</p> <p>1、通过dataid方式引入</p> <p>2、以扩展配置文件方式引入</p> <p>3、以共享配置文件 方式引入</p> <p>下边测试这几种配置文件方式的优先级。</p> <p>我们使用内容管理服务中的配置文件，首先在共享配置文件 swagger-dev.yaml中配置四个配置项，如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151555247.png" alt="image-20250115155511209"></p> <p>配置完成发布。</p> <p>下边在content-api工程的启动类中添加如下代码读取这四个配置项的值</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng</span><span class="token punctuation">;</span>


<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>spring4all<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span></span><span class="token class-name">EnableSwagger2Doc</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@EnableSwagger2Doc</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ContentApplication</span> <span class="token punctuation">{</span>

   <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${test_config.a}&quot;</span><span class="token punctuation">)</span>
   <span class="token class-name">String</span> a<span class="token punctuation">;</span>
   <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${test_config.b}&quot;</span><span class="token punctuation">)</span>
   <span class="token class-name">String</span> b<span class="token punctuation">;</span>
   <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${test_config.c}&quot;</span><span class="token punctuation">)</span>
   <span class="token class-name">String</span> c<span class="token punctuation">;</span>
   <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${test_config.d}&quot;</span><span class="token punctuation">)</span>
   <span class="token class-name">String</span> d<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Bean</span>
   <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;a=&quot;</span><span class="token operator">+</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;b=&quot;</span><span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;c=&quot;</span><span class="token operator">+</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;d=&quot;</span><span class="token operator">+</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ContentApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>启动content-api工程，在return new Integer(1);处打断点，运行到断点处，如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151555819.png" alt="image-20250115155553785"></p> <p>这说明已经成功读取到 四个配置项的值。</p> <p>下边在content-api工程的扩展配置文件 conent-service-dev.yaml中配置三个配置项，如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151556269.png" alt="image-20250115155612232"></p> <p>再次重启content-api工程，在return new Integer(1);处打断点，运行到断点处，如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151556364.png" alt="image-20250115155624330"></p> <p>从结果可以看出，扩展配置文件比共享配置文件优先级高。</p> <p>下边继续content-api-dev.yaml中配置两个配置项，如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151556725.png" alt="image-20250115155635694"></p> <p>再次重启内容管理接口工程，在return new Integer(1);处打断点，运行到断点处，如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151556589.png" alt="image-20250115155648550"></p> <p>从结果可以看出，通过工程的应用名找到配置文件 content-api-dev.yaml优先级比扩展配置文件 高。</p> <p>下边我们在content-api工程的本地配置文件bootstrap.yaml中配置如下：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">test_config</span><span class="token punctuation">:</span>
  <span class="token key atrule">a</span><span class="token punctuation">:</span> 4a
  <span class="token key atrule">b</span><span class="token punctuation">:</span> 4b
  <span class="token key atrule">c</span><span class="token punctuation">:</span> 4c
  <span class="token key atrule">d</span><span class="token punctuation">:</span> 4d
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>再次重启内容管理接口工程，在return new Integer(1);处打断点，运行到断点处，如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151557305.png" alt="image-20250115155718267"></p> <p>这说明本地配置文件配置的内容没有起作用，原因是nacos配置文件中的相同的配置项覆盖了本地的配置项。</p> <p>到这可以总结各各配置文件 的优先级：项目应用名配置文件 &gt; 扩展配置文件 &gt; 共享配置文件 &gt; 本地配置文件。</p> <p>有时候我们在测试程序时直接在本地加一个配置进行测试，这时我们想让本地最优先，可以在nacos配置文件 中配置如下即可实现：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment">#配置本地优先</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
 <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
  <span class="token key atrule">config</span><span class="token punctuation">:</span>
    <span class="token key atrule">override-none</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>再次重启content-api工程，在return new Integer(1);处打断点，运行到断点处，如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151558505.png" alt="image-20250115155801466"></p> <p>可以看出此时本地配置最优先。</p> <h3 id="_2-2-6-导入配置文件"><a href="#_2-2-6-导入配置文件" class="header-anchor">#</a> 2.2.6 导入配置文件</h3> <p>课程资料中提供了系统用的所有配置文件nacos_config_export.zip，下边将nacos_config_export.zip导入nacos。</p> <p>进入具体的命名空间，点击“导入配置”</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151558393.png" alt="image-20250115155831356"></p> <p>打开导入窗口</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151558210.png" alt="image-20250115155841174"></p> <p>相同的配置选择覆盖配置。</p> <p>点击“上传文件”选择nacos_config_export.zip开始导入。</p> <h2 id="_2-3-搭建gateway"><a href="#_2-3-搭建gateway" class="header-anchor">#</a> 2.3 搭建Gateway</h2> <p>本项目使用Spring Cloud Gateway作为网关，下边创建网关工程。</p> <p>新建一个网关工程。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151559635.png" alt="image-20250115155915588"></p> <p>工程结构</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151559308.png" alt="image-20250115155926269"></p> <p>添加依赖：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--网关--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--服务发现中心--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- 排除 Spring Boot 依赖的日志包冲突 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-logging<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- Spring Boot 集成 log4j2 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-log4j2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>


<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>配置网关的bootstrap.yaml配置文件</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment">#微服务配置</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.101.65<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml
        <span class="token key atrule">refresh-enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">shared-configs</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> logging<span class="token punctuation">-</span>$<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>.yaml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>common
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>


  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>在nacos上配置网关路由策略：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151600985.png" alt="image-20250115160028944"></p> <p>详细配置如下：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">63010</span> <span class="token comment"># 网关端口</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
<span class="token comment">#      filter:</span>
<span class="token comment">#        strip-prefix:</span>
<span class="token comment">#          enabled: true</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span> <span class="token comment"># 网关路由配置</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> content<span class="token punctuation">-</span>api <span class="token comment"># 路由id，自定义，只要唯一即可</span>
          <span class="token comment"># uri: http://127.0.0.1:8081 # 路由的目标地址 http就是固定地址</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//content<span class="token punctuation">-</span>api <span class="token comment"># 路由的目标地址 lb就是负载均衡，后面跟服务名称</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span> <span class="token comment"># 路由断言，也就是判断请求是否符合路由规则的条件</span>
            <span class="token punctuation">-</span> Path=/content/<span class="token important">**</span> <span class="token comment"># 这个是按照路径匹配，只要以/content/开头就符合要求</span>
<span class="token comment">#          filters:</span>
<span class="token comment">#            - StripPrefix=1</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> system<span class="token punctuation">-</span>api
          <span class="token comment"># uri: http://127.0.0.1:8081</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//system<span class="token punctuation">-</span>api
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/system/<span class="token important">**</span>
<span class="token comment">#          filters:</span>
<span class="token comment">#            - StripPrefix=1</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> media<span class="token punctuation">-</span>api
          <span class="token comment"># uri: http://127.0.0.1:8081</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//media<span class="token punctuation">-</span>api
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/media/<span class="token important">**</span>
<span class="token comment">#          filters:</span>
<span class="token comment">#            - StripPrefix=1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>启动网关工程，通过网关工程访问微服务进行测试。</p> <p>在http-client-env.json中配置网关的地址</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151601164.png" alt="image-20250115160134125"></p> <p>使用httpclient测试课程查询 接口，如下：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>### 课程查询列表
POST <span class="token punctuation">{</span><span class="token punctuation">{</span>gateway_host<span class="token punctuation">}</span><span class="token punctuation">}</span>/content/course/list?pageNo=<span class="token number">2</span>&amp;pageSize=<span class="token number">1</span>
Content-Type<span class="token operator">:</span> application/json

<span class="token punctuation">{</span>
  <span class="token property">&quot;auditStatus&quot;</span><span class="token operator">:</span> <span class="token string">&quot;202002&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;courseName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>运行，观察是否可以正常访问接口 ，如下所示可以正常请求接口。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>http<span class="token operator">:</span><span class="token comment">//localhost:63010/content/course/list?pageNo=2&amp;pageSize=1</span>

HTTP/<span class="token number">1.1</span> <span class="token number">200</span> OK
transfer-encoding<span class="token operator">:</span> chunked
Content-Type<span class="token operator">:</span> application/json
Date<span class="token operator">:</span> Sun<span class="token punctuation">,</span> <span class="token number">11</span> Sep <span class="token number">2022</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">54</span><span class="token operator">:</span><span class="token number">32</span> GMT

<span class="token punctuation">{</span>
  <span class="token property">&quot;items&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">26</span><span class="token punctuation">,</span>
      <span class="token property">&quot;companyId&quot;</span><span class="token operator">:</span> <span class="token number">1232141425</span><span class="token punctuation">,</span>
      <span class="token property">&quot;companyName&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;spring cloud实战&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;users&quot;</span><span class="token operator">:</span> <span class="token string">&quot;所有人&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
      <span class="token property">&quot;mt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1-3&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;mtName&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
      <span class="token property">&quot;st&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1-3-2&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;stName&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
      <span class="token property">&quot;grade&quot;</span><span class="token operator">:</span> <span class="token string">&quot;200003&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;teachmode&quot;</span><span class="token operator">:</span> <span class="token string">&quot;201001&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;本课程主要从四个章节进行讲解： 1.微服务架构入门 2.spring cloud 基础入门 3.实战Spring Boot 4.注册中心eureka。&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;pic&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://cdn.educba.com/academy/wp-content/uploads/2018/08/Spring-BOOT-Interview-questions.jpg&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;createDate&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2019-09-04 09:56:19&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;changeDate&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2021-12-26 22:10:38&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;createPeople&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
      <span class="token property">&quot;changePeople&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
      <span class="token property">&quot;auditStatus&quot;</span><span class="token operator">:</span> <span class="token string">&quot;202002&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token string">&quot;203001&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;coursePubId&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
      <span class="token property">&quot;coursePubDate&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;counts&quot;</span><span class="token operator">:</span> <span class="token number">29</span><span class="token punctuation">,</span>
  <span class="token property">&quot;page&quot;</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token property">&quot;pageSize&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>网关工程搭建完成即可将前端工程中的接口地址改为网关的地址</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151602035.png" alt="image-20250115160232992"></p> <p>启动前端工程，测试之前开发内容管理模块的功能。</p> <p>2.4 搭建媒资工程</p> <p>至此网关、Nacos已经搭建完成，下边将媒资工程导入项目。</p> <p>从课程资料中获取媒资工程 xuecheng-plus-media，拷贝到项目工程根目录。</p> <p>右键pom.xml转为maven工程。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151603505.png" alt="image-20250115160310451"></p> <p>创建媒资数据库，并导入xcplus_media.sql</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151603504.png" alt="image-20250115160323457"></p> <p>重启media-api工程。</p> <h1 id="_3-分布式文件系统"><a href="#_3-分布式文件系统" class="header-anchor">#</a> 3 分布式文件系统</h1> <h2 id="_3-1-什么是分布式文件系统"><a href="#_3-1-什么是分布式文件系统" class="header-anchor">#</a> 3.1 什么是分布式文件系统</h2> <p>要理解分布式文件系统首先了解什么是文件系统。</p> <p>查阅百度百科：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151604597.png" alt="image-20250115160404556"></p> <p>文件系统是负责管理和存储文件的系统软件，操作系统通过文件系统提供的接口去存取文件，用户通过操作系统访问磁盘上的文件。</p> <p>下图指示了文件系统所处的位置：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151604414.png" alt="image-20250115160416379"></p> <p>常见的文件系统：FAT16/FAT32、NTFS、HFS、UFS、APFS、XFS、Ext4等 。</p> <p>现在有个问题，一此短视频平台拥有大量的视频、图片，这些视频文件、图片文件该如何存储呢？如何存储可以满足互联网上海量用户的浏览。</p> <p>今天讲的分布式文件系统就是海量用户查阅海量文件的方案。</p> <p>我们阅读百度百科去理解分布式文件系统的定义：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151604448.png" alt="image-20250115160428414"></p> <p>通过概念可以简单理解为：一个计算机无法存储海量的文件，通过网络将若干计算机组织起来共同去存储海量的文件，去接收海量用户的请求，这些组织起来的计算机通过网络进行通信，如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151604610.png" alt="image-20250115160440553"></p> <p>好处：</p> <p>1、一台计算机的文件系统处理能力扩充到多台计算机同时处理。</p> <p>2、一台计算机挂了还有另外副本计算机提供数据。</p> <p>3、每台计算机可以放在不同的地域，这样用户就可以就近访问，提高访问速度。</p> <p>市面上有哪些分布式文件系统的产品呢？</p> <p>1、NFS</p> <p>阅读百度百科：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151604853.png" alt="image-20250115160456816"></p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151605486.png" alt="image-20250115160504432"></p> <p>特点：</p> <p>1）在客户端上映射NFS服务器的驱动器。</p> <p>2）客户端通过网络访问NFS服务器的硬盘完全透明。</p> <p>2、GFS</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151608995.png" alt="image-20250115160810922"></p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151608023.png" alt="image-20250115160815986"></p> <p>1）GFS采用主从结构，一个GFS集群由一个master和大量的chunkserver组成。</p> <p>2）master存储了数据文件的元数据，一个文件被分成了若干块存储在多个chunkserver中。</p> <p>3）用户从master中获取数据元信息，向chunkserver存储数据。</p> <p>3、HDFS</p> <p>HDFS，是Hadoop Distributed File System的简称，是Hadoop抽象文件系统的一种实现。HDFS是一个高度容错性的系统，适合部署在廉价的机器上。HDFS能提供高吞吐量的数据访问，非常适合大规模数据集上的应用。 HDFS的文件分布在集群机器上，同时提供副本进行容错及可靠性保证。例如客户端写入读取文件的直接操作都是分布在集群各个机器上的，没有单点性能压力。</p> <p>下图是HDFS的架构图：</p> <p>HDFS，是Hadoop Distributed File System的简称，是Hadoop抽象文件系统的一种实现。HDFS是一个高度容错性的系统，适合部署在廉价的机器上。HDFS能提供高吞吐量的数据访问，非常适合大规模数据集上的应用。 HDFS的文件分布在集群机器上，同时提供副本进行容错及可靠性保证。例如客户端写入读取文件的直接操作都是分布在集群各个机器上的，没有单点性能压力。</p> <p>下图是HDFS的架构图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151608387.png" alt="image-20250115160852320"></p> <p>1）HDFS采用主从结构，一个HDFS集群由一个名称结点和若干数据结点组成。</p> <p>\2) 名称结点存储数据的元信息，一个完整的数据文件分成若干块存储在数据结点。</p> <p>3）客户端从名称结点获取数据的元信息及数据分块的信息，得到信息客户端即可从数据块来存取数据。</p> <p>4）云计算厂家</p> <p>阿里云对象存储服务（Object Storage Service，简称 OSS），是阿里云提供的海量、安全、低成本、高可靠的云存储服务。其数据设计持久性不低于 99.9999999999%（12 个 9），服务设计可用性（或业务连续性）不低于 99.995%。</p> <p><em>官方网站：</em><a href="https://www.aliyun.com/product/oss" target="_blank" rel="noopener noreferrer"><em>https://www.aliyun.com/product/oss</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>百度对象存储BOS提供稳定、安全、高效、高可扩展的云存储服务。您可以将任意数量和形式的非结构化数据存入BOS，并对数据进行管理和处理。BOS支持标准、低频、冷和归档存储等多种存储类型，满足多场景的存储需求。</p> <p><em>官方网站：</em><a href="https://cloud.baidu.com/product/bos.html" target="_blank" rel="noopener noreferrer"><em>https://cloud.baidu.com/product/bos.html</em><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="_3-2-minio"><a href="#_3-2-minio" class="header-anchor">#</a> 3.2 MinIO</h2> <p><strong>3.2.1</strong> <strong>介绍</strong></p> <p>本项目采用MinIO构建分布式文件系统，MinIO 是一个非常轻量的服务,可以很简单的和其他应用的结合使用，它兼容亚马逊 S3 云存储服务接口，非常适合于存储大容量非结构化的数据，例如图片、视频、日志文件、备份数据和容器/虚拟机镜像等。</p> <p>它一大特点就是轻量，使用简单，功能强大，支持各种平台，单个文件最大5TB，兼容 Amazon S3接口，提供了 Java、Python、GO等多版本SDK支持。</p> <p>官网：https://min.io</p> <p>中文：https://www.minio.org.cn/，http://docs.minio.org.cn/docs/</p> <p>MinIO集群采用去中心化共享架构，每个结点是对等关系，通过Nginx可对MinIO进行负载均衡访问。</p> <p>去中心化有什么好处？</p> <p>在大数据领域，通常的设计理念都是无中心和分布式。Minio分布式模式可以帮助你搭建一个高可用的对象存储服务，你可以使用这些存储设备，而不用考虑其真实物理位置。</p> <p>它将分布在不同服务器上的多块硬盘组成一个对象存储服务。由于硬盘分布在不同的节点上，分布式Minio避免了单点故障。如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151609572.png" alt="image-20250115160958523"></p> <p>Minio使用纠删码技术来保护数据，它是一种恢复丢失和损坏数据的数学算法，它将数据分块冗余的分散存储在各各节点的磁盘上，所有的可用磁盘组成一个集合，上图由8块硬盘组成一个集合，当上传一个文件时会通过纠删码算法计算对文件进行分块存储，除了将文件本身分成4个数据块，还会生成4个校验块，数据块和校验块会分散的存储在这8块硬盘上。</p> <p>使用纠删码的好处是即便丢失一半数量（N/2）的硬盘，仍然可以恢复数据。 比如上边集合中有4个以内的硬盘损害仍可保证数据恢复，不影响上传和下载，如果多于一半的硬盘坏了则无法恢复。</p> <h3 id="_3-2-2-数据恢复演示"><a href="#_3-2-2-数据恢复演示" class="header-anchor">#</a> 3.2.2 数据恢复演示</h3> <p>下边在本机演示MinIO恢复数据的过程，在本地创建4个目录表示4个硬盘。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151610153.png" alt="image-20250115161044119"></p> <p>首先下载MinIO，下载地址：https://dl.min.io/server/minio/release/，也可从课程资料找到MinIO的安装文件。</p> <p>CMD进入有minio.exe的目录，运行下边的命令：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>minio.exe server D:\develop\minio_data\data1  D:\develop\minio_data\data2  D:\develop\minio_data\data3  D:\develop\minio_data\data4
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>启动结果如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151611246.png" alt="image-20250115161131203"></p> <p>说明如下：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>WARNING: MINIO_ACCESS_KEY <span class="token operator">and</span> MINIO_SECRET_KEY are deprecated<span class="token punctuation">.</span>
         Please <span class="token keyword">use</span> MINIO_ROOT_USER <span class="token operator">and</span> MINIO_ROOT_PASSWORD
Formatting <span class="token number">1</span>st pool<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">set</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span> drives per <span class="token keyword">set</span><span class="token punctuation">.</span>
WARNING: Host <span class="token keyword">local</span> has more than <span class="token number">2</span> drives <span class="token keyword">of</span> <span class="token keyword">set</span><span class="token punctuation">.</span> A host failure will result <span class="token operator">in</span> <span class="token keyword">data</span> becoming unavailable<span class="token punctuation">.</span>
WARNING: Detected <span class="token keyword">default</span> credentials <span class="token string">'minioadmin:minioadmin'</span><span class="token punctuation">,</span> we recommend that you change these <span class="token keyword">values</span> <span class="token keyword">with</span> <span class="token string">'MINIO_ROOT_USER'</span> <span class="token operator">and</span> <span class="token string">'MINIO_ROOT_PASSWORD'</span> environment variables
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>1）老版本使用的MINIO_ACCESS_KEY 和 MINIO_SECRET_KEY不推荐使用，推荐使用MINIO_ROOT_USER 和MINIO_ROOT_PASSWORD设置账号和密码。</p> <p>2）pool即minio节点组成的池子，当前有一个pool和4个硬盘组成的set集合</p> <p>3）因为集合是4个硬盘，大于2的硬盘损坏数据将无法恢复。</p> <p>4）账号和密码默认为minioadmin、minioadmin，可以在环境变量中设置通过'MINIO_ROOT_USER' and 'MINIO_ROOT_PASSWORD' 进行设置。</p> <p>下边输入http://localhost:9000进行登录。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151612043.png" alt="image-20250115161203959"></p> <p>登录成功：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151612041.png" alt="image-20250115161213999"></p> <p>下一步创建bucket，桶，它相当于存储文件的目录，可以创建若干的桶。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151612352.png" alt="image-20250115161224307"></p> <p>输入bucket的名称，点击“CreateBucket”，创建成功</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151612760.png" alt="image-20250115161235724"></p> <p>点击“upload”上传文件。</p> <p>下边上传几个文件</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151612741.png" alt="image-20250115161246699"></p> <p>下边去四个目录观察文件的存储情况</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151612146.png" alt="image-20250115161256100"></p> <p>我们发现上传的1.mp4文件存储在了四个目录，即四个硬盘上。</p> <p>下边测试minio的数据恢复过程：</p> <p>1、首先删除一个目录。</p> <p>删除目录后仍然可以在web控制台上传文件和下载文件。</p> <p>稍等片刻删除的目录自动恢复。</p> <p>2、删除两个目录。</p> <p>删除两个目录也会自动恢复。</p> <p>3、删除三个目录 。</p> <p>由于 集合中共有4块硬盘，有大于一半的硬盘损坏数据无法恢复。</p> <p>此时报错：We encountered an internal error, please try again. (Read failed. Insufficient number of drives online)在线驱动器数量不足。</p> <p><strong>3.2.4</strong> <strong>分布式集群测试</strong></p> <p>条件允许的情况下可以测试MinIO分布式存储的特性，首先准备环境。</p> <p>分布式MinIO要求至少四个磁盘，建议至少4个节点，每个节点2个磁盘。</p> <p>准备四台虚拟机：192.168.101.65、192.168.101.66、192.168.101.67、192.168.101.68</p> <p>将课程资料下的minio的执行文件拷贝到四台虚拟机的/home/minio/目录下。</p> <p>在四台虚拟机分别创建下边的脚本run.sh，内容如下：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token comment"># 创建日志目录</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /boot/mediafiles/logs
<span class="token comment"># 创建存储目录</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /boot/mediafiles/data/d<span class="token punctuation">{</span><span class="token number">1,2</span>,3,4<span class="token punctuation">}</span>
<span class="token comment"># 创建配置目录</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/minio
<span class="token builtin class-name">export</span> <span class="token assign-left variable">MINIO_ROOT_USER</span><span class="token operator">=</span>minioadmin
<span class="token builtin class-name">export</span> <span class="token assign-left variable">MINIO_ROOT_PASSWORD</span><span class="token operator">=</span>minioadmin

<span class="token comment"># 在四台机器上都执行该文件，以分布式的方式启动minio</span>
<span class="token comment"># --address 为api端口（如Java客户端）访问的端口</span>
<span class="token comment"># --console-address web控制台端口</span>
/home/minio/minio server <span class="token punctuation">\</span>
http://192.168.101.65:9000/home/mediafiles/data/export1 <span class="token punctuation">\</span>
http://192.168.101.65:9000/home/mediafiles/data/export2 <span class="token punctuation">\</span>
http://192.168.101.66:9000/home/mediafiles/data/export1 <span class="token punctuation">\</span>
http://192.168.101.66:9000/home/mediafiles/data/export2 <span class="token punctuation">\</span>
http://192.168.101.67:9000/home/mediafiles/data/export1 <span class="token punctuation">\</span>
http://192.168.101.67:9000/home/mediafiles/data/export2 <span class="token punctuation">\</span>
http://192.168.101.68:9000/home/mediafiles/data/export1 <span class="token punctuation">\</span>
http://192.168.101.68:9000/home/mediafiles/data/export2 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>在四台虚拟机执行脚本run.sh，注意观察日志。</p> <p>启动成功后访问： http://192.168.101.66:9001/、http://192.168.101.67:9001/、http://192.168.101.68:9001/、http://192.168.101.69:9001/。</p> <p>访问任意一个都可以操作 minio集群。</p> <p>下边进行测试：</p> <p>1、向集群上传一个文件，观察每个节点的两个磁盘目录都存储了数据。</p> <p>2、停止 一个节点，不影响上传和下载。</p> <p>假如停止了65节点，通过其它节点上传文件，稍后启动65后自动从其它结点同步文件。</p> <p>3、停止 两个节点，无法上传，可以下载。</p> <p>此时上传文件客户端报错如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151614038.png" alt="image-20250115161404994"></p> <p>上传文件需要至少一半加1个可用的磁盘。</p> <p>将停止的两个节点的minio启动，稍等片刻 minio恢复可用。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151614989.png" alt="image-20250115161414953"></p> <h3 id="_3-2-4-测试docker环境"><a href="#_3-2-4-测试docker环境" class="header-anchor">#</a> 3.2.4 测试Docker环境</h3> <p>开发阶段和生产阶段统一使用Docker下的MINIO。</p> <p>在下发的虚拟机中已安装了MinIO的镜像和容器，执行sh /data/soft /restart.sh启动Docker下的MinIO</p> <p>启动完成登录MinIO查看是否正常。</p> <p>访问http://192.168.101.65:9000</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151614425.png" alt="image-20250115161445377"></p> <p>本项目创建两个buckets：</p> <p>mediafiles： 普通文件</p> <p>video：视频文件</p> <h3 id="_3-2-5-sdk"><a href="#_3-2-5-sdk" class="header-anchor">#</a> 3.2.5 SDK</h3> <h4 id="_3-2-5-1上传文件"><a href="#_3-2-5-1上传文件" class="header-anchor">#</a> 3.2.5.1上传文件</h4> <p>MinIO提供多个语言版本SDK的支持，下边找到java版本的文档：</p> <p>地址：https://docs.min.io/docs/java-client-quickstart-guide.html</p> <p>最低需求Java 1.8或更高版本:</p> <p>maven依赖如下：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.minio<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>minio<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>8.4.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.squareup.okhttp3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>okhttp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.8.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>在media-service工程添加此依赖。</p> <p>参数说明：</p> <p>需要三个参数才能连接到minio服务。</p> <table><thead><tr><th>参数</th> <th>说明</th></tr></thead> <tbody><tr><td>Endpoint</td> <td>对象存储服务的URL</td></tr> <tr><td>Access  Key</td> <td>Access  key就像用户ID，可以唯一标识你的账户。</td></tr> <tr><td>Secret  Key</td> <td>Secret  key是你账户的密码。</td></tr></tbody></table> <p>示例代码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span></span><span class="token class-name">BucketExistsArgs</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span></span><span class="token class-name">MakeBucketArgs</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span></span><span class="token class-name">MinioClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span></span><span class="token class-name">UploadObjectArgs</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span>errors<span class="token punctuation">.</span></span><span class="token class-name">MinioException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">InvalidKeyException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">NoSuchAlgorithmException</span></span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileUploader</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidKeyException</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// Create a minioClient with the MinIO server playground, its access key and secret key.</span>
      <span class="token class-name">MinioClient</span> minioClient <span class="token operator">=</span>
          <span class="token class-name">MinioClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">endpoint</span><span class="token punctuation">(</span><span class="token string">&quot;https://play.min.io&quot;</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">credentials</span><span class="token punctuation">(</span><span class="token string">&quot;Q3AM3UQ867SPQQA43P2F&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;zuf+tfteSlswRu7BJ86wekitnifILbZam1KYY3TG&quot;</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Make 'asiatrip' bucket if not exist.</span>
      <span class="token keyword">boolean</span> found <span class="token operator">=</span>
          minioClient<span class="token punctuation">.</span><span class="token function">bucketExists</span><span class="token punctuation">(</span><span class="token class-name">BucketExistsArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">&quot;asiatrip&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>found<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Make a new bucket called 'asiatrip'.</span>
        minioClient<span class="token punctuation">.</span><span class="token function">makeBucket</span><span class="token punctuation">(</span><span class="token class-name">MakeBucketArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">&quot;asiatrip&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Bucket 'asiatrip' already exists.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Upload '/home/user/Photos/asiaphotos.zip' as object name 'asiaphotos-2015.zip' to bucket</span>
      <span class="token comment">// 'asiatrip'.</span>
      minioClient<span class="token punctuation">.</span><span class="token function">uploadObject</span><span class="token punctuation">(</span>
          <span class="token class-name">UploadObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">&quot;asiatrip&quot;</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token string">&quot;asiaphotos-2015.zip&quot;</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">filename</span><span class="token punctuation">(</span><span class="token string">&quot;/home/user/Photos/asiaphotos.zip&quot;</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>
          <span class="token string">&quot;'/home/user/Photos/asiaphotos.zip' is successfully uploaded as &quot;</span>
              <span class="token operator">+</span> <span class="token string">&quot;object 'asiaphotos-2015.zip' to bucket 'asiatrip'.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MinioException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Error occurred: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;HTTP trace: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">httpTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>参考示例在media-service工程中 测试上传文件功能，</p> <p>首先创建一个用于测试的bucket</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151616199.png" alt="image-20250115161633150"></p> <p>点击“Manage”修改bucket的访问权限</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151616327.png" alt="image-20250115161643286"></p> <p>选择public权限</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151616013.png" alt="image-20250115161652972"></p> <p>测试代码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span></span><span class="token class-name">BucketExistsArgs</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span></span><span class="token class-name">MakeBucketArgs</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span></span><span class="token class-name">MinioClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span></span><span class="token class-name">UploadObjectArgs</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span>errors<span class="token punctuation">.</span></span><span class="token class-name">MinioException</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">InvalidKeyException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">NoSuchAlgorithmException</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @description 测试MinIO
 * @author Mr.M
 * @date 2022/9/11 21:24
 * @version 1.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MinIOTest</span> <span class="token punctuation">{</span>

 <span class="token keyword">static</span> <span class="token class-name">MinioClient</span> minioClient <span class="token operator">=</span>
         <span class="token class-name">MinioClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span><span class="token function">endpoint</span><span class="token punctuation">(</span><span class="token string">&quot;http://192.168.101.65:9000&quot;</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span><span class="token function">credentials</span><span class="token punctuation">(</span><span class="token string">&quot;minioadmin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;minioadmin&quot;</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


 <span class="token comment">//上传文件</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidKeyException</span> <span class="token punctuation">{</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">boolean</span> found <span class="token operator">=</span>
          minioClient<span class="token punctuation">.</span><span class="token function">bucketExists</span><span class="token punctuation">(</span><span class="token class-name">BucketExistsArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">&quot;testbucket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//检查testbucket桶是否创建，没有创建自动创建</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>found<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   minioClient<span class="token punctuation">.</span><span class="token function">makeBucket</span><span class="token punctuation">(</span><span class="token class-name">MakeBucketArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">&quot;testbucket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Bucket 'testbucket' already exists.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//上传1.mp4</span>
  minioClient<span class="token punctuation">.</span><span class="token function">uploadObject</span><span class="token punctuation">(</span>
          <span class="token class-name">UploadObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">&quot;testbucket&quot;</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token string">&quot;1.mp4&quot;</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">filename</span><span class="token punctuation">(</span><span class="token string">&quot;D:\\develop\\upload\\1.mp4&quot;</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//上传1.avi,上传到avi子目录</span>
  minioClient<span class="token punctuation">.</span><span class="token function">uploadObject</span><span class="token punctuation">(</span>
          <span class="token class-name">UploadObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span><span class="token string">&quot;testbucket&quot;</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token string">&quot;avi/1.avi&quot;</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">filename</span><span class="token punctuation">(</span><span class="token string">&quot;D:\\develop\\upload\\1.avi&quot;</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;上传成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MinioException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Error occurred: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;HTTP trace: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">httpTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidKeyException</span> <span class="token punctuation">{</span>
 <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><p>执行main方法，共上传两个文件，1.mp4上传到桶根目录下，1.avi上传到 桶中的avi目录下，avi目录会自动创建。</p> <p>上传成功，通过web控制台查看文件，并预览文件。</p> <h4 id="_3-2-5-2-删除文件"><a href="#_3-2-5-2-删除文件" class="header-anchor">#</a> 3.2.5.2 删除文件</h4> <p>下边测试删除文件</p> <p>参考：https://docs.min.io/docs/java-client-api-reference#removeObject</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//删除文件</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">String</span> bucket<span class="token punctuation">,</span><span class="token class-name">String</span> filepath<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidKeyException</span> <span class="token punctuation">{</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>

  minioClient<span class="token punctuation">.</span><span class="token function">removeObject</span><span class="token punctuation">(</span>
          <span class="token class-name">RemoveObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;删除成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MinioException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Error occurred: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;HTTP trace: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">httpTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

 <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidKeyException</span> <span class="token punctuation">{</span>
<span class="token comment">//  upload();</span>
  <span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;testbucket&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;1.mp4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;testbucket&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;avi/1.avi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h4 id="_3-2-5-3-查询文件"><a href="#_3-2-5-3-查询文件" class="header-anchor">#</a> 3.2.5.3 查询文件</h4> <p>通过查询文件查看文件是否存在minio中。</p> <p>参考：https://docs.min.io/docs/java-client-api-reference#getObject</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//下载文件</span>
 <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">getFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> bucket<span class="token punctuation">,</span><span class="token class-name">String</span> filepath<span class="token punctuation">,</span><span class="token class-name">String</span> outFile<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidKeyException</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>


   <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">InputStream</span> stream <span class="token operator">=</span> minioClient<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>
           <span class="token class-name">GetObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span>
                   <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FileOutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>outFile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// Read data from stream</span>
    <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span>fileOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;下载成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MinioException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Error occurred: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;HTTP trace: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">httpTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

 <span class="token punctuation">}</span>


 <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidKeyException</span> <span class="token punctuation">{</span>
  <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//  delete(&quot;testbucket&quot;,&quot;1.mp4&quot;);</span>
<span class="token comment">//  delete(&quot;testbucket&quot;,&quot;avi/1.avi&quot;);</span>
  <span class="token function">getFile</span><span class="token punctuation">(</span><span class="token string">&quot;testbucket&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;avi/1.avi&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;D:\\develop\\minio_data\\1.avi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h1 id="_4-上传图片"><a href="#_4-上传图片" class="header-anchor">#</a> 4 上传图片</h1> <h2 id="_4-1-需求分析"><a href="#_4-1-需求分析" class="header-anchor">#</a> 4.1 需求分析</h2> <h3 id="_4-1-1-业务流程"><a href="#_4-1-1-业务流程" class="header-anchor">#</a> 4.1.1 业务流程</h3> <p>课程图片是宣传课程非常重要的信息，在新增课程界面上传课程图片，也可以修改课程图片。</p> <p>如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151620882.png" alt="image-20250115162012832"></p> <p>课程图片上传至分布式文件系统，在课程信息中保存课程图片路径，如下流程：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151620737.png" alt="image-20250115162028695"></p> <p>1、前端进入上传图片界面</p> <p>2、上传图片，请求媒资管理服务。</p> <p>3、媒资管理服务将图片文件存储在MinIO。</p> <p>4、媒资管理记录文件信息到数据库。</p> <p>5、保存课程信息，在内容管理数据库保存图片地址。</p> <p>媒资管理服务由接口层和业务层共同完成，具体分工如下：</p> <p>用户上传图片请求至媒资管理的接口层，接口层解析文件信息通过业务层将文件保存至minio及数据库。如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151620053.png" alt="image-20250115162055013"></p> <h3 id="_4-1-2-数据模型"><a href="#_4-1-2-数据模型" class="header-anchor">#</a> 4.1.2 数据模型</h3> <p>涉及到的数据表有：课程信息表中的图片字段、媒资数据库的文件表，下边主要看媒资数据库的文件表。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151621855.png" alt="image-20250115162120796"></p> <p>各字段描述如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151621672.png" alt="image-20250115162129636"></p> <h3 id="_4-2-准备环境"><a href="#_4-2-准备环境" class="header-anchor">#</a> 4.2 准备环境</h3> <p>首先在minio配置bucket，bucket名称为：mediafiles，并设置bucket的权限为公开。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151621442.png" alt="image-20250115162152400"></p> <p>在nacos配置中minio的相关信息，进入media-service-dev.yaml:</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151622178.png" alt="image-20250115162206143"></p> <p>配置信息如下：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">minio</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//192.168.101.65<span class="token punctuation">:</span><span class="token number">9000</span>
  <span class="token key atrule">accessKey</span><span class="token punctuation">:</span> minioadmin
  <span class="token key atrule">secretKey</span><span class="token punctuation">:</span> minioadmin
  <span class="token key atrule">bucket</span><span class="token punctuation">:</span>
    <span class="token key atrule">files</span><span class="token punctuation">:</span> mediafiles
    <span class="token key atrule">videofiles</span><span class="token punctuation">:</span> video
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>在media-service工程编写minio的配置类：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span></span><span class="token class-name">MinioClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @description minio配置
 * @author Mr.M
 * @date 2022/9/12 19:32
 * @version 1.0
 */</span>
 <span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MinioConfig</span> <span class="token punctuation">{</span>


 <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${minio.endpoint}&quot;</span><span class="token punctuation">)</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> endpoint<span class="token punctuation">;</span>
 <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${minio.accessKey}&quot;</span><span class="token punctuation">)</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> accessKey<span class="token punctuation">;</span>
 <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${minio.secretKey}&quot;</span><span class="token punctuation">)</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> secretKey<span class="token punctuation">;</span>

 <span class="token annotation punctuation">@Bean</span>
 <span class="token keyword">public</span> <span class="token class-name">MinioClient</span> <span class="token function">minioClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token class-name">MinioClient</span> minioClient <span class="token operator">=</span>
          <span class="token class-name">MinioClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">endpoint</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">credentials</span><span class="token punctuation">(</span>accessKey<span class="token punctuation">,</span> secretKey<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> minioClient<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h2 id="_4-3-接口定义"><a href="#_4-3-接口定义" class="header-anchor">#</a> 4.3 接口定义</h2> <p>根据需求分析，下边进行接口定义，此接口定义为一个通用的上传文件接口，可以上传图片或其它文件。</p> <p>首先分析接口：</p> <p>请求地址：/media/upload/coursefile</p> <p>请求参数：</p> <p><strong>Content-Type:</strong> multipart/form-data;boundary=.....</p> <p>FormData:  <strong>filedata=?? Folder=? objectName=?</strong></p> <p>响应参数：文件信息，如下</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;a16da7a132559daf9e1193166b3e7f52&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;companyId&quot;</span><span class="token operator">:</span> <span class="token number">1232141425</span><span class="token punctuation">,</span>
  <span class="token property">&quot;companyName&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">&quot;filename&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.jpg&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;fileType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;001001&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;bucket&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/testbucket/2022/09/12/a16da7a132559daf9e1193166b3e7f52.jpg&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;fileId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;a16da7a132559daf9e1193166b3e7f52&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/testbucket/2022/09/12/a16da7a132559daf9e1193166b3e7f52.jpg&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;timelength&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">&quot;createDate&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2022-09-12T21:57:18&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;changeDate&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;remark&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;auditStatus&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">&quot;auditMind&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">&quot;fileSize&quot;</span><span class="token operator">:</span> <span class="token number">248329</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>定义上传响应模型类：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MediaFiles</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">ToString</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @description 上传普通文件成功响应结果
 * @author Mr.M
 * @date 2022/9/12 18:49
 * @version 1.0
 */</span>
 <span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UploadFileResultDto</span> <span class="token keyword">extends</span> <span class="token class-name">MediaFiles</span> <span class="token punctuation">{</span>
  

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>定义接口如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;上传文件&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/upload/coursefile&quot;</span><span class="token punctuation">,</span>consumes <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">MULTIPART_FORM_DATA_VALUE</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">UploadFileResultDto</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestPart</span><span class="token punctuation">(</span><span class="token string">&quot;filedata&quot;</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> upload<span class="token punctuation">,</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;folder&quot;</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> folder<span class="token punctuation">,</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;objectName&quot;</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="_4-4-接口开发"><a href="#_4-4-接口开发" class="header-anchor">#</a> 4.4 接口开发</h2> <h3 id="_4-4-1-dao开发"><a href="#_4-4-1-dao开发" class="header-anchor">#</a> 4.4.1 DAO开发</h3> <p>根据需求分析DAO层实现向media_files表插入一条记录，使用media_files表生成的mapper即可。</p> <h3 id="_4-4-2-service开发"><a href="#_4-4-2-service开发" class="header-anchor">#</a> 4.4.2 Service开发</h3> <p>Service方法需要提供一个更加通用的保存文件的方法。</p> <p>定义请求参数类：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MediaFiles</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">ToString</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @description 上传普通文件请求参数
 * @author Mr.M
 * @date 2022/9/12 18:49
 * @version 1.0
 */</span>
 <span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UploadFileParamsDto</span> <span class="token punctuation">{</span>

 <span class="token comment">/**
  * 文件名称
  */</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> filename<span class="token punctuation">;</span>

 <span class="token comment">/**
  * 文件content-type
 */</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> contentType<span class="token punctuation">;</span>

 <span class="token comment">/**
  * 文件类型（文档，音频，视频）
  */</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> fileType<span class="token punctuation">;</span>
 <span class="token comment">/**
  * 文件大小
  */</span>
 <span class="token keyword">private</span> <span class="token class-name">Long</span> fileSize<span class="token punctuation">;</span>

 <span class="token comment">/**
  * 标签
  */</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> tags<span class="token punctuation">;</span>

 <span class="token comment">/**
  * 上传人
  */</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>

 <span class="token comment">/**
  * 备注
  */</span>
 <span class="token keyword">private</span> <span class="token class-name">String</span> remark<span class="token punctuation">;</span>



<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>定义service方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @description 上传文件
 * @param uploadFileParamsDto  上传文件信息
 * @param folder  文件目录,如果不传则默认年、月、日
 * @return com.xuecheng.media.model.dto.UploadFileResultDto 上传文件结果
 * @author Mr.M
 * @date 2022/9/12 19:31
*/</span>
<span class="token keyword">public</span> <span class="token class-name">UploadFileResultDto</span> <span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span><span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto<span class="token punctuation">,</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">,</span><span class="token class-name">String</span> folder<span class="token punctuation">,</span><span class="token class-name">String</span> objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>实现方法如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">MinioClient</span> minioClient<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">MediaFilesMapper</span> mediaFilesMapper<span class="token punctuation">;</span>

<span class="token comment">//普通文件桶</span>
<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${minio.bucket.files}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> bucket_Files<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">UploadFileResultDto</span> <span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span> <span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">,</span> <span class="token class-name">String</span> folder<span class="token punctuation">,</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//生成文件id，文件的md5值</span>
    <span class="token class-name">String</span> fileId <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件名称</span>
    <span class="token class-name">String</span> filename <span class="token operator">=</span> uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//构造objectname</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>objectName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        objectName <span class="token operator">=</span> fileId <span class="token operator">+</span> filename<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>filename<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>folder<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//通过日期构造文件存储路径</span>
        folder <span class="token operator">=</span> <span class="token function">getFileFolder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>folder<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        folder <span class="token operator">=</span> folder <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//对象名称</span>
    objectName <span class="token operator">=</span> folder <span class="token operator">+</span> objectName<span class="token punctuation">;</span>
    <span class="token class-name">MediaFiles</span> mediaFiles <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//转为流</span>
        <span class="token class-name">ByteArrayInputStream</span> byteArrayInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">PutObjectArgs</span> putObjectArgs <span class="token operator">=</span> <span class="token class-name">PutObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span>bucket_Files<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>objectName<span class="token punctuation">)</span>
                <span class="token comment">//-1表示文件分片按5M(不小于5M,不大于5T),分片数量最大10000，</span>
                <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>byteArrayInputStream<span class="token punctuation">,</span> byteArrayInputStream<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">contentType</span><span class="token punctuation">(</span>uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">getContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        minioClient<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>putObjectArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//从数据库查询文件</span>
        mediaFiles <span class="token operator">=</span> mediaFilesMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>fileId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mediaFiles <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mediaFiles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//拷贝基本信息</span>
            <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>uploadFileParamsDto<span class="token punctuation">,</span> mediaFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mediaFiles<span class="token punctuation">.</span><span class="token function">setFileId</span><span class="token punctuation">(</span>fileId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mediaFiles<span class="token punctuation">.</span><span class="token function">setCompanyId</span><span class="token punctuation">(</span>companyId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mediaFiles<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> bucket_Files <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mediaFiles<span class="token punctuation">.</span><span class="token function">setBucket</span><span class="token punctuation">(</span>bucket_Files<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mediaFiles<span class="token punctuation">.</span><span class="token function">setCreateDate</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mediaFiles<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//保存文件信息到文件表</span>
            <span class="token keyword">int</span> insert <span class="token operator">=</span> mediaFilesMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>mediaFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>insert <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;保存文件信息失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">UploadFileResultDto</span> uploadFileResultDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UploadFileResultDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>mediaFiles<span class="token punctuation">,</span> uploadFileResultDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> uploadFileResultDto<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;上传过程中出错&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//根据日期拼接目录</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getFileFolder</span><span class="token punctuation">(</span><span class="token class-name">Date</span> date<span class="token punctuation">,</span> <span class="token keyword">boolean</span> year<span class="token punctuation">,</span> <span class="token keyword">boolean</span> month<span class="token punctuation">,</span> <span class="token keyword">boolean</span> day<span class="token punctuation">)</span><span class="token punctuation">{</span>
 <span class="token class-name">SimpleDateFormat</span> sdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//获取当前日期字符串</span>
 <span class="token class-name">String</span> dateString <span class="token operator">=</span> sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//取出年、月、日</span>
 <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dateStringArray <span class="token operator">=</span> dateString<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">StringBuffer</span> folderString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>year<span class="token punctuation">)</span><span class="token punctuation">{</span>
  folderString<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>dateStringArray<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  folderString<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>month<span class="token punctuation">)</span><span class="token punctuation">{</span>
  folderString<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>dateStringArray<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  folderString<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>day<span class="token punctuation">)</span><span class="token punctuation">{</span>
  folderString<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>dateStringArray<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  folderString<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> folderString<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br></div></div><h3 id="_4-4-3-完善接口层"><a href="#_4-4-3-完善接口层" class="header-anchor">#</a> 4.4.3 完善接口层</h3> <p>完善接口层代码 ：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;上传文件&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/upload/coursefile&quot;</span><span class="token punctuation">,</span>consumes <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">MULTIPART_FORM_DATA_VALUE</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">UploadFileResultDto</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestPart</span><span class="token punctuation">(</span><span class="token string">&quot;filedata&quot;</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> upload<span class="token punctuation">,</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;folder&quot;</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> folder<span class="token punctuation">,</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;objectName&quot;</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

    <span class="token class-name">String</span> contentType <span class="token operator">=</span> upload<span class="token punctuation">.</span><span class="token function">getContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> companyId <span class="token operator">=</span> <span class="token number">1232141425L</span><span class="token punctuation">;</span>
        <span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UploadFileParamsDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setFileSize</span><span class="token punctuation">(</span>upload<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>contentType<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;image&quot;</span><span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//图片</span>
            uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setFileType</span><span class="token punctuation">(</span><span class="token string">&quot;001001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token comment">//其它</span>
            uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setFileType</span><span class="token punctuation">(</span><span class="token string">&quot;001003&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setFilename</span><span class="token punctuation">(</span>upload<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span>contentType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> mediaFileService<span class="token punctuation">.</span><span class="token function">uploadFile</span><span class="token punctuation">(</span>companyId<span class="token punctuation">,</span>uploadFileParamsDto<span class="token punctuation">,</span>upload<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>folder<span class="token punctuation">,</span>objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>使用httpclient测试</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>### 上传文件
<span class="token constant">POST</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>media_host<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">/</span>media<span class="token operator">/</span>upload<span class="token operator">/</span>coursefile
<span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span><span class="token operator">:</span> multipart<span class="token operator">/</span>form<span class="token operator">-</span>data<span class="token punctuation">;</span> boundary<span class="token operator">=</span><span class="token class-name">WebAppBoundary</span>

<span class="token operator">--</span><span class="token class-name">WebAppBoundary</span>
<span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Disposition</span><span class="token operator">:</span> form<span class="token operator">-</span>data<span class="token punctuation">;</span> name<span class="token operator">=</span><span class="token string">&quot;filedata&quot;</span><span class="token punctuation">;</span> filename<span class="token operator">=</span><span class="token string">&quot;1.jpg&quot;</span>
<span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span><span class="token operator">:</span> application<span class="token operator">/</span>octet<span class="token operator">-</span>stream

<span class="token operator">&lt;</span> d<span class="token operator">:</span><span class="token operator">/</span>develop<span class="token operator">/</span>upload<span class="token operator">/</span><span class="token number">1.</span>jpg
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_4-4-4-service代码优化"><a href="#_4-4-4-service代码优化" class="header-anchor">#</a> 4.4.4 Service代码优化</h3> <p>在上传文件的方法中包括两部分：向MinIO存储文件，向数据库存储文件信息，下边将这两部分抽取出来，后期可供其它Service方法调用。</p> <ol><li>根据扩展名得到content-type</li></ol> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.j256.simplemagic<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>simplemagic<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.17<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>可通过如下代码得到资源的媒体类型</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>ContentInfo extensionMatch = ContentInfoUtil.findExtensionMatch(扩展名);
String contentType = extensionMatch.getMimeType();
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">UploadFileResultDto</span> <span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span> <span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">,</span> <span class="token class-name">String</span> folder<span class="token punctuation">,</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//生成文件id，文件的md5值</span>
    <span class="token class-name">String</span> fileId <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//文件名称</span>
    <span class="token class-name">String</span> filename <span class="token operator">=</span> uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//构造objectname</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>objectName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        objectName <span class="token operator">=</span> fileId <span class="token operator">+</span> filename<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>filename<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>folder<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//通过日期构造文件存储路径</span>
        folder <span class="token operator">=</span> <span class="token function">getFileFolder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>folder<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        folder <span class="token operator">=</span> folder <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//对象名称</span>
    objectName <span class="token operator">=</span> folder <span class="token operator">+</span> objectName<span class="token punctuation">;</span>
    <span class="token class-name">MediaFiles</span> mediaFiles <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//上传至文件系统</span>
        <span class="token function">addMediaFilesToMinIO</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span>bucket_Files<span class="token punctuation">,</span>objectName<span class="token punctuation">,</span>uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">getContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//写入文件表</span>
        mediaFiles <span class="token operator">=</span> <span class="token function">addMediaFilesToDb</span><span class="token punctuation">(</span>companyId<span class="token punctuation">,</span>fileId<span class="token punctuation">,</span>uploadFileParamsDto<span class="token punctuation">,</span>bucket_Files<span class="token punctuation">,</span>objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UploadFileResultDto</span> uploadFileResultDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UploadFileResultDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>mediaFiles<span class="token punctuation">,</span> uploadFileResultDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> uploadFileResultDto<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;上传过程中出错&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token comment">/**
 * @description 将文件写入minIO
 * @param bytes  文件字节数组
 * @param bucket  桶
 * @param objectName 对象名称
 * @param contentType  内容类型
 * @return void
 * @author Mr.M
 * @date 2022/10/12 21:22
*/</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addMediaFilesToMinIO</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">,</span> <span class="token class-name">String</span> bucket<span class="token punctuation">,</span> <span class="token class-name">String</span> objectName<span class="token punctuation">,</span> <span class="token class-name">String</span> contentType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//转为流</span>
    <span class="token class-name">ByteArrayInputStream</span> byteArrayInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">PutObjectArgs</span> putObjectArgs <span class="token operator">=</span> <span class="token class-name">PutObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>objectName<span class="token punctuation">)</span>
                <span class="token comment">//-1表示文件分片按5M(不小于5M,不大于5T),分片数量最大10000，</span>
                <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>byteArrayInputStream<span class="token punctuation">,</span> byteArrayInputStream<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">contentType</span><span class="token punctuation">(</span>contentType<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        minioClient<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>putObjectArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;上传文件到文件系统出错&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * @description 将文件信息添加到文件表
 * @param companyId  机构id
 * @param fileMd5  文件md5值
 * @param uploadFileParamsDto  上传文件的信息
 * @param bucket  桶
 * @param objectName 对象名称
 * @return com.xuecheng.media.model.po.MediaFiles
 * @author Mr.M
 * @date 2022/10/12 21:22
*/</span>
<span class="token keyword">public</span> <span class="token class-name">MediaFiles</span> <span class="token function">addMediaFilesToDb</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span><span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto<span class="token punctuation">,</span><span class="token class-name">String</span> bucket<span class="token punctuation">,</span><span class="token class-name">String</span> objectName<span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token comment">//从数据库查询文件</span>
    <span class="token class-name">MediaFiles</span> mediaFiles <span class="token operator">=</span> mediaFilesMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mediaFiles <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mediaFiles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//拷贝基本信息</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>uploadFileParamsDto<span class="token punctuation">,</span> mediaFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setFileId</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setCompanyId</span><span class="token punctuation">(</span>companyId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> bucket <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setBucket</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setCreateDate</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setAuditStatus</span><span class="token punctuation">(</span><span class="token string">&quot;002003&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//保存文件信息到文件表</span>
        <span class="token keyword">int</span> insert <span class="token operator">=</span> mediaFilesMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>mediaFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>insert <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;保存文件信息失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> mediaFiles<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br></div></div><p>优化后进行测试。</p> <h3 id="_4-4-4-service事务优化"><a href="#_4-4-4-service事务优化" class="header-anchor">#</a> 4.4.4 Service事务优化</h3> <p>上边的service方法优化后并测试通过，现在思考关于uploadFile方法的是否应该开启事务。</p> <p>目前是在uploadFile方法上添加@Transactional，当调用uploadFile方法前会开启数据库事务，如果上传文件过程时间较长那么数据库的事务持续时间就会变长，这样数据库链接释放就慢，最终导致数据库链接不够用。</p> <p>我们只将addMediaFilesToDb方法添加事务控制即可,uploadFile方法上的@Transactional注解去掉。</p> <p>优化后如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token class-name">MediaFiles</span> <span class="token function">addMediaFilesToDb</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span><span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto<span class="token punctuation">,</span><span class="token class-name">String</span> bucket<span class="token punctuation">,</span><span class="token class-name">String</span> objectName<span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token comment">//从数据库查询文件</span>
    <span class="token class-name">MediaFiles</span> mediaFiles <span class="token operator">=</span> mediaFilesMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mediaFiles <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mediaFiles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//拷贝基本信息</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>uploadFileParamsDto<span class="token punctuation">,</span> mediaFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setFileId</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setCompanyId</span><span class="token punctuation">(</span>companyId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> bucket <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setBucket</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setCreateDate</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setAuditStatus</span><span class="token punctuation">(</span><span class="token string">&quot;002003&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//保存文件信息到文件表</span>
        <span class="token keyword">int</span> insert <span class="token operator">=</span> mediaFilesMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>mediaFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>insert <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;保存文件信息失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> mediaFiles<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>我们人为在int insert = mediaFilesMapper.insert(mediaFiles);下边添加一个异常代码int a=1/0;</p> <p>测试是否事务控制。</p> <p>很遗憾，事务控制失败。方法上已经添加了@Transactional注解为什么该方法不能被事务控制呢？</p> <p>如果是在uploadFile方法上添加@Transactional注解就可以控制事务，去掉则不行。</p> <p>现在的问题其实是一个非事务方法调同类一个事务方法，事务无法控制，这是为什么？</p> <p>下边分析原因：</p> <p>如果在uploadFile方法上添加@Transactional注解，代理对象执行此方法前会开启事务，如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151630021.png" alt="image-20250115163006967"></p> <p>如果在uploadFile方法上没有@Transactional注解，代理对象执行此方法前不进行事务控制，如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151630296.png" alt="image-20250115163020244"></p> <p>现在在addMediaFilesToDb方法上添加@Transactional注解，也不会进行事务是因为并不是通过代理对象执行的addMediaFilesToDb方法。为了判断在uploadFile方法中去调用addMediaFilesToDb方法是否是通过代理对象去调用，我们可以打断点跟踪。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151630068.png" alt="image-20250115163033026"></p> <p>我们发现在uploadFile方法中去调用addMediaFilesToDb方法不是通过代理对象去调用。</p> <p>判断这个方法能否被事务控制，两个条件？</p> <ol><li><p>是不是通过代理对象调用的</p></li> <li><p>方法加上@Transactional</p></li></ol> <p>一个没有被事务控制的方法调用了一个加@Transactional被事务控制的方法，是不可能被事务控制的，原因就是调用加@Transacctional方法的对象不是代理对象</p> <p>学习controller中方法一样，将Service代理对象注入，然后调用</p> <p>为什么注入进去就是代理对象？</p> <ol><li><p>对象被容器管理了</p></li> <li><p>AOP拦截已经把所有service都生成代理对象了</p></li></ol> <p>所以注入进去一定是代理对象</p> <p>但是方法是抽取的service方法，已经改成public了</p> <p>想通过接口层去调，需要先把方法抽到接口里，</p> <p>因为是通过接口注入的代理对象</p> <p>如何解决呢？通过代理对象去调用addMediaFilesToDb方法即可解决。</p> <p>在MediaFileService的实现类中注入MediaFileService的代理对象，如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">MediaFileService</span> currentProxy<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>将addMediaFilesToDb方法提成接口。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @description 将文件信息添加到文件表
 * @param companyId  机构id
 * @param fileMd5  文件md5值
 * @param uploadFileParamsDto  上传文件的信息
 * @param bucket  桶
 * @param objectName 对象名称
 * @return com.xuecheng.media.model.po.MediaFiles
 * @author Mr.M
 * @date 2022/10/12 21:22
 */</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token class-name">MediaFiles</span> <span class="token function">addMediaFilesToDb</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span><span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto<span class="token punctuation">,</span><span class="token class-name">String</span> bucket<span class="token punctuation">,</span><span class="token class-name">String</span> objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>调用addMediaFilesToDb方法的代码处改为如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">//写入文件表</span>
    mediaFiles <span class="token operator">=</span> currentProxy<span class="token punctuation">.</span><span class="token function">addMediaFilesToDb</span><span class="token punctuation">(</span>companyId<span class="token punctuation">,</span>fileId<span class="token punctuation">,</span>uploadFileParamsDto<span class="token punctuation">,</span>bucket_Files<span class="token punctuation">,</span>objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>再次测试事务是否可以正常控制。</p> <h2 id="_4-5-接口测试"><a href="#_4-5-接口测试" class="header-anchor">#</a> 4.5 接口测试</h2> <p>1、首先使用httpclient测试</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>### 上传文件
<span class="token constant">POST</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>media_host<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">/</span>media<span class="token operator">/</span>upload<span class="token operator">/</span>coursefile
<span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span><span class="token operator">:</span> multipart<span class="token operator">/</span>form<span class="token operator">-</span>data<span class="token punctuation">;</span> boundary<span class="token operator">=</span><span class="token class-name">WebAppBoundary</span>

<span class="token operator">--</span><span class="token class-name">WebAppBoundary</span>
<span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Disposition</span><span class="token operator">:</span> form<span class="token operator">-</span>data<span class="token punctuation">;</span> name<span class="token operator">=</span><span class="token string">&quot;filedata&quot;</span><span class="token punctuation">;</span> filename<span class="token operator">=</span><span class="token string">&quot;1.jpg&quot;</span>
<span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span><span class="token operator">:</span> application<span class="token operator">/</span>octet<span class="token operator">-</span>stream

<span class="token operator">&lt;</span> d<span class="token operator">:</span><span class="token operator">/</span>develop<span class="token operator">/</span>upload<span class="token operator">/</span><span class="token number">1.</span>jpg
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>2、再进行前后端联调测试</p> <p>在新增课程、编辑课程界面上传图，保存课程信息后再次进入编辑课程界面，查看是否可以正常保存课程图片信息。</p> <p>上图图片完成后，进入媒资管理，查看文件列表中是否有刚刚上传的图片信息。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151632121.png" alt="image-20250115163248062"></p> <h3 id="_4-6-bug修复"><a href="#_4-6-bug修复" class="header-anchor">#</a> 4.6 bug修复</h3> <p>经过测试发现在媒资列表可以查询刚刚上传的图片信息，但是通过查询条件去查询不起作用。</p> <p>请查阅代码修复此bug。</p> <p>不知道怎么修复</p> <h1 id="_5-上传视频"><a href="#_5-上传视频" class="header-anchor">#</a> 5 上传视频</h1> <h2 id="_5-1-需求分析"><a href="#_5-1-需求分析" class="header-anchor">#</a> 5.1 需求分析</h2> <p>1、教学机构人员进入媒资管理列表查询自己上传的媒资文件。</p> <p>点击“媒资管理”</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151633361.png" alt="image-20250115163345309"></p> <p>进入媒资管理列表页面查询本机构上传的媒资文件。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151633110.png" alt="image-20250115163356065"></p> <p>2、教育机构用户在&quot;媒资管理&quot;页面中点击 &quot;上传视频&quot; 按钮。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151634944.png" alt="image-20250115163405901"></p> <p>点击“上传视频”打开上传页面</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151634888.png" alt="image-20250115163415840"></p> <p>3、选择要上传的文件，自动执行文件上传。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151637350.png" alt="image-20250115163718292"></p> <p>4、视频上传成功会自动处理，处理完成可以预览视频。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151637244.png" alt="image-20250115163729195"></p> <h2 id="_5-2-理解断点续传"><a href="#_5-2-理解断点续传" class="header-anchor">#</a> 5.2 理解断点续传</h2> <h3 id="_5-2-1-什么是断点续传"><a href="#_5-2-1-什么是断点续传" class="header-anchor">#</a> 5.2.1 什么是断点续传</h3> <p>通常视频文件都比较大，所以对于媒资系统上传文件的需求要满足大文件的上传要求。http协议本身对上传文件大小没有限制，但是客户的网络环境质量、电脑硬件环境等参差不齐，如果一个大文件快上传完了网断了没有上传完成，需要客户重新上传，用户体验非常差，所以对于大文件上传的要求最基本的是断点续传。</p> <p>什么是断点续传：</p> <p>​    引用百度百科：断点续传指的是在下载或上传时，将下载或上传任务（一个文件或一个压缩包）人为的划分为几个部分，每一个部分采用一个线程进行上传或下载，如果碰到网络故障，可以从已经上传或下载的部分开始继续上传下载未完成的部分，而没有必要从头开始上传下载，断点续传可以提高节省操作时间，提高用户体验性。</p> <p>断点续传流程如下图</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151638082.png" alt="image-20250115163814016"></p> <p>流程如下：</p> <p>1、前端上传前先把文件分成块</p> <p>2、一块一块的上传，上传中断后重新上传，已上传的分块则不用再上传</p> <p>3、各分块上传完成最后在服务端合并文件</p> <h3 id="_5-2-2-分块与合并测试"><a href="#_5-2-2-分块与合并测试" class="header-anchor">#</a> 5.2.2 分块与合并测试</h3> <p>为了更好的理解文件分块上传的原理，下边用java代码测试文件的分块与合并。</p> <p>文件分块的流程如下：</p> <p>1、获取源文件长度</p> <p>2、根据设定的分块文件的大小计算出块数</p> <p>3、从源文件读数据依次向每一个块文件写数据。</p> <p>测试代码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>codec<span class="token punctuation">.</span>digest<span class="token punctuation">.</span></span><span class="token class-name">DigestUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">RandomAccessFile</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author Mr.M
 * @version 1.0
 * @description 大文件处理测试
 * @date 2022/9/13 9:21
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BigFileTest</span> <span class="token punctuation">{</span>


    <span class="token comment">//测试文件分块方法</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testChunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">File</span> sourceFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;d:/develop/bigfile_test/nacos.avi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> chunkPath <span class="token operator">=</span> <span class="token string">&quot;d:/develop/bigfile_test/chunk/&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">File</span> chunkFolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>chunkPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>chunkFolder<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            chunkFolder<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//分块大小</span>
        <span class="token keyword">long</span> chunkSize <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">//分块数量</span>
        <span class="token keyword">long</span> chunkNum <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>sourceFile<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">/</span> chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;分块总数：&quot;</span><span class="token operator">+</span>chunkNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//缓冲区大小</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//使用RandomAccessFile访问文件</span>
        <span class="token class-name">RandomAccessFile</span> raf_read <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>sourceFile<span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//分块</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chunkNum<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//创建分块文件</span>
            <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>chunkPath <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                file<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">boolean</span> newFile <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">createNewFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>newFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//向分块文件中写数据</span>
                <span class="token class-name">RandomAccessFile</span> raf_write <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token string">&quot;rw&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> raf_read<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    raf_write<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> chunkSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                raf_write<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;完成分块&quot;</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
        raf_read<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>


   

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><p>文件合并流程：</p> <p>1、找到要合并的文件并按文件合并的先后进行排序。</p> <p>2、创建合并文件</p> <p>3、依次从合并的文件中读取数据向合并文件写入数</p> <p>文件合并的测试代码 ：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//测试文件合并方法</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMerge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">//块文件目录</span>
        <span class="token class-name">File</span> chunkFolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;d:/develop/bigfile_test/chunk/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//原始文件</span>
        <span class="token class-name">File</span> originalFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;d:/develop/bigfile_test/nacos.avi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//合并文件</span>
        <span class="token class-name">File</span> mergeFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;d:/develop/bigfile_test/nacos01.avi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mergeFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mergeFile<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//创建新的合并文件</span>
        mergeFile<span class="token punctuation">.</span><span class="token function">createNewFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//用于写文件</span>
        <span class="token class-name">RandomAccessFile</span> raf_write <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>mergeFile<span class="token punctuation">,</span> <span class="token string">&quot;rw&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//指针指向文件顶端</span>
        raf_write<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//缓冲区</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//分块列表</span>
        <span class="token class-name">File</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fileArray <span class="token operator">=</span> chunkFolder<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 转成集合，便于排序</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">&gt;</span></span> fileList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>fileArray<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 从小到大排序</span>
        <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>fileList<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compare</span><span class="token punctuation">(</span><span class="token class-name">File</span> o1<span class="token punctuation">,</span> <span class="token class-name">File</span> o2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>o1<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>o2<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//合并文件</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">File</span> chunkFile <span class="token operator">:</span> fileList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">RandomAccessFile</span> raf_read <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>chunkFile<span class="token punctuation">,</span> <span class="token string">&quot;rw&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> raf_read<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                raf_write<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
            raf_read<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        raf_write<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//校验文件</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span>

                <span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>originalFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">FileInputStream</span> mergeFileStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>mergeFile<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//取出原始文件的md5</span>
            <span class="token class-name">String</span> originalMd5 <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>fileInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//取出合并文件的md5进行比较</span>
            <span class="token class-name">String</span> mergeFileMd5 <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>mergeFileStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>originalMd5<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>mergeFileMd5<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;合并文件成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;合并文件失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>


    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><h3 id="_5-2-3-上传视频流程"><a href="#_5-2-3-上传视频流程" class="header-anchor">#</a> 5.2.3 上传视频流程</h3> <p>下图是上传视频的整体流程：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151639223.png" alt="image-20250115163947159"></p> <p>1、前端上传文件前请求媒资接口层检查文件是否存在，如果已经存在则不再上传。</p> <p>2、如果文件在系统不存在前端开始上传，首先对视频文件进行分块</p> <p>3、前端分块进行上传，上传前首先检查分块是否上传，如已上传则不再上传，如果未上传则开始上传分块。</p> <p>4、前端请求媒资管理接口层请求上传分块。</p> <p>5、接口层请求服务层上传分块。</p> <p>6、服务端将分块信息上传到MinIO。</p> <p>7、前端将分块上传完毕请求接口层合并分块。</p> <p>8、接口层请求服务层合并分块。</p> <p>9、服务层根据文件信息找到MinIO中的分块文件，下载到本地临时目录，将所有分块下载完毕后开始合并 。</p> <p>10、合并完成将合并后的文件上传到MinIO。</p> <h2 id="_5-3-接口定义"><a href="#_5-3-接口定义" class="header-anchor">#</a> 5.3 接口定义</h2> <p>根据上传视频流程，定义如下接口。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>api</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>j256<span class="token punctuation">.</span>simplemagic<span class="token punctuation">.</span></span><span class="token class-name">ContentInfo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>j256<span class="token punctuation">.</span>simplemagic<span class="token punctuation">.</span></span><span class="token class-name">ContentInfoUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">RestResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">UploadFileParamsDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">MediaFileService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Api</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">ApiOperation</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>multipart<span class="token punctuation">.</span></span><span class="token class-name">MultipartFile</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author Mr.M
 * @version 1.0
 * @description 大文件上传接口
 * @date 2022/9/6 11:29
 */</span>
<span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;大文件上传接口&quot;</span><span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token string">&quot;大文件上传接口&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BigFilesController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">MediaFileService</span> mediaFileService<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;文件上传前检查文件&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/upload/checkfile&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">checkfile</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;fileMd5&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileMd5
    <span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;分块文件上传前的检测&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/upload/checkchunk&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">checkchunk</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;fileMd5&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span>
                                            <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;chunk&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> chunk<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
       
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;上传分块文件&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/upload/uploadchunk&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RestResponse</span> <span class="token function">uploadchunk</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;file&quot;</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> file<span class="token punctuation">,</span>
                                    <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;fileMd5&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span>
                                    <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;chunk&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> chunk<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;合并文件&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/upload/mergechunks&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RestResponse</span> <span class="token function">mergechunks</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;fileMd5&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span>
                                    <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;fileName&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileName<span class="token punctuation">,</span>
                                    <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;chunkTotal&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> chunkTotal<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        

    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><p>RestResponse 是一个通用的模型类，在base工程定义如下，从课程资料中拷贝RestResponse.java类到base工程下的model包下。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">ToString</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @description 通用结果类型
 * @author Mr.M
 * @date 2022/9/13 14:44
 * @version 1.0
 */</span>

 <span class="token annotation punctuation">@Data</span>
 <span class="token annotation punctuation">@ToString</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

  <span class="token comment">/**
   * 响应编码,0为正常,-1错误
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> code<span class="token punctuation">;</span>

  <span class="token comment">/**
   * 响应提示信息
   */</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> msg<span class="token punctuation">;</span>

  <span class="token comment">/**
   * 响应内容
   */</span>
  <span class="token keyword">private</span> <span class="token class-name">T</span> result<span class="token punctuation">;</span>


  <span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>msg <span class="token operator">=</span> msg<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 错误信息的封装
   *
   * @param msg
   * @param &lt;T&gt;
   * @return
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">validfail</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   response<span class="token punctuation">.</span><span class="token function">setMsg</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>



  <span class="token comment">/**
   * 添加正常响应数据（包含响应内容）
   *
   * @return RestResponse Rest服务封装相应数据
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">success</span><span class="token punctuation">(</span><span class="token class-name">T</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   response<span class="token punctuation">.</span><span class="token function">setResult</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 添加正常响应数据（不包含响应内容）
   *
   * @return RestResponse Rest服务封装相应数据
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">isSuccessful</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br></div></div><h2 id="_5-4-接口开发"><a href="#_5-4-接口开发" class="header-anchor">#</a> 5.4 接口开发</h2> <h3 id="_5-4-1-dao开发"><a href="#_5-4-1-dao开发" class="header-anchor">#</a> 5.4.1 DAO开发</h3> <p>向媒资数据库的文件表插入记录，使用自动生成的Mapper接口即可满足要求。</p> <h3 id="_5-4-2-service开发"><a href="#_5-4-2-service开发" class="header-anchor">#</a> 5.4.2 Service开发</h3> <h4 id="_5-4-2-1-接口定义"><a href="#_5-4-2-1-接口定义" class="header-anchor">#</a> 5.4.2.1 接口定义</h4> <p>首先定义接口，从课程资料中拷贝RestResponse.java类到base工程下的model包下。</p> <p>1、检查文件方法</p> <p>检查文件是否在系统存在</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @description 检查文件是否存在
 * @param fileMd5 文件的md5
 * @return com.xuecheng.base.model.RestResponse&lt;java.lang.Boolean&gt; false不存在，true存在
 * @author Mr.M
 * @date 2022/9/13 15:38
*/</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">checkFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>2、检查分块是否存在</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @description 检查分块是否存在
 * @param fileMd5  文件的md5
 * @param chunkIndex  分块序号
 * @return com.xuecheng.base.model.RestResponse&lt;java.lang.Boolean&gt; false不存在，true存在
 * @author Mr.M
 * @date 2022/9/13 15:39
*/</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">checkChunk</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token keyword">int</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>3、上传分块</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @description 上传分块
 * @param fileMd5  文件md5
 * @param chunk  分块序号
 * @param bytes  文件字节
 * @return com.xuecheng.base.model.RestResponse
 * @author Mr.M
 * @date 2022/9/13 15:50
*/</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span> <span class="token function">uploadChunk</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span><span class="token keyword">int</span> chunk<span class="token punctuation">,</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>4、合并分块</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @description 合并分块
 * @param companyId  机构id
 * @param fileMd5  文件md5
 * @param chunkTotal 分块总和
 * @param uploadFileParamsDto 文件信息
 * @return com.xuecheng.base.model.RestResponse
 * @author Mr.M
 * @date 2022/9/13 15:56
*/</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span> <span class="token function">mergechunks</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span><span class="token keyword">int</span> chunkTotal<span class="token punctuation">,</span><span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="_5-4-2-2-检查文件和分块"><a href="#_5-4-2-2-检查文件和分块" class="header-anchor">#</a> 5.4.2.2 检查文件和分块</h4> <p>接口完成进行接口实现，首先实现检查文件方法和检查分块方法。</p> <p>service接口定义</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @description 检查文件是否存在
 * @param fileMd5 文件的md5
 * @return com.xuecheng.base.model.RestResponse&lt;java.lang.Boolean&gt; false不存在，true存在
 * @author Mr.M
 * @date 2022/9/13 15:38
*/</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">checkFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @description 检查分块是否存在
 * @param fileMd5  文件的md5
 * @param chunkIndex  分块序号
 * @return com.xuecheng.base.model.RestResponse&lt;java.lang.Boolean&gt; false不存在，true存在
 * @author Mr.M
 * @date 2022/9/13 15:39
*/</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">checkChunk</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token keyword">int</span> chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>service接口实现方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">checkFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//查询文件信息</span>
    <span class="token class-name">MediaFiles</span> mediaFiles <span class="token operator">=</span> mediaFilesMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mediaFiles <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//桶</span>
        <span class="token class-name">String</span> bucket <span class="token operator">=</span> mediaFiles<span class="token punctuation">.</span><span class="token function">getBucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//存储目录</span>
        <span class="token class-name">String</span> filePath <span class="token operator">=</span> mediaFiles<span class="token punctuation">.</span><span class="token function">getFilePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//文件流</span>
        <span class="token class-name">InputStream</span> stream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            stream <span class="token operator">=</span> minioClient<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>
                    <span class="token class-name">GetObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>stream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//文件已存在</span>
                <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//文件不存在</span>
    <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>



<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">checkChunk</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token keyword">int</span> chunkIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//得到分块文件目录</span>
    <span class="token class-name">String</span> chunkFileFolderPath <span class="token operator">=</span> <span class="token function">getChunkFileFolderPath</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//得到分块文件的路径</span>
    <span class="token class-name">String</span> chunkFilePath <span class="token operator">=</span> chunkFileFolderPath <span class="token operator">+</span> chunkIndex<span class="token punctuation">;</span>

    <span class="token comment">//文件流</span>
    <span class="token class-name">InputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        fileInputStream <span class="token operator">=</span> minioClient<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>
                <span class="token class-name">GetObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span>bucket_videoFiles<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>chunkFilePath<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>fileInputStream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//分块已存在</span>
            <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
    <span class="token punctuation">}</span>
    <span class="token comment">//分块未存在</span>
    <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//得到分块文件的目录</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getChunkFileFolderPath</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fileMd5<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> fileMd5<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> fileMd5 <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;chunk&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br></div></div><h4 id="_5-4-2-3-上传分块"><a href="#_5-4-2-3-上传分块" class="header-anchor">#</a> 5.4.2.3 上传分块</h4> <p>定义service接口</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @description 上传分块
 * @param fileMd5  文件md5
 * @param chunk  分块序号
 * @param bytes  文件字节
 * @return com.xuecheng.base.model.RestResponse
 * @author Mr.M
 * @date 2022/9/13 15:50
*/</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span> <span class="token function">uploadChunk</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span><span class="token keyword">int</span> chunk<span class="token punctuation">,</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>接口实现：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span> <span class="token function">uploadChunk</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token keyword">int</span> chunk<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>


    <span class="token comment">//得到分块文件的目录路径</span>
    <span class="token class-name">String</span> chunkFileFolderPath <span class="token operator">=</span> <span class="token function">getChunkFileFolderPath</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//得到分块文件的路径</span>
    <span class="token class-name">String</span> chunkFilePath <span class="token operator">=</span> chunkFileFolderPath <span class="token operator">+</span> chunk<span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">//将文件存储至minIO</span>
    <span class="token function">addMediaFilesToMinIO</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> bucket_videoFiles<span class="token punctuation">,</span>chunkFilePath<span class="token punctuation">,</span><span class="token string">&quot;application/octet-stream&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;上传过程出错请重试&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="_5-4-2-4-下载分块"><a href="#_5-4-2-4-下载分块" class="header-anchor">#</a> 5.4.2.4 下载分块</h4> <p>合并分块前要检查分块文件是否全部上传完成，如果完成则将已经上传的分块文件下载下来，然后再进行合并，下边先实现检查及下载所有分块的方法。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//检查所有分块是否上传完毕</span>
<span class="token keyword">private</span> <span class="token class-name">File</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">checkChunkStatus</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token keyword">int</span> chunkTotal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//得到分块文件的目录路径</span>
    <span class="token class-name">String</span> chunkFileFolderPath <span class="token operator">=</span> <span class="token function">getChunkFileFolderPath</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">File</span><span class="token punctuation">[</span><span class="token punctuation">]</span> files <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">[</span>chunkTotal<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//检查分块文件是否上传完毕</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chunkTotal<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> chunkFilePath <span class="token operator">=</span> chunkFileFolderPath <span class="token operator">+</span> i<span class="token punctuation">;</span>
        <span class="token comment">//下载文件</span>
        <span class="token class-name">File</span> chunkFile <span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            chunkFile <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">.</span><span class="token function">createTempFile</span><span class="token punctuation">(</span><span class="token string">&quot;chunk&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;下载分块时创建临时文件出错&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">downloadFileFromMinIO</span><span class="token punctuation">(</span>chunkFile<span class="token punctuation">,</span>bucket_videoFiles<span class="token punctuation">,</span>chunkFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>chunkFile<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> files<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//得到分块文件的目录</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getChunkFileFolderPath</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fileMd5<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> fileMd5<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> fileMd5 <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;chunk&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//根据桶和文件路径从minio下载文件</span>
<span class="token keyword">public</span> <span class="token class-name">File</span> <span class="token function">downloadFileFromMinIO</span><span class="token punctuation">(</span><span class="token class-name">File</span> file<span class="token punctuation">,</span><span class="token class-name">String</span> bucket<span class="token punctuation">,</span><span class="token class-name">String</span> objectName<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">InputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">OutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        fileInputStream <span class="token operator">=</span> minioClient<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>
                <span class="token class-name">GetObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>objectName<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>fileInputStream<span class="token punctuation">,</span> fileOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;下载文件&quot;</span><span class="token operator">+</span>objectName<span class="token operator">+</span><span class="token string">&quot;出错&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;文件不存在&quot;</span><span class="token operator">+</span>objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fileInputStream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                fileInputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fileOutputStream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                fileOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> file<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><h4 id="_5-4-2-5-合并分块"><a href="#_5-4-2-5-合并分块" class="header-anchor">#</a> 5.4.2.5 合并分块</h4> <p>所有分块文件下载成功后开始合并这些分块文件。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span> <span class="token function">mergechunks</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span> <span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token keyword">int</span> chunkTotal<span class="token punctuation">,</span> <span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">String</span> fileName <span class="token operator">=</span> uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//下载所有分块文件</span>
    <span class="token class-name">File</span><span class="token punctuation">[</span><span class="token punctuation">]</span> chunkFiles <span class="token operator">=</span> <span class="token function">checkChunkStatus</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span> chunkTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//扩展名</span>
    <span class="token class-name">String</span> extName <span class="token operator">=</span> fileName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>fileName<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//创建临时文件作为合并文件</span>
    <span class="token class-name">File</span> mergeFile <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        mergeFile <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">.</span><span class="token function">createTempFile</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span> extName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;合并文件过程中创建临时文件出错&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//开始合并</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span><span class="token punctuation">(</span><span class="token class-name">RandomAccessFile</span> raf_write <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>mergeFile<span class="token punctuation">,</span> <span class="token string">&quot;rw&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">File</span> chunkFile <span class="token operator">:</span> chunkFiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">FileInputStream</span> chunkFileStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>chunkFile<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> chunkFileStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">//向合并后的文件写</span>
                        raf_write<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;合并文件过程中出错&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;合并文件完成{}&quot;</span><span class="token punctuation">,</span>mergeFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setFileSize</span><span class="token punctuation">(</span>mergeFile<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">InputStream</span> mergeFileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>mergeFile<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//对文件进行校验，通过比较md5值</span>
            <span class="token class-name">String</span> newFileMd5 <span class="token operator">=</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>mergeFileInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fileMd5<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>newFileMd5<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//校验失败</span>
                <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;合并文件校验失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;合并文件校验通过{}&quot;</span><span class="token punctuation">,</span>mergeFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//校验失败</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;合并文件校验异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//将临时文件上传至minio</span>
        <span class="token class-name">String</span> mergeFilePath <span class="token operator">=</span> <span class="token function">getFilePathByMd5</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span> extName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>

            <span class="token comment">//上传文件到minIO</span>
            <span class="token function">addMediaFilesToMinIO</span><span class="token punctuation">(</span>mergeFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bucket_videoFiles<span class="token punctuation">,</span> mergeFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;合并文件上传MinIO完成{}&quot;</span><span class="token punctuation">,</span>mergeFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;合并文件时上传文件出错&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//入数据库</span>
        <span class="token class-name">MediaFiles</span> mediaFiles <span class="token operator">=</span> <span class="token function">addMediaFilesToDb</span><span class="token punctuation">(</span>companyId<span class="token punctuation">,</span> fileMd5<span class="token punctuation">,</span> uploadFileParamsDto<span class="token punctuation">,</span> bucket_videoFiles<span class="token punctuation">,</span> mergeFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mediaFiles <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;媒资文件入库出错&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">//删除临时文件</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">File</span> file <span class="token operator">:</span> chunkFiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                file<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            mergeFile<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


 <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getFilePathByMd5</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span><span class="token class-name">String</span> fileExt<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span>   fileMd5<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> fileMd5<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> fileMd5 <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span>fileMd5 <span class="token operator">+</span>fileExt<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//将文件上传到minIO，传入文件绝对路径</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addMediaFilesToMinIO</span><span class="token punctuation">(</span><span class="token class-name">String</span> filePath<span class="token punctuation">,</span> <span class="token class-name">String</span> bucket<span class="token punctuation">,</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        minioClient<span class="token punctuation">.</span><span class="token function">uploadObject</span><span class="token punctuation">(</span>
                <span class="token class-name">UploadObjectArgs</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">bucket</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span>objectName<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">filename</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;上传文件到文件系统出错&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br></div></div><h3 id="_5-4-3-接口层完善"><a href="#_5-4-3-接口层完善" class="header-anchor">#</a> 5.4.3 接口层完善</h3> <p>下边完善接口层</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;文件上传前检查文件&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/upload/checkfile&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">checkfile</span><span class="token punctuation">(</span>
        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;fileMd5&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileMd5
<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> mediaFileService<span class="token punctuation">.</span><span class="token function">checkFile</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;分块文件上传前的检测&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/upload/checkchunk&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">checkchunk</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;fileMd5&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span>
                                        <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;chunk&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> chunk<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> mediaFileService<span class="token punctuation">.</span><span class="token function">checkChunk</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;上传分块文件&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/upload/uploadchunk&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span> <span class="token function">uploadchunk</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;file&quot;</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> file<span class="token punctuation">,</span>
                                <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;fileMd5&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span>
                                <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;chunk&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> chunk<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

    <span class="token keyword">return</span> mediaFileService<span class="token punctuation">.</span><span class="token function">uploadChunk</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">,</span>chunk<span class="token punctuation">,</span>file<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;合并文件&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/upload/mergechunks&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span> <span class="token function">mergechunks</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;fileMd5&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span>
                                <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;fileName&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileName<span class="token punctuation">,</span>
                                <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;chunkTotal&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> chunkTotal<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Long</span> companyId <span class="token operator">=</span> <span class="token number">1232141425L</span><span class="token punctuation">;</span>

    <span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UploadFileParamsDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setFileType</span><span class="token punctuation">(</span><span class="token string">&quot;001002&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setTags</span><span class="token punctuation">(</span><span class="token string">&quot;课程视频&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setFilename</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ContentInfo</span> extensionMatch <span class="token operator">=</span> <span class="token class-name">ContentInfoUtil</span><span class="token punctuation">.</span><span class="token function">findExtensionMatch</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> mimeType <span class="token operator">=</span> extensionMatch<span class="token punctuation">.</span><span class="token function">getMimeType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uploadFileParamsDto<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span>mimeType<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> mediaFileService<span class="token punctuation">.</span><span class="token function">mergechunks</span><span class="token punctuation">(</span>companyId<span class="token punctuation">,</span>fileMd5<span class="token punctuation">,</span>chunkTotal<span class="token punctuation">,</span>uploadFileParamsDto<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h2 id="_5-5-接口测试"><a href="#_5-5-接口测试" class="header-anchor">#</a> 5.5 接口测试</h2> <p>如果是单个接口测试使用httpclient</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Java</span>
### 检查文件
<span class="token constant">POST</span><span class="token punctuation">{</span><span class="token punctuation">{</span>media_host<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">/</span>media<span class="token operator">/</span>upload<span class="token operator">/</span>register
<span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span><span class="token operator">:</span> application<span class="token operator">/</span>x<span class="token operator">-</span>www<span class="token operator">-</span>form<span class="token operator">-</span>urlencoded<span class="token punctuation">;</span>

fileMd5<span class="token operator">=</span>c5c75d70f382e6016d2f506d134eee11

### 上传分块前检查
<span class="token constant">POST</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>media_host<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">/</span>media<span class="token operator">/</span>upload<span class="token operator">/</span>checkchunk
<span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span><span class="token operator">:</span> application<span class="token operator">/</span>x<span class="token operator">-</span>www<span class="token operator">-</span>form<span class="token operator">-</span>urlencoded<span class="token punctuation">;</span>

fileMd5<span class="token operator">=</span>c5c75d70f382e6016d2f506d134eee11<span class="token operator">&amp;</span>chunk<span class="token operator">=</span><span class="token number">0</span>

### 上传分块文件
<span class="token constant">POST</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>media_host<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">/</span>media<span class="token operator">/</span>upload<span class="token operator">/</span>uploadchunk<span class="token operator">?</span>fileMd5<span class="token operator">=</span>c5c75d70f382e6016d2f506d134eee11<span class="token operator">&amp;</span>chunk<span class="token operator">=</span><span class="token number">1</span>
<span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span><span class="token operator">:</span> multipart<span class="token operator">/</span>form<span class="token operator">-</span>data<span class="token punctuation">;</span> boundary<span class="token operator">=</span><span class="token class-name">WebAppBoundary</span>

<span class="token operator">--</span><span class="token class-name">WebAppBoundary</span>
<span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Disposition</span><span class="token operator">:</span> form<span class="token operator">-</span>data<span class="token punctuation">;</span> name<span class="token operator">=</span><span class="token string">&quot;file&quot;</span><span class="token punctuation">;</span> filename<span class="token operator">=</span><span class="token string">&quot;1&quot;</span>
<span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span><span class="token operator">:</span> application<span class="token operator">/</span>octet<span class="token operator">-</span>stream

<span class="token operator">&lt;</span> <span class="token class-name">E</span><span class="token operator">:</span><span class="token operator">/</span>ffmpeg_test<span class="token operator">/</span>chunks<span class="token operator">/</span><span class="token number">1</span>



### 合并文件
<span class="token constant">POST</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>media_host<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">/</span>media<span class="token operator">/</span>upload<span class="token operator">/</span>mergechunks
<span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span><span class="token operator">:</span> application<span class="token operator">/</span>x<span class="token operator">-</span>www<span class="token operator">-</span>form<span class="token operator">-</span>urlencoded<span class="token punctuation">;</span>

fileMd5<span class="token operator">=</span>dcb37b85c9c03fc5243e20ab4dfbc1c8<span class="token operator">&amp;</span>fileName<span class="token operator">=</span><span class="token number">8.</span>avi<span class="token operator">&amp;</span>chunkTotal<span class="token operator">=</span><span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>下边介绍采用前后联调：</p> <p>1、首先在每个接口层方法上打开断点</p> <p>在前端上传视频，观察接口层是否收到参数。</p> <p>2、进入service方法逐行跟踪。</p> <p>3、断点续传测试</p> <p>上传一部分后，停止刷新浏览器再重新上传，通过浏览器日志发现已经上传过的分块不再重新上传</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151649427.png" alt="image-20250115164942359"></p> <h1 id="_6-文件预览"><a href="#_6-文件预览" class="header-anchor">#</a> 6 文件预览</h1> <h2 id="_6-1-需求分析"><a href="#_6-1-需求分析" class="header-anchor">#</a> 6.1 需求分析</h2> <p>图片上传成功、视频上传成功可以通过预览功能查看文件的内容。</p> <p>预览的方式是通过浏览器直接打文件，对于图片和浏览器支持的视频格式的视频文件可以直接预览。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151650195.png" alt="image-20250115165018124"></p> <p>业务流程如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151650185.png" alt="image-20250115165028128"></p> <p>说明如下：</p> <p>1、前端请求接口层预览文件</p> <p>2、接口层将文件id传递给服务层</p> <p>3、服务层使用文件id查询媒资数据库文件表，获取文件的url</p> <p>4、接口层将文件url返回给前端，通过浏览器打开URL。</p> <h2 id="_6-2-接口定义"><a href="#_6-2-接口定义" class="header-anchor">#</a> 6.2 接口定义</h2> <p>根据需求分析定义接口如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code> <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;预览文件&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/preview/{mediaId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPlayUrlByMediaId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> mediaId<span class="token punctuation">)</span><span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="_6-3-接口开发"><a href="#_6-3-接口开发" class="header-anchor">#</a> 6.3 接口开发</h2> <h3 id="_6-3-1-dao开发"><a href="#_6-3-1-dao开发" class="header-anchor">#</a> 6.3.1 DAO开发</h3> <p>使用自动生成的MediaFiels表的Mapper接口。</p> <h3 id="_6-3-2-service开发"><a href="#_6-3-2-service开发" class="header-anchor">#</a> 6.3.2 Service开发</h3> <p>定义根据id查询媒资文件接口</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @description 根据id查询文件信息
 * @param id  文件id
 * @return com.xuecheng.media.model.po.MediaFiles 文件信息
 * @author Mr.M
 * @date 2022/9/13 17:47
*/</span>
<span class="token keyword">public</span> <span class="token class-name">MediaFiles</span> <span class="token function">getFileById</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>方法实现：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">MediaFiles</span> <span class="token function">getFileById</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> mediaFilesMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_6-3-3-接口层完善"><a href="#_6-3-3-接口层完善" class="header-anchor">#</a> 6.3.3 接口层完善</h3> <p>对接口层完善：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;预览文件&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/preview/{mediaId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">RestResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPlayUrlByMediaId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> mediaId<span class="token punctuation">)</span><span class="token punctuation">{</span>


    <span class="token class-name">MediaFiles</span> mediaFiles <span class="token operator">=</span> mediaFileService<span class="token punctuation">.</span><span class="token function">getFileById</span><span class="token punctuation">(</span>mediaId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>mediaFiles <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>mediaFiles<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;视频还没有转码处理&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">RestResponse</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>mediaFiles<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_6-3-4-接口测试"><a href="#_6-3-4-接口测试" class="header-anchor">#</a> 6.3.4 接口测试</h3> <p>使用前后端联调。</p> <p>上传mp4视频文件，预览文件。</p> <p>上传图片文件，预览文件。</p> <p>对于无法预览的视频文件，稍后通过视频处理对视频转码。</p> <h1 id="_7-视频处理"><a href="#_7-视频处理" class="header-anchor">#</a> 7 视频处理</h1> <h2 id="_7-1-视频编码技术"><a href="#_7-1-视频编码技术" class="header-anchor">#</a> 7.1 视频编码技术</h2> <h3 id="_7-1-1-什么是视频编码"><a href="#_7-1-1-什么是视频编码" class="header-anchor">#</a> 7.1.1 什么是视频编码</h3> <p>视频上传成功后需要对视频进行转码处理。</p> <p>什么是视频编码？查阅百度百科如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151654236.png" alt="image-20250115165436166"></p> <p>详情参考 ：<a href="https://baike.baidu.com/item/%E8%A7%86%E9%A2%91%E7%BC%96%E7%A0%81/839038" target="_blank" rel="noopener noreferrer">https://baike.baidu.com/item/%E8%A7%86%E9%A2%91%E7%BC%96%E7%A0%81/839038<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>首先我们要分清文件格式和编码格式：</p> <p>文件格式：是指.mp4、.avi、.rmvb等 这些不同扩展名的视频文件的文件格式 ，视频文件的内容主要包括视频和音频，其文件格式是按照一 定的编码格式去编码，并且按照该文件所规定的封装格式将视频、音频、字幕等信息封装在一起，播放器会根据它们的封装格式去提取出编码，然后由播放器解码，最终播放音视频。</p> <p>音视频编码格式：通过音视频的压缩技术，将视频格式转换成另一种视频格式，通过视频编码实现流媒体的传输。比如：一个.avi的视频文件原来的编码是a，通过编码后编码格式变为b，音频原来为c，通过编码后变为d。</p> <p>音视频编码格式各类繁多，主要有几下几类：</p> <p>MPEG系列</p> <p>（由ISO[国际标准组织机构]下属的MPEG[运动图象专家组]开发 ）视频编码方面主要是Mpeg1（vcd用的就是它）、Mpeg2（DVD使用）、Mpeg4（的DVDRIP使用的都是它的变种，如：divx，xvid等）、Mpeg4 AVC（正热门）；音频编码方面主要是MPEG Audio Layer 1/2、MPEG Audio Layer 3（大名鼎鼎的mp3）、MPEG-2 AAC 、MPEG-4 AAC等等。注意：DVD音频没有采用Mpeg的。</p> <p>H.26X系列</p> <p>（由ITU[国际电传视讯联盟]主导，侧重网络传输，注意：只是视频编码）</p> <p>包括H.261、H.262、H.263、H.263+、H.263++、H.264（就是MPEG4 AVC-合作的结晶）</p> <p>目前最常用的编码标准是视频H.264，音频AAC。</p> <p>提问：</p> <p>H.264是编码格式还是文件格式？</p> <p>mp4是编码格式还是文件格式？</p> <h3 id="_7-1-2-ffmpeg的基本使用"><a href="#_7-1-2-ffmpeg的基本使用" class="header-anchor">#</a> 7.1.2 FFmpeg的基本使用</h3> <p>我们将视频录制完成后，使用视频编码软件对视频进行编码，本项目 使用FFmpeg对视频进行编码 。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151655660.png" alt="image-20250115165536585"></p> <p>FFmpeg被许多开源项目采用，QQ影音、暴风影音、VLC等。</p> <p>下载：FFmpeg https://www.ffmpeg.org/download.html#build-windows</p> <p>请从课程资料目录解压ffmpeg.zip,并将解压得到的exe文件加入环境变量。</p> <p>测试是否正常：cmd运行 ffmpeg -v</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151655959.png" alt="image-20250115165548888"></p> <p>安装成功，作下简单测试</p> <p>将一个.avi文件转成mp4、mp3、gif等。</p> <p>比如我们将nacos.avi文件转成mp4，运行如下命令：</p> <p>ffmpeg -i nacos.avi nacos.mp4</p> <p>转成mp3：ffmpeg -i nacos.avi nacos.mp3</p> <p>转成gif：ffmpeg -i nacos.avi nacos.gif</p> <p>官方文档（英文）：http://ffmpeg.org/ffmpeg.html</p> <h2 id="_7-2-分布式任务处理"><a href="#_7-2-分布式任务处理" class="header-anchor">#</a> 7.2 分布式任务处理</h2> <h3 id="_7-2-1-什么是分布式任务调度"><a href="#_7-2-1-什么是分布式任务调度" class="header-anchor">#</a> 7.2.1 什么是分布式任务调度</h3> <p>了解了视频编码的相关知识，如何用Java程序对视频进行处理呢？这里有一个关键的需求就是当视频比较多的时候我们程序可以高效处理。</p> <p>如何去高效处理一批任务呢？</p> <p>1、多线程</p> <p>多线程是充分利用单机的资源。</p> <p>2、分布式加多线程</p> <p>充分利用多台计算机，每台计算机多线程处理。</p> <p>方案2可扩展性更强。</p> <p>方案2是一种分布式任务调度的处理方案。</p> <p>什么是分布式任务调度？</p> <p>我们可以先思考一下下面业务场景的解决方案：</p> <p>​    某电商系统需要在每天上午10点，下午3点，晚上8点发放一批优惠券。</p> <p>​    某财务系统需要在每天上午10点前结算前一天的账单数据，统计汇总。</p> <p>​    某电商平台每天凌晨3点，要对订单中的无效订单进行清理。</p> <p>​    12306网站会根据车次不同，设置几个时间点分批次放票。</p> <p>​    电商整点抢购，商品价格某天上午8点整开始优惠。</p> <p>​    商品成功发货后，需要向客户发送短信提醒。</p> <p>类似的场景还有很多，我们该如何实现？</p> <p>以上这些场景，就是任务调度所需要解决的问题。</p> <p><strong>任务调度顾名思义，就是对任务的调度，它是指系统为了完成特定业务，基于给定时间点，给定时间间隔或者给定执行次数自动执行任务。</strong></p> <p>如何实现任务调度？</p> <p><strong>多线程方式实现：</strong></p> <p>学过多线程的同学，可能会想到，我们可以开启一个线程，每sleep一段时间，就去检查是否已到预期执行时间。</p> <p>以下代码简单实现了任务调度的功能：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
    <span class="token comment">//任务执行间隔时间</span>
    <span class="token keyword">final</span> <span class="token keyword">long</span> timeInterval <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token class-name">Runnable</span> runnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//TODO：something</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>timeInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>runnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>上面的代码实现了按一定的间隔时间执行任务调度的功能。</p> <p>Jdk也为我们提供了相关支持，如Timer、ScheduledExecutor，下边我们了解下。</p> <p><strong>Timer方式实现</strong>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>  
    <span class="token class-name">Timer</span> timer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    timer<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TimerTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>  
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
           <span class="token comment">//TODO：something</span>
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//1秒后开始调度，每2秒执行一次</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>Timer 的优点在于简单易用，每个Timer对应一个线程，因此可以同时启动多个Timer并行执行多个任务，同一个Timer中的任务是串行执行。</p> <p><strong>ScheduledExecutor方式实现</strong>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> agrs<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">ScheduledExecutorService</span> service <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    service<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//TODO：something</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;todo something&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>Java 5 推出了基于线程池设计的 ScheduledExecutor，其设计思想是，每一个被调度的任务都会由线程池中一个线程去执行，因此任务是并发执行的，相互之间不会受到干扰。</p> <p>Timer 和 ScheduledExecutor 都仅能提供基于开始时间与重复间隔的任务调度，不能胜任更加复杂的调度需求。比如，设置每月第一天凌晨1点执行任务、复杂调度任务的管理、任务间传递数据等等。</p> <p>Quartz 是一个功能强大的任务调度框架，它可以满足更多更复杂的调度需求，Quartz 设计的核心类包括 Scheduler, Job 以及 Trigger。其中，Job 负责定义需要执行的任务，Trigger 负责设置调度策略，Scheduler 将二者组装在一起，并触发任务开始执行。Quartz支持简单的按时间间隔调度、还支持按日历调度方式，通过设置CronTrigger表达式（包括：秒、分、时、日、月、周、年）进行任务调度。</p> <p><strong>第三方Quartz方式实现</strong>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> agrs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SchedulerException</span> <span class="token punctuation">{</span>
    <span class="token comment">//创建一个Scheduler</span>
    <span class="token class-name">SchedulerFactory</span> schedulerFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StdSchedulerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Scheduler</span> scheduler <span class="token operator">=</span> schedulerFactory<span class="token punctuation">.</span><span class="token function">getScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//创建JobDetail</span>
    <span class="token class-name">JobBuilder</span> jobDetailBuilder <span class="token operator">=</span> <span class="token class-name">JobBuilder</span><span class="token punctuation">.</span><span class="token function">newJob</span><span class="token punctuation">(</span><span class="token class-name">MyJob</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    jobDetailBuilder<span class="token punctuation">.</span><span class="token function">withIdentity</span><span class="token punctuation">(</span><span class="token string">&quot;jobName&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;jobGroupName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">JobDetail</span> jobDetail <span class="token operator">=</span> jobDetailBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//创建触发的CronTrigger 支持按日历调度</span>
        <span class="token class-name">CronTrigger</span> trigger <span class="token operator">=</span> <span class="token class-name">TriggerBuilder</span><span class="token punctuation">.</span><span class="token function">newTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withIdentity</span><span class="token punctuation">(</span><span class="token string">&quot;triggerName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;triggerGroupName&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">startNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withSchedule</span><span class="token punctuation">(</span><span class="token class-name">CronScheduleBuilder</span><span class="token punctuation">.</span><span class="token function">cronSchedule</span><span class="token punctuation">(</span><span class="token string">&quot;0/2 * * * * ?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//创建触发的SimpleTrigger 简单的间隔调度</span>
        <span class="token comment">/*SimpleTrigger trigger = TriggerBuilder.newTrigger()
                .withIdentity(&quot;triggerName&quot;,&quot;triggerGroupName&quot;)
                .startNow()
                .withSchedule(SimpleScheduleBuilder
                        .simpleSchedule()
                        .withIntervalInSeconds(2)
                        .repeatForever())
                .build();*/</span>
    scheduler<span class="token punctuation">.</span><span class="token function">scheduleJob</span><span class="token punctuation">(</span>jobDetail<span class="token punctuation">,</span>trigger<span class="token punctuation">)</span><span class="token punctuation">;</span>
    scheduler<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyJob</span> <span class="token keyword">implements</span> <span class="token class-name">Job</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">JobExecutionContext</span> jobExecutionContext<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;todo something&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>通过以上内容我们学习了什么是任务调度，任务调度所解决的问题，以及任务调度的多种实现方式。</p> <p><strong>什么是分布式任务调度？</strong></p> <p>​    通常任务调度的程序是集成在应用中的，比如：优惠卷服务中包括了定时发放优惠卷的的调度程序，结算服务中包括了定期生成报表的任务调度程序，由于采用分布式架构，一个服务往往会部署多个冗余实例来运行我们的业务，在这种分布式系统环境下运行任务调度，我们称之为<strong>分布式任务调度</strong>，如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151659213.png" alt="image-20250115165912137"></p> <p><strong>分布式调度要实现的目标：</strong></p> <p>不管是任务调度程序集成在应用程序中，还是单独构建的任务调度系统，如果采用分布式调度任务的方式就相当于将任务调度程序分布式构建，这样就可以具有分布式系统的特点，并且提高任务的调度处理能力：</p> <p>1、并行任务调度</p> <p>​    并行任务调度实现靠多线程，如果有大量任务需要调度，此时光靠多线程就会有瓶颈了，因为一台计算机CPU的处理能力是有限的。</p> <p>​    如果将任务调度程序分布式部署，每个结点还可以部署为集群，这样就可以让多台计算机共同去完成任务调度，我们可以将任务分割为若干个分片，由不同的实例并行执行，来提高任务调度的处理效率。</p> <p>2、高可用</p> <p>​    若某一个实例宕机，不影响其他实例来执行任务。</p> <p>3、弹性扩容</p> <p>​    当集群中增加实例就可以提高并执行任务的处理效率。</p> <p>4、任务管理与监测</p> <p>​    对系统中存在的所有定时任务进行统一的管理及监测。让开发人员及运维人员能够时刻了解任务执行情况，从而做出快速的应急处理响应。</p> <p>5、避免任务重复执行</p> <p>​    当任务调度以集群方式部署，同一个任务调度可能会执行多次，比如在上面提到的电商系统中到点发优惠券的例子，就会发放多次优惠券，对公司造成很多损失，所以我们需要控制相同的任务在多个运行实例上只执行一次。</p> <h3 id="_7-2-2-xxl-job介绍"><a href="#_7-2-2-xxl-job介绍" class="header-anchor">#</a> 7.2.2 XXL-JOB介绍</h3> <p>XXL-JOB是一个轻量级分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。现已开放源代码并接入多家公司线上产品线，开箱即用。</p> <p>官网：https://www.xuxueli.com/xxl-job/</p> <p>文档：https://www.xuxueli.com/xxl-job/#%E3%80%8A%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E5%B9%B3%E5%8F%B0XXL-JOB%E3%80%8B</p> <p>XXL-JOB主要有调度中心、执行器、任务：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151700788.png" alt="image-20250115170009706"></p> <p><strong>调度中心：</strong></p> <p>​    负责管理调度信息，按照调度配置发出调度请求，自身不承担业务代码；</p> <p>​    主要职责为执行器管理、任务管理、监控运维、日志管理等</p> <p><strong>任务执行器：</strong></p> <p>​    负责接收调度请求并执行任务逻辑；</p> <p>​    只要职责是注册服务、任务执行服务（接收到任务后会放入线程池中的任务队列）、执行结果上报、日志服务等</p> <p>**任务：**负责执行具体的业务处理。</p> <p>调度中心与执行器之间的工作流程如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151700724.png" alt="image-20250115170022648"></p> <p><strong>执行流程：</strong></p> <p>​    1.任务执行器根据配置的调度中心的地址，自动注册到调度中心</p> <p>​    2.达到任务触发条件，调度中心下发任务</p> <p>​    3.执行器基于线程池执行任务，并把执行结果放入内存队列中、把执行日志写入日志文件中</p> <p>​    4.执行器消费内存队列中的执行结果，主动上报给调度中心</p> <p>​    5.当用户在调度中心查看任务日志，调度中心请求任务执行器，任务执行器读取任务日志文件并返回日志详情</p> <h3 id="_7-2-3-搭建xxl-job"><a href="#_7-2-3-搭建xxl-job" class="header-anchor">#</a> 7.2.3 搭建XXL-JOB</h3> <h4 id="_7-2-3-1-调度中心"><a href="#_7-2-3-1-调度中心" class="header-anchor">#</a> 7.2.3.1 调度中心</h4> <p>首先下载XXL-JOB</p> <p>GitHub：https://github.com/xuxueli/xxl-job</p> <p>码云：https://gitee.com/xuxueli0323/xxl-job</p> <p>项目使用2.3.1版本： https://github.com/xuxueli/xxl-job/releases/tag/2.3.1</p> <p>也可从课程资料目录获取，解压xxl-job-2.3.1.zip</p> <p>使用IDEA打开解压后的目录</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151701089.png" alt="image-20250115170117995"></p> <p>xxl-job-admin：调度中心</p> <p>xxl-job-core：公共依赖</p> <p>xxl-job-executor-samples：执行器Sample示例（选择合适的版本执行器，可直接使用）</p> <p>：xxl-job-executor-sample-springboot：Springboot版本，通过Springboot管理执行器，推荐这种方式；</p> <p>：xxl-job-executor-sample-frameless：无框架版本；</p> <p>doc :文档资料，包含数据库脚本</p> <p>创建数据库：xxl_job_2.3.1</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151701326.png" alt="image-20250115170144253"></p> <p>首先修改doc下的tables_xxl_job.sql脚本内容：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">database</span> <span class="token keyword">if</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>xxl_job_2.3.1<span class="token punctuation">`</span></span> <span class="token keyword">default</span> <span class="token keyword">character</span> <span class="token keyword">set</span> utf8mb4 <span class="token keyword">collate</span> utf8mb4_unicode_ci<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token identifier"><span class="token punctuation">`</span>xxl_job_2.3.1<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>将tables_xxl_job.sql脚本导入xxl_job_2.3.1数据库，导入成功，刷新表，如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151702213.png" alt="image-20250115170216132"></p> <p>修改xxl-job-admin任务调度中心下application.properties的配置文件内容，修改数据库链接地址：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>url<span class="token operator">=</span>jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.101</span><span class="token number">.65</span><span class="token operator">:</span><span class="token number">3306</span><span class="token operator">/</span>xxl_job_2<span class="token punctuation">.</span><span class="token number">3.1</span><span class="token operator">?</span>useUnicode<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>characterEncoding<span class="token operator">=</span><span class="token constant">UTF</span><span class="token operator">-</span><span class="token number">8</span><span class="token operator">&amp;</span>autoReconnect<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>serverTimezone<span class="token operator">=</span><span class="token class-name">Asia</span><span class="token operator">/</span><span class="token class-name">Shanghai</span>
spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>username<span class="token operator">=</span>root
spring<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>password<span class="token operator">=</span>mysql
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>然后启动xxl-job-admin任务调度中心，运行com.xxl.job.admin.XxlJobAdminApplication</p> <p>启动成功访问http://localhost:8080/xxl-job-admin</p> <p>账号和密码：admin/ 123456</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151702172.png" alt="image-20250115170248093"></p> <p>到此调度中心启动成功。</p> <p>在课前下发的虚拟机中已经创建的xxl-job调度中心的容器，后边调用使用docker容器运行xxl-job。</p> <p>启动docker容器：docker start xxl-job-admin</p> <p>访问：http://192.168.101.65:8088/xxl-job-admin/</p> <p>账号和密码：admin/123456</p> <h4 id="_7-2-3-2-执行器"><a href="#_7-2-3-2-执行器" class="header-anchor">#</a> 7.2.3.2 执行器</h4> <p>下边配置执行器，执行器负责与调度中心通信接收调度中心发起的任务调度请求。</p> <p>1、首先在媒资管理模块的service工程添加依赖，在项目的父工程已约定了版本2.3.1</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.xuxueli<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>xxl-job-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>2、在nacos下的media-service-dev.yaml下配置xxl-job</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">xxl</span><span class="token punctuation">:</span>
  <span class="token key atrule">job</span><span class="token punctuation">:</span>
    <span class="token key atrule">admin</span><span class="token punctuation">:</span> 
      <span class="token key atrule">addresses</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8080/xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>admin
    <span class="token key atrule">executor</span><span class="token punctuation">:</span>
      <span class="token key atrule">appname</span><span class="token punctuation">:</span> media<span class="token punctuation">-</span>process<span class="token punctuation">-</span>service
      <span class="token key atrule">address</span><span class="token punctuation">:</span> 
      <span class="token key atrule">ip</span><span class="token punctuation">:</span> 
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9999</span>
      <span class="token key atrule">logpath</span><span class="token punctuation">:</span> /data/applogs/xxl<span class="token punctuation">-</span>job/jobhandler
      <span class="token key atrule">logretentiondays</span><span class="token punctuation">:</span> <span class="token number">30</span>
    <span class="token key atrule">accessToken</span><span class="token punctuation">:</span> default_token
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>注意配置中的appname这是执行器的应用名，稍后在调度中心配置执行器时要使用。</p> <p>3、配置xxl-job的执行器</p> <p>将示例工程下配置类拷贝到媒资管理的service工程下</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151703282.png" alt="image-20250115170359197"></p> <p>拷贝至：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151704658.png" alt="image-20250115170409584"></p> <p>4、下边进入调度中心添加执行器</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151704579.png" alt="image-20250115170422495"></p> <p>点击新增，填写执行器信息，appname是前边在nacos中配置xxl信息时指定的执行器的应用名。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151704130.png" alt="image-20250115170433008"></p> <p>添加成功：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151704429.png" alt="image-20250115170446353"></p> <p>到此完成媒资管理模块service工程配置xxl-job执行器，在xxl-job调度中心添加执行器，下边准备测试执行器与调度中心是否正常通信，因为接口工程依赖了service工程，所以启动媒资管理模块的接口工程。</p> <p>启动后观察日志，出现下边的日志表示执行器在调度中心注册成功</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151705416.png" alt="image-20250115170501343"></p> <p>同时观察调度中心中的执行器界面</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151705030.png" alt="image-20250115170511966"></p> <p>在线机器地址处已显示1个执行器。</p> <h4 id="_7-2-3-3-执行任务"><a href="#_7-2-3-3-执行任务" class="header-anchor">#</a> 7.2.3.3 执行任务</h4> <p>下边编写任务，任务类的编写方法参考示例工程，如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151705942.png" alt="image-20250115170534861"></p> <p>在service包下新建jobhandler存放任务类，下边参考示例工程编写一个任务类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>service<span class="token punctuation">.</span>jobhandler</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xxl<span class="token punctuation">.</span>job<span class="token punctuation">.</span>core<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">XxlJobHelper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xxl<span class="token punctuation">.</span>job<span class="token punctuation">.</span>core<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">XxlJob</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @description 测试执行器
 * @author Mr.M
 * @date 2022/9/13 20:32
 * @version 1.0
 */</span>
 <span class="token annotation punctuation">@Component</span>
 <span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SampleJob</span> <span class="token punctuation">{</span>

 <span class="token comment">/**
  * 1、简单任务示例（Bean模式）
  */</span>
 <span class="token annotation punctuation">@XxlJob</span><span class="token punctuation">(</span><span class="token string">&quot;testJob&quot;</span><span class="token punctuation">)</span>
 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testJob</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
  log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;开始执行.....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>下边在调度中心添加任务，进入任务管理</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151709785.png" alt="image-20250115170950711"></p> <p>点击新增，填写任务信息</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151710480.png" alt="image-20250115171004400"></p> <p>注意红色标记处：</p> <p>调度类型选择Cron，并配置Cron表达式设置定时策略。</p> <p>运行模式有BEAN和GLUE，bean模式较常用就是在项目工程中编写执行器的任务代码，GLUE是将任务代码编写在调度中心。</p> <p>JobHandler任务方法名填写@XxlJob注解中的名称。</p> <p>添加成功，启动任务</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151710580.png" alt="image-20250115171015508"></p> <p>通过调度日志查看任务执行情况</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151710149.png" alt="image-20250115171025080"></p> <p>下边启动媒资管理的service工程，启动执行器。</p> <p>观察执行器方法的执行。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151710150.png" alt="image-20250115171037080"></p> <p>如果要停止任务需要在调度中心操作</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151710158.png" alt="image-20250115171047088"></p> <p>任务跑一段时间注意清理日志</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151711045.png" alt="image-20250115171110958"></p> <h3 id="_7-2-5-分片广播"><a href="#_7-2-5-分片广播" class="header-anchor">#</a> 7.2.5 分片广播</h3> <p>掌握了xxl-job的基本使用，下边思考如何进行分布式任务处理呢？如下图，我们会启动多个执行器组成一个集群，去执行任务。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151711115.png" alt="image-20250115171153027"></p> <p>执行器在集群部署下调度中心有哪些调度策略呢？</p> <p>查看xxl-job官方文档，阅读高级配置相关的内容：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>高级配置：
    - 路由策略：当执行器集群部署时，提供丰富的路由策略，包括；
        FIRST（第一个）：固定选择第一个机器；
        LAST（最后一个）：固定选择最后一个机器；
        ROUND（轮询）：；
        RANDOM（随机）：随机选择在线的机器；
        CONSISTENT_HASH（一致性HASH）：每个任务按照Hash算法固定选择某一台机器，且所有任务均匀散列在不同机器上。
        LEAST_FREQUENTLY_USED（最不经常使用）：使用频率最低的机器优先被选举；
        LEAST_RECENTLY_USED（最近最久未使用）：最久未使用的机器优先被选举；
        FAILOVER（故障转移）：按照顺序依次进行心跳检测，第一个心跳检测成功的机器选定为目标执行器并发起调度；
        BUSYOVER（忙碌转移）：按照顺序依次进行空闲检测，第一个空闲检测成功的机器选定为目标执行器并发起调度；
        SHARDING_BROADCAST(分片广播)：广播触发对应集群中所有机器执行一次任务，同时系统自动传递分片参数；可根据分片参数开发分片任务；
    - 子任务：每个任务都拥有一个唯一的任务ID(任务ID可以从任务列表获取)，当本任务执行结束并且执行成功时，将会触发子任务ID所对应的任务的一次主动调度。
    - 调度过期策略：
        - 忽略：调度过期后，忽略过期的任务，从当前时间开始重新计算下次触发时间；
        - 立即执行一次：调度过期后，立即执行一次，并从当前时间开始重新计算下次触发时间；
    - 阻塞处理策略：调度过于密集执行器来不及处理时的处理策略；
        单机串行（默认）：调度请求进入单机执行器后，调度请求进入FIFO队列并以串行方式运行；
        丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败；
        覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务；
    - 任务超时时间：支持自定义任务超时时间，任务运行超时将会主动中断任务；
    - 失败重试次数；支持自定义任务失败重试次数，当任务失败时将会按照预设的失败重试次数主动进行重试；
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>第一个：每次调度选择集群中第一台执行器。</p> <p>最后一个：每次调度选择集群中最后一台执行器。</p> <p>轮询：按照顺序每次调度选择一台执行器去调度。</p> <p>随机：每次调度随机选择一台执行器去调度。</p> <p>CONSISTENT_HASH：按任务的hash值选择一台执行器去调度。</p> <p>其它策略请自行阅读文档。</p> <p>下边要重点说的是分片广播策略，分片是指是调度中心将集群中的执行器标上序号：0，1，2，3...，广播是指每次调度会向集群中所有执行器发送调度请求，请求中携带分片参数。</p> <p>如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151712215.png" alt="image-20250115171237130"></p> <p>每个执行器收到调度请求根据分片参数自行决定是否执行任务。</p> <p>另外xxl-job还支持动态分片，当执行器数量有变更时，调度中心会动态修改分片的数量。</p> <p><strong>作业分片适用哪些场景呢？</strong></p> <p>•    分片任务场景：10个执行器的集群来处理10w条数据，每台机器只需要处理1w条数据，耗时降低10倍；</p> <p>•    广播任务场景：广播执行器同时运行shell脚本、广播集群节点进行缓存更新等。</p> <p>所以，广播分片方式不仅可以充分发挥每个执行器的能力，并且根据分片参数可以控制任务是否执行，最终灵活控制了执行器集群分布式处理任务。</p> <p><strong>使用说明：</strong></p> <p>&quot;分片广播&quot; 和普通任务开发流程一致，不同之处在于可以获取分片参数进行分片业务处理。</p> <p>Java语言任务获取分片参数方式：</p> <p>BEAN、GLUE模式(Java)，可参考Sample示例执行器中的示例任务&quot;ShardingJobHandler&quot;：</p> <p>ShardingUtil.ShardingVO shardingVO = ShardingUtil.getShardingVo();</p> <p>分片参数属性说明：</p> <p>index：当前分片序号(从0开始)，执行器集群列表中当前执行器的序号；</p> <p>total：总分片数，执行器集群的总机器数量；</p> <p>下边测试作业分片：</p> <p>1、定义作业分片的任务方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
  * 2、分片广播任务
  */</span>
 <span class="token annotation punctuation">@XxlJob</span><span class="token punctuation">(</span><span class="token string">&quot;shardingJobHandler&quot;</span><span class="token punctuation">)</span>
 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shardingJobHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

  <span class="token comment">// 分片参数</span>
  <span class="token keyword">int</span> shardIndex <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> shardTotal <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;分片参数：当前分片序号 = {}, 总分片数 = {}&quot;</span><span class="token punctuation">,</span> shardIndex<span class="token punctuation">,</span> shardTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;开始执行第&quot;</span><span class="token operator">+</span>shardIndex<span class="token operator">+</span><span class="token string">&quot;批任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>2、在调度中心添加任务</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151713679.png" alt="image-20250115171325590"></p> <p>高级配置说明：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code></code></pre> <div class="line-numbers-wrapper"></div></div><p>添加成功：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151713725.png" alt="image-20250115171347639"></p> <p>启动任务，观察日志</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151713481.png" alt="image-20250115171357406"></p> <p>下边启动两个执行器实例，观察每个实例的执行情况</p> <p>首先在nacos中配置media-service的本地优先配置：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment">#配置本地优先</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
 <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
  <span class="token key atrule">config</span><span class="token punctuation">:</span>
    <span class="token key atrule">override-none</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>将media-service启动两个实例</p> <p>两个实例的在启动时注意端口不能冲突：</p> <p>实例1 在VM options处添加：-Dserver.port=63051 -Dxxl.job.executor.port=9998</p> <p>实例2 在VM options处添加：-Dserver.port=63050 -Dxxl.job.executor.port=9999</p> <p>例如：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151714860.png" alt="image-20250115171424773"></p> <p>启动两个实例</p> <p>观察任务调度中心，稍等片刻执行器有两个</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151714228.png" alt="image-20250115171434157"></p> <p>观察两个执行实例的日志：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151714048.png" alt="image-20250115171452970"></p> <p>另一实例的日志如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151715842.png" alt="image-20250115171502765"></p> <p>从日志可以看每个实例的分片序号不同。</p> <p>到此作业分片任务调试完成，此时我们可以思考：</p> <p>当一次分片广播到来，各执行器如何根据分片参数去分布式执行任务，保证执行器之间执行的任务不重复呢？</p> <h2 id="_7-3-需求分析"><a href="#_7-3-需求分析" class="header-anchor">#</a> 7.3 需求分析</h2> <h3 id="_7-3-1-作业分片方案"><a href="#_7-3-1-作业分片方案" class="header-anchor">#</a> 7.3.1 作业分片方案</h3> <p>掌握了xxl-job的作业分片调度方式，下边思考如何分布式去执行学成在线平台中的视频处理任务。</p> <p>任务添加成功后，对于要处理的任务会添加到待处理任务表中，现在启动多个执行器实例去查询这些待处理任务，此时如何保证多个执行器不会重复执行任务？</p> <p>执行器收到调度请求后各自己查询属于自己的任务，这样就保证了执行器之间不会重复执行任务。</p> <p>xxl-job设计作业分片就是为了分布式执行任务，XXL-JOB并不直接提供数据处理的功能，它只会给执行器分配好分片序号并向执行器传递分片总数、分片序号这些参数，开发者需要自行处理分片项与真实数据的对应关系。</p> <p>下图表示了多个执行器获取视频处理任务的结构：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151715040.png" alt="image-20250115171549953"></p> <p>每个执行器收到广播任务有两个参数：分片总数、分片序号。每个执行从数据表取任务时可以让任务id 模上 分片总数，如果等于分片序号则执行此任务。</p> <p>上边两个执行器实例那么分片总数为2，序号为0、1，从任务1开始，如下：</p> <p>1 % 2 = 1  执行器2执行</p> <p>2 % 2 = 0  执行器1执行</p> <p>3 % 2 = 1   执行器2执行</p> <p>以此类推.</p> <p>7.3.2 保证任务不重复执行</p> <p>通过作业分片的方式保证了执行器之间分配的任务不重复，如果同一个执行器在处理一个视频还没有完成，此时调度中心又一次请求调度，为了不重复处理同一个视频该怎么办？</p> <p>首先配置调度过期策略：</p> <p>查看文档如下：</p> <p>- 调度过期策略：
- 忽略：调度过期后，忽略过期的任务，从当前时间开始重新计算下次触发时间；
- 立即执行一次：调度过期后，立即执行一次，并从当前时间开始重新计算下次触发时间；
- 阻塞处理策略：调度过于密集执行器来不及处理时的处理策略；</p> <p>这里我们选择忽略，如果立即执行一次可能会重复调度。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151716792.png" alt="image-20250115171631710"></p> <p>其次，再看阻塞处理策略，阻塞处理策略就是当前执行器正在执行任务还没有结束，此时调度时间到该如何处理。</p> <p>查看文档如下：
单机串行（默认）：调度请求进入单机执行器后，调度请求进入FIFO队列并以串行方式运行；
丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败；
覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务；</p> <p>这里选择 丢弃后续调度，避免重复调度。</p> <p>最后，也就是要注意保证任务处理的幂等性，什么是任务的幂等性？任务的幂等性是指：对于数据的操作不论多少次，操作的结果始终是一致的。执行器接收调度请求去执行任务，要有办法去判断该任务是否处理完成，如果处理完则不再处理，即使重复调度处理相同的任务也不能重复处理相同的视频。</p> <p>什么是幂等性？</p> <p>它描述了一次和多次请求某一个资源对于资源本身应该具有同样的结果。</p> <p>幂等性是为了解决重复提交问题，比如：恶意刷单，重复支付等。</p> <p>解决幂等性常用的方案：</p> <p>1）数据库约束，比如：唯一索引，主键。</p> <p>2）乐观锁，常用于数据库，更新数据时根据乐观锁状态去更新。</p> <p>3）唯一序列号，操作传递一个唯一序列号，操作时判断与该序列号相等则执行。</p> <p>这里我们在数据库视频处理表中添加处理状态字段，视频处理完成更新状态为完成，执行视频处理前判断状态是否完成，如果完成则不再处理。</p> <h3 id="_7-3-2-业务流程"><a href="#_7-3-2-业务流程" class="header-anchor">#</a> 7.3.2 业务流程</h3> <p>确定了分片方案，下边梳理整个视频上传及处理的业务流程。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151717090.png" alt="image-20250115171701006"></p> <p>视频处理的详细流程如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151717385.png" alt="image-20250115171711306"></p> <p>1、任务调度中心广播作业分片。</p> <p>2、执行器收到广播作业分片，从数据库读取待处理任务。</p> <p>3、执行器根据任务内容从MinIO下载要处理的文件。</p> <p>4、执行器启动多线程去处理任务。</p> <p>5、任务处理完成，上传处理后的视频到MinIO。</p> <p>6、将更新任务处理结果，如果视频处理完成除了更新任务处理结果以外还要将文件的访问地址更新至任务处理表及文件表中，最后将任务完成记录写入历史表。</p> <p>下图是待处理任务表：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151717263.png" alt="image-20250115171725169"></p> <p>完成任务历史表与结果与待处理任务相同。</p> <h2 id="_7-4-service开发"><a href="#_7-4-service开发" class="header-anchor">#</a> 7.4 Service开发</h2> <h3 id="_7-4-1-dao开发"><a href="#_7-4-1-dao开发" class="header-anchor">#</a> 7.4.1 DAO开发</h3> <p>根据需求分析，DAO接口包括如下：</p> <p>1、查询待处理视频列表。</p> <p>2、保证视频处理结果</p> <p>3、添加视频历史处理记录表。</p> <p>4、删除已完成视频处理记录</p> <p>5、上传处理后的视频文件向media_files插入记录</p> <p>如何保证查询到的待处理视频记录不重复？</p> <p>编写根据分片参数获取待处理任务的DAO方法。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MediaProcessMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaProcess</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * @description 根据分片参数获取待处理任务
     * @param shardTotal  分片总数
     * @param shardindex  分片序号
     * @param count 任务数
     * @return java.util.List&lt;com.xuecheng.media.model.po.MediaProcess&gt; 
     * @author Mr.M
     * @date 2022/9/14 8:54
    */</span>
    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT t.* FROM media_process t WHERE t.id % #{shardTotal} = #{shardindex} and t.status='1' limit #{count}&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaProcess</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectListByShardIndex</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;shardTotal&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> shardTotal<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;shardindex&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> shardindex<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_7-4-2-service开发"><a href="#_7-4-2-service开发" class="header-anchor">#</a> 7.4.2 Service开发</h3> <p>定义视频处理的Service：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">PageParams</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">PageResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">RestResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">QueryMediaParamsDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">UploadFileParamsDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">UploadFileResultDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MediaFiles</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MediaProcess</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Transactional</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author Mr.M
 * @version 1.0
 * @description 媒资文件处理业务方法
 * @date 2022/9/10 8:55
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MediaFileProcessService</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
 * @description 将url存储至数据，并更新状态为成功，并将待处理视频记录删除存入历史
 * @param status  处理结果，2:成功3失败
 * @param fileId  文件id
 * @param url 文件访问url
 * @param errorMsg 失败原因
 * @return void
 * @author Mr.M
 * @date 2022/9/14 14:45
*/</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveProcessFinishStatus</span><span class="token punctuation">(</span><span class="token keyword">int</span> status<span class="token punctuation">,</span><span class="token class-name">String</span> fileId<span class="token punctuation">,</span> <span class="token class-name">String</span> url<span class="token punctuation">,</span><span class="token class-name">String</span> errorMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * @description 获取待处理任务
     * @param shardIndex 分片序号
     * @param shardTotal 分片总数
     * @param count 获取记录数
     * @return java.util.List&lt;com.xuecheng.media.model.po.MediaProcess&gt;
     * @author Mr.M
     * @date 2022/9/14 14:49
    */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaProcess</span><span class="token punctuation">&gt;</span></span> <span class="token function">getMediaProcessList</span><span class="token punctuation">(</span><span class="token keyword">int</span> shardIndex<span class="token punctuation">,</span><span class="token keyword">int</span> shardTotal<span class="token punctuation">,</span><span class="token keyword">int</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p>实现类如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>conditions<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">LambdaQueryWrapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">MediaFilesMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">MediaProcessHistoryMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">MediaProcessMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MediaFiles</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MediaProcess</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MediaProcessHistory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">MediaFileProcessService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">BeanUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">AutoConfigureOrder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Transactional</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTime</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @description TODO
 * @author Mr.M
 * @date 2022/9/14 14:41
 * @version 1.0
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MediaFileProcessServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">MediaFileProcessService</span> <span class="token punctuation">{</span>

 <span class="token annotation punctuation">@Autowired</span>
 <span class="token class-name">MediaFilesMapper</span> mediaFilesMapper<span class="token punctuation">;</span>

 <span class="token annotation punctuation">@Autowired</span>
 <span class="token class-name">MediaProcessMapper</span> mediaProcessMapper<span class="token punctuation">;</span>

 <span class="token annotation punctuation">@Autowired</span>
 <span class="token class-name">MediaProcessHistoryMapper</span> mediaProcessHistoryMapper<span class="token punctuation">;</span>



 <span class="token annotation punctuation">@Transactional</span>
 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveProcessFinishStatus</span><span class="token punctuation">(</span><span class="token keyword">int</span> status<span class="token punctuation">,</span><span class="token class-name">String</span> fileId<span class="token punctuation">,</span> <span class="token class-name">String</span> url<span class="token punctuation">,</span><span class="token class-name">String</span> errorMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">MediaProcess</span> mediaProcess <span class="token operator">=</span> mediaProcessMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaProcess</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">MediaProcess</span><span class="token operator">::</span><span class="token function">getFileId</span><span class="token punctuation">,</span> fileId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>mediaProcess <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//处理失败</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  mediaProcess<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  mediaProcess<span class="token punctuation">.</span><span class="token function">setErrormsg</span><span class="token punctuation">(</span>errorMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  mediaProcessMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>mediaProcess<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
  <span class="token class-name">MediaFiles</span> mediaFiles <span class="token operator">=</span> mediaFilesMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>fileId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>mediaFiles<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   mediaFiles<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
   mediaFilesMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>mediaFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

   mediaProcess<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
   mediaProcess<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   mediaProcess<span class="token punctuation">.</span><span class="token function">setFinishDate</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   mediaProcessMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>mediaProcess<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//添加到历史记录</span>
   <span class="token class-name">MediaProcessHistory</span> mediaProcessHistory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaProcessHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>mediaProcess<span class="token punctuation">,</span> mediaProcessHistory<span class="token punctuation">)</span><span class="token punctuation">;</span>
   mediaProcessHistoryMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>mediaProcessHistory<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//删除mediaProcess</span>
   mediaProcessMapper<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>mediaProcess<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>

 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaProcess</span><span class="token punctuation">&gt;</span></span> <span class="token function">getMediaProcessList</span><span class="token punctuation">(</span><span class="token keyword">int</span> shardIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> shardTotal<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaProcess</span><span class="token punctuation">&gt;</span></span> mediaProcesses <span class="token operator">=</span> mediaProcessMapper<span class="token punctuation">.</span><span class="token function">selectListByShardIndex</span><span class="token punctuation">(</span>shardTotal<span class="token punctuation">,</span> shardIndex<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> mediaProcesses<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br></div></div><h2 id="_7-5-任务开发"><a href="#_7-5-任务开发" class="header-anchor">#</a> 7.5 任务开发</h2> <h3 id="_7-5-1-视频处理工具类"><a href="#_7-5-1-视频处理工具类" class="header-anchor">#</a> 7.5.1 视频处理工具类</h3> <p>将课程资料目录中的util.zip解压，将解压出的工具类拷贝至base工程。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151720381.png" alt="image-20250115172008287"></p> <p>并在base工程添加如下依赖：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- fast Json --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- servlet Api 依赖 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>javax.servlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>javax.servlet-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>provided<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 通用组件 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>commons-lang<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-lang<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>commons-codec<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-codec<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>其中Mp4VideoUtil类是用于将视频转为mp4格式，是我们项目要使用的工具类。</p> <p>下边看下这个类的代码，并进行测试。</p> <p>我们要通过ffmpeg对视频转码，Java程序调用ffmpeg，使用java.lang.ProcessBuilder去完成，具体在Mp4VideoUtil类的63行。</p> <p>使用该类的main方法进行测试</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//ffmpeg的路径</span>
    <span class="token class-name">String</span> ffmpeg_path <span class="token operator">=</span> <span class="token string">&quot;D:\\soft\\ffmpeg\\ffmpeg.exe&quot;</span><span class="token punctuation">;</span><span class="token comment">//ffmpeg的安装位置</span>
    <span class="token comment">//源avi视频的路径</span>
    <span class="token class-name">String</span> video_path <span class="token operator">=</span> <span class="token string">&quot;D:\\develop\\bigfile_test\\nacos01.avi&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">//转换后mp4文件的名称</span>
    <span class="token class-name">String</span> mp4_name <span class="token operator">=</span> <span class="token string">&quot;nacos01.mp4&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">//转换后mp4文件的路径</span>
    <span class="token class-name">String</span> mp4_path <span class="token operator">=</span> <span class="token string">&quot;D:\\develop\\bigfile_test\\nacos01.mp4&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">//创建工具类对象</span>
    <span class="token class-name">Mp4VideoUtil</span> videoUtil <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mp4VideoUtil</span><span class="token punctuation">(</span>ffmpeg_path<span class="token punctuation">,</span>video_path<span class="token punctuation">,</span>mp4_name<span class="token punctuation">,</span>mp4_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//开始视频转换，成功将返回success</span>
    <span class="token class-name">String</span> s <span class="token operator">=</span> videoUtil<span class="token punctuation">.</span><span class="token function">generateMp4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>执行main方法，最终在控制台输出 success 表示执行成功。</p> <h3 id="_7-5-1-任务类"><a href="#_7-5-1-任务类" class="header-anchor">#</a> 7.5.1 任务类</h3> <p>视频采用并发处理，每个视频使用一个线程去处理，每次处理的视频数量不要超过cpu核心数。</p> <p>所有视频处理完成结束本次执行，为防止代码异常出现无限期等待添加超时设置，到达超时时间还没有处理完成仍结束任务。</p> <p>定义任务类VideoTask 如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>service<span class="token punctuation">.</span>jobhandler</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">Mp4VideoUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">MediaFilesMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">MediaProcessHistoryMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">MediaProcessMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MediaFiles</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MediaProcess</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MediaProcessHistory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">MediaFileProcessService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>media<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">MediaFileService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xxl<span class="token punctuation">.</span>job<span class="token punctuation">.</span>core<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">XxlJobHelper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xxl<span class="token punctuation">.</span>job<span class="token punctuation">.</span>core<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">XxlJob</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>minio<span class="token punctuation">.</span></span><span class="token class-name">MinioClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">BeanUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Transactional</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTime</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">UUID</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">CountDownLatch</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ExecutorService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Executors</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 视频处理任务
 *
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VideoTask</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MediaFileService</span> mediaFileService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MediaFileProcessService</span> mediaFileProcessService<span class="token punctuation">;</span>

    <span class="token comment">//ffmpeg绝对路径</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${videoprocess.ffmpegpath}&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> ffmpegPath<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 视频处理
     */</span>
    <span class="token annotation punctuation">@XxlJob</span><span class="token punctuation">(</span><span class="token string">&quot;videoJobHandler&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">videoJobHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 分片参数</span>
        <span class="token keyword">int</span> shardIndex <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> shardTotal <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;shardIndex=&quot;</span><span class="token operator">+</span>shardIndex<span class="token operator">+</span><span class="token string">&quot;,shardTotal=&quot;</span><span class="token operator">+</span>shardTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//一次取出2条记录，可以调整此数据，一次处理的最大个数不要超过cpu核心数</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaProcess</span><span class="token punctuation">&gt;</span></span> mediaProcesses <span class="token operator">=</span> mediaFileProcessService<span class="token punctuation">.</span><span class="token function">getMediaProcessList</span><span class="token punctuation">(</span>shardIndex<span class="token punctuation">,</span> shardTotal<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//数据个数</span>
        <span class="token keyword">int</span> size <span class="token operator">=</span> mediaProcesses<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;取出待处理视频记录&quot;</span><span class="token operator">+</span>size<span class="token operator">+</span><span class="token string">&quot;条&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>size<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//启动size上线程数量的线程池</span>
        <span class="token class-name">ExecutorService</span> threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//计数器</span>
        <span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mediaProcesses<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>mediaProcess <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
                <span class="token comment">//桶</span>
                <span class="token class-name">String</span> bucket <span class="token operator">=</span> mediaProcess<span class="token punctuation">.</span><span class="token function">getBucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//存储路径</span>
                <span class="token class-name">String</span> filePath <span class="token operator">=</span> mediaProcess<span class="token punctuation">.</span><span class="token function">getFilePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//原始视频的md5值</span>
                <span class="token class-name">String</span> fileId <span class="token operator">=</span> mediaProcess<span class="token punctuation">.</span><span class="token function">getFileId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//原始文件名称</span>
                <span class="token class-name">String</span> filename <span class="token operator">=</span> mediaProcess<span class="token punctuation">.</span><span class="token function">getFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//下载文件</span>
                <span class="token comment">//先创建临时文件，为原始的视频文件</span>
                <span class="token class-name">File</span> originalVideo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token comment">//处理结束的mp4文件</span>
                <span class="token class-name">File</span> mp4Video <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    originalVideo <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">.</span><span class="token function">createTempFile</span><span class="token punctuation">(</span><span class="token string">&quot;original&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mp4Video <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">.</span><span class="token function">createTempFile</span><span class="token punctuation">(</span><span class="token string">&quot;mp4&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.mp4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;下载待处理的原始文件前创建临时文件失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    originalVideo <span class="token operator">=</span> mediaFileService<span class="token punctuation">.</span><span class="token function">downloadFileFromMinIO</span><span class="token punctuation">(</span>originalVideo<span class="token punctuation">,</span> bucket<span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">//开始处理视频</span>
                    <span class="token class-name">Mp4VideoUtil</span> mp4VideoUtil <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mp4VideoUtil</span><span class="token punctuation">(</span>ffmpegPath<span class="token punctuation">,</span>originalVideo<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>mp4Video<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>mp4Video<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> result <span class="token operator">=</span> mp4VideoUtil<span class="token punctuation">.</span><span class="token function">generateMp4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token comment">//记录错误信息</span>
                        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;generateMp4 error ,video_path is {},error msg is {}&quot;</span><span class="token punctuation">,</span>bucket<span class="token operator">+</span>filePath<span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mediaFileProcessService<span class="token punctuation">.</span><span class="token function">saveProcessFinishStatus</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span>fileId<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//将mp4上传至minio</span>
                    <span class="token comment">//文件路径</span>
                    <span class="token class-name">String</span> objectName <span class="token operator">=</span> <span class="token function">getFilePath</span><span class="token punctuation">(</span>fileId<span class="token punctuation">,</span> <span class="token string">&quot;.mp4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mediaFileService<span class="token punctuation">.</span><span class="token function">addMediaFilesToMinIO</span><span class="token punctuation">(</span>mp4Video<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>bucket<span class="token punctuation">,</span>objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">//访问url</span>
                    <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">&quot;/&quot;</span><span class="token operator">+</span>bucket<span class="token operator">+</span><span class="token string">&quot;/&quot;</span><span class="token operator">+</span>objectName<span class="token punctuation">;</span>
                    <span class="token comment">//将url存储至数据，并更新状态为成功，并将待处理视频记录删除存入历史</span>
                    mediaFileProcessService<span class="token punctuation">.</span><span class="token function">saveProcessFinishStatus</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>fileId<span class="token punctuation">,</span>url<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token comment">//清理文件</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>originalVideo<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            originalVideo<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>mp4Video<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            mp4Video<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//等待,给一个充裕的超时时间,防止无限等待，到达超时时间还没有处理完成则结束任务</span>
        countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getFilePath</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span><span class="token class-name">String</span> fileExt<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span>   fileMd5<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> fileMd5<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> fileMd5 <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span>fileMd5 <span class="token operator">+</span>fileExt<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br></div></div><h2 id="_7-6-视频处理测试"><a href="#_7-6-视频处理测试" class="header-anchor">#</a> 7.6 视频处理测试</h2> <h3 id="_7-6-1-上传视频代码完善"><a href="#_7-6-1-上传视频代码完善" class="header-anchor">#</a> 7.6.1 上传视频代码完善</h3> <p>上传视频成功根据视频文件格式判断，如果是avi文件则需要加入视频待处理表。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @param fileMd5             文件md5
 * @param uploadFileParamsDto 文件的基本信息
 * @param bucket              桶
 * @param objectName          minio中文件的路径
 * @return int
 * @description 媒资文件入库
 * @author Mr.M
 * @date 2022/9/13 16:27
 */</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token class-name">MediaFiles</span> <span class="token function">addMediaFilesToDb</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span> <span class="token class-name">String</span> fileMd5<span class="token punctuation">,</span> <span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto<span class="token punctuation">,</span> <span class="token class-name">String</span> bucket<span class="token punctuation">,</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">MediaFiles</span> mediaFiles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>uploadFileParamsDto<span class="token punctuation">,</span> mediaFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mediaFiles<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mediaFiles<span class="token punctuation">.</span><span class="token function">setFileId</span><span class="token punctuation">(</span>fileMd5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mediaFiles<span class="token punctuation">.</span><span class="token function">setCompanyId</span><span class="token punctuation">(</span>companyId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mediaFiles<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mediaFiles<span class="token punctuation">.</span><span class="token function">setBucket</span><span class="token punctuation">(</span>bucket<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mediaFiles<span class="token punctuation">.</span><span class="token function">setFilePath</span><span class="token punctuation">(</span>objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mediaFiles<span class="token punctuation">.</span><span class="token function">setCreateDate</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mediaFiles<span class="token punctuation">.</span><span class="token function">setAuditStatus</span><span class="token punctuation">(</span><span class="token string">&quot;202004&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mediaFiles<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始状态正常显示</span>
    <span class="token comment">//保存文件信息到媒资数据库</span>
    <span class="token keyword">int</span> insert <span class="token operator">=</span> mediaFilesMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>mediaFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//取出文件扩展名</span>
    <span class="token class-name">String</span> extension <span class="token operator">=</span> objectName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>objectName<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果是avi则加入视频处理表</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>extension<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">&quot;.avi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">MediaProcess</span> mediaProcess <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>mediaFiles<span class="token punctuation">,</span>mediaProcess<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaProcessMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>mediaProcess<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//更新url为空</span>
        mediaFiles<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaFilesMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>mediaFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> mediaFiles<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h3 id="_7-6-2-视频处理调度策略"><a href="#_7-6-2-视频处理调度策略" class="header-anchor">#</a> 7.6.2 视频处理调度策略</h3> <p>进入xxl-job调度中心添加执行器和任务</p> <p>在xxl-job配置任务调度策略：</p> <p>1）配置阻塞处理策略为：丢弃后续调度。</p> <p>2）配置视频处理调度时间间隔不用根据视频处理时间去确定，可以配置的小一些，如：5分钟，即使到达调度时间如果视频没有处理完会丢失调度请求。</p> <p>配置完成开始测试视频处理：</p> <p>1、首先上传至少4个视频，非mp4格式。</p> <p>2、启动媒资管理服务，观察日志</p> <h1 id="_8-绑定媒资"><a href="#_8-绑定媒资" class="header-anchor">#</a> 8 绑定媒资</h1> <h2 id="_8-1-需求分析"><a href="#_8-1-需求分析" class="header-anchor">#</a> 8.1 需求分析</h2> <h3 id="_8-1-1-业务流程"><a href="#_8-1-1-业务流程" class="header-anchor">#</a> 8.1.1 业务流程</h3> <p>到目前为止，媒资管理已完成文件上传、视频处理、我的媒资功能等基本功能，其它模块可以使用媒资文件，本节要讲解课程计划绑定媒资文件。</p> <p>如何将课程计划绑定媒资呢？</p> <p>首先进入课程计划界面，然后选择要绑定的视频进行绑定即可。</p> <p>具体的业务流程如下：</p> <p>1.教育机构用户进入课程管理页面并编辑某一个课程，在&quot;课程大纲&quot;标签页的某一小节后可点击”添加视频“。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151724516.png" alt="image-20250115172406407"></p> <p>2.弹出添加视频对话框，可通过视频关键字搜索已审核通过的视频媒资。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151724918.png" alt="image-20250115172417831"></p> <p>3.选择视频媒资，点击提交按钮，完成课程计划绑定媒资流程。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151724012.png" alt="image-20250115172428912"></p> <p>课程计划关联视频后如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151724022.png" alt="image-20250115172441938"></p> <h3 id="_8-1-2-数据模型"><a href="#_8-1-2-数据模型" class="header-anchor">#</a> 8.1.2 数据模型</h3> <p>课程计划绑定媒资文件后存储至课程计划绑定媒资表</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo1/202501151725639.png" alt="image-20250115172503554"></p> <h2 id="_8-2-接口定义"><a href="#_8-2-接口定义" class="header-anchor">#</a> 8.2 接口定义</h2> <p>根据业务流程，用户进入课程计划列表，首先确定向哪个课程计划添加视频，点击”添加视频“后用户选择视频，选择视频，点击提交，提交媒资文件id、文件名称、教学计划id，示例如下：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;mediaId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;70a98b4a2fffc89e50b101f959cc33ca&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;fileName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;22-Hmily实现TCC事务-开发bank2的confirm方法.avi&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;teachplanId&quot;</span><span class="token operator">:</span> <span class="token number">257</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>此接口在内容管理模块提供。</p> <p>在内容管理模块定义请求参数模型类型：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@ApiModel</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">&quot;BindTeachplanMediaDto&quot;</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">&quot;教学计划-媒资绑定提交数据&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BindTeachplanMediaDto</span> <span class="token punctuation">{</span>

 <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;媒资文件id&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
 <span class="token keyword">private</span> <span class="token class-name">Long</span> mediaId<span class="token punctuation">;</span>

 <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;媒资文件名称&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
 <span class="token keyword">private</span> <span class="token class-name">Long</span> fileName<span class="token punctuation">;</span>

 <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;课程计划标识&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
 <span class="token keyword">private</span> <span class="token class-name">Long</span> teachplanId<span class="token punctuation">;</span>


<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>接口定义如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;课程计划和媒资信息绑定&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/teachplan/association/media&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">associationMedia</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">BindTeachplanMediaDto</span> bindTeachplanMediaDto<span class="token punctuation">)</span><span class="token punctuation">{</span>

<span class="token punctuation">}</span>

<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;课程计划和媒资信息解除绑定&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@DeleteMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/teachplan/association/media/{teachPlanId}/{mediaId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">delAssociationMedia</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> teachPlanId<span class="token punctuation">,</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> mediaId<span class="token punctuation">)</span><span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="_8-3-接口开发"><a href="#_8-3-接口开发" class="header-anchor">#</a> 8.3 接口开发</h2> <h3 id="_8-3-1-dao开发"><a href="#_8-3-1-dao开发" class="header-anchor">#</a> 8.3.1 DAO开发</h3> <p>对teachplanMedia表自动生成Mapper。</p> <h3 id="_8-3-2-service开发"><a href="#_8-3-2-service开发" class="header-anchor">#</a> 8.3.2 Service开发</h3> <p>根据需求定义service接口</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @description 教学计划板顶媒资
 * @param bindTeachplanMediaDto
 * @return com.xuecheng.content.model.po.TeachplanMedia
 * @author Mr.M
 * @date 2022/9/14 22:20
*/</span>
<span class="token keyword">public</span> <span class="token class-name">TeachplanMedia</span> <span class="token function">associationMedia</span><span class="token punctuation">(</span><span class="token class-name">BindTeachplanMediaDto</span> bindTeachplanMediaDto<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @description 删除教学计划与媒资之间的绑定关系
 * @param teachPlanId  教学计划id
 * @param mediaId  媒资文件id
 * @return void
 * @author Mr.M
 * @date 2022/9/14 22:21
*/</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delAassociationMedia</span><span class="token punctuation">(</span><span class="token class-name">Long</span> teachPlanId<span class="token punctuation">,</span> <span class="token class-name">String</span> mediaId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>定义接口实现</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">TeachplanMedia</span> <span class="token function">associationMedia</span><span class="token punctuation">(</span><span class="token class-name">BindTeachplanMediaDto</span> bindTeachplanMediaDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">//教学计划id</span>
 <span class="token class-name">Long</span> teachplanId <span class="token operator">=</span> bindTeachplanMediaDto<span class="token punctuation">.</span><span class="token function">getTeachplanId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">Teachplan</span> teachplan <span class="token operator">=</span> teachplanMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>teachplanId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>teachplan<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;教学计划不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token class-name">Integer</span> grade <span class="token operator">=</span> teachplan<span class="token punctuation">.</span><span class="token function">getGrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>grade<span class="token operator">!=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;只允许第二级教学计划绑定媒资文件&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">//课程id</span>
 <span class="token class-name">Long</span> courseId <span class="token operator">=</span> teachplan<span class="token punctuation">.</span><span class="token function">getCourseId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">//先删除原因该教学计划绑定的媒资</span>
 teachplanMediaMapper<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TeachplanMedia</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">TeachplanMedia</span><span class="token operator">::</span><span class="token function">getTeachplanId</span><span class="token punctuation">,</span>teachplanId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">//再添加教学计划与媒资的绑定关系</span>
 <span class="token class-name">TeachplanMedia</span> teachplanMedia <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TeachplanMedia</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 teachplanMedia<span class="token punctuation">.</span><span class="token function">setCourseId</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 teachplanMedia<span class="token punctuation">.</span><span class="token function">setTeachplanId</span><span class="token punctuation">(</span>teachplanId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 teachplanMedia<span class="token punctuation">.</span><span class="token function">setMediaFilename</span><span class="token punctuation">(</span>bindTeachplanMediaDto<span class="token punctuation">.</span><span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 teachplanMedia<span class="token punctuation">.</span><span class="token function">setMediaId</span><span class="token punctuation">(</span>bindTeachplanMediaDto<span class="token punctuation">.</span><span class="token function">getMediaId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 teachplanMedia<span class="token punctuation">.</span><span class="token function">setCreateDate</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 teachplanMediaMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>teachplanMedia<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> teachplanMedia<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delAassociationMedia</span><span class="token punctuation">(</span><span class="token class-name">Long</span> teachPlanId<span class="token punctuation">,</span> <span class="token class-name">String</span> mediaId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 teachplanMediaMapper<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TeachplanMedia</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">TeachplanMedia</span><span class="token operator">::</span><span class="token function">getTeachplanId</span><span class="token punctuation">,</span>teachPlanId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">TeachplanMedia</span><span class="token operator">::</span><span class="token function">getMediaId</span><span class="token punctuation">,</span>mediaId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//交换位置</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">swapTeachplan</span><span class="token punctuation">(</span><span class="token class-name">Teachplan</span> left<span class="token punctuation">,</span><span class="token class-name">Teachplan</span> right<span class="token punctuation">)</span><span class="token punctuation">{</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>left<span class="token operator">==</span><span class="token keyword">null</span> <span class="token operator">||</span> right<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token class-name">Integer</span> orderby_left <span class="token operator">=</span> left<span class="token punctuation">.</span><span class="token function">getOrderby</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">Integer</span> orderby_right <span class="token operator">=</span> right<span class="token punctuation">.</span><span class="token function">getOrderby</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 left<span class="token punctuation">.</span><span class="token function">setOrderby</span><span class="token punctuation">(</span>orderby_right<span class="token punctuation">)</span><span class="token punctuation">;</span>
 right<span class="token punctuation">.</span><span class="token function">setOrderby</span><span class="token punctuation">(</span>orderby_left<span class="token punctuation">)</span><span class="token punctuation">;</span>
 teachplanMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>
 teachplanMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>
 log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;课程计划交换位置，left:{},right:{}&quot;</span><span class="token punctuation">,</span>left<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>right<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><h3 id="_8-3-3-接口层完善"><a href="#_8-3-3-接口层完善" class="header-anchor">#</a> 8.3.3 接口层完善</h3> <p>完善接口层调用Service层的代码</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;课程计划和媒资信息绑定&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/teachplan/association/media&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">associationMedia</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">BindTeachplanMediaDto</span> bindTeachplanMediaDto<span class="token punctuation">)</span><span class="token punctuation">{</span>
    teachplanService<span class="token punctuation">.</span><span class="token function">associationMedia</span><span class="token punctuation">(</span>bindTeachplanMediaDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;课程计划和媒资信息解除绑定&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@DeleteMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/teachplan/association/media/{teachPlanId}/{mediaId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">delAssociationMedia</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> teachPlanId<span class="token punctuation">,</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> mediaId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    teachplanService<span class="token punctuation">.</span><span class="token function">delAassociationMedia</span><span class="token punctuation">(</span>teachPlanId<span class="token punctuation">,</span>mediaId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_8-3-4-接口测试"><a href="#_8-3-4-接口测试" class="header-anchor">#</a> 8.3.4 接口测试</h3> <p>1、使用httpclient测试</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>### 课程计划绑定视频
POST <span class="token punctuation">{</span><span class="token punctuation">{</span>media_host<span class="token punctuation">}</span><span class="token punctuation">}</span>/media/teachplan/association/media
Content-Type<span class="token operator">:</span> application/json

<span class="token punctuation">{</span>
  <span class="token property">&quot;mediaId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;fileName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;teachplanId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>
<span class="token punctuation">}</span>

### 课程计划接触视频绑定
DELETE <span class="token punctuation">{</span><span class="token punctuation">{</span>media_host<span class="token punctuation">}</span><span class="token punctuation">}</span>/media/teachplan/association/media/<span class="token punctuation">{</span>teachPlanId<span class="token punctuation">}</span>/<span class="token punctuation">{</span>mediaId<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>2、前后端联调</p> <p>此功能较为简单推荐直接前后端联调</p> <p>向指定课程计划添加视频、解除视频绑定。</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/xugaoyi/vuepress-theme-vdoing/edit/master/docs/《XueChengPlus》笔记/04.第3章-媒资管理模块.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2025/01/15, 22:22:06</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/vuepress-tion-blog/pages/a5a8d0/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">第2章-内容管理-实战</div></a> <a href="/vuepress-tion-blog/pages/7a3e9f/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">第4章-课程发布</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/vuepress-tion-blog/pages/a5a8d0/" class="prev">第2章-内容管理-实战</a></span> <span class="next"><a href="/vuepress-tion-blog/pages/7a3e9f/">第4章-课程发布</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/vuepress-tion-blog/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/vuepress-tion-blog/pages/31d7dd/"><div>
            05-大数据技术之Hadoop（Yarn）V3.3
            <!----></div></a> <span class="date">02-24</span></dt></dl><dl><dd>02</dd> <dt><a href="/vuepress-tion-blog/pages/fc670b/"><div>
            Linux实用操作
            <!----></div></a> <span class="date">02-22</span></dt></dl><dl><dd>03</dd> <dt><a href="/vuepress-tion-blog/pages/bdd22a/"><div>
            用户和权限
            <!----></div></a> <span class="date">02-22</span></dt></dl> <dl><dd></dd> <dt><a href="/vuepress-tion-blog/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:894072666@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/xugaoyi" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2025
    <span>Evan Xu | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a> | <a href="http://beian.miit.gov.cn/" target="_blank">桂ICP备2024034950号</a> | <img src="/img/beian.png" style="width: 15px; margin-bottom: -3px;" /> <a href="https://beian.mps.gov.cn/#/query/webSearch?code=45142202000030" rel="noreferrer" target="_blank">桂公网安备45142202000030</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/vuepress-tion-blog/assets/js/app.985e0c44.js" defer></script><script src="/vuepress-tion-blog/assets/js/2.1e9277be.js" defer></script><script src="/vuepress-tion-blog/assets/js/207.6c3f0adc.js" defer></script>
  </body>
</html>
