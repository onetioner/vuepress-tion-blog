<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第4章-课程发布 | Onetion blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/vuepress-tion-blog/img/favicon.ico">
    <meta name="description" content="暂无描述。">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/vuepress-tion-blog/assets/css/0.styles.e8f25b53.css" as="style"><link rel="preload" href="/vuepress-tion-blog/assets/js/app.985e0c44.js" as="script"><link rel="preload" href="/vuepress-tion-blog/assets/js/2.1e9277be.js" as="script"><link rel="preload" href="/vuepress-tion-blog/assets/js/208.98b8311d.js" as="script"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/10.d8aaa1e2.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/100.573bf337.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/101.d7a8d195.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/102.fbe95517.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/103.9c535674.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/104.32351bcc.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/105.b6592589.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/106.8d41efa5.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/107.81a457e6.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/108.8ec864e5.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/109.51239835.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/11.a042cecb.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/110.cacfe028.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/111.0c6750bc.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/112.10684042.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/113.9f9d8990.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/114.f63027de.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/115.f2a98bd3.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/116.1596b700.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/117.7474ad53.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/118.75dfe374.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/119.69b852f5.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/12.b59eab1d.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/120.21dce642.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/121.6383cf7a.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/122.aecc2d6d.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/123.8e4b47dc.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/124.ebeb3341.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/125.d30e0414.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/126.88154b46.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/127.f11c43ad.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/128.d2af5d75.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/129.4ec987d8.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/13.a5c5a2c7.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/130.852e041a.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/131.a2838818.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/132.e76fcb34.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/133.576684f3.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/134.b610dab9.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/135.6ddc8624.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/136.169f274d.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/137.bc17c8fb.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/138.613e8ec5.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/139.a5f28e09.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/14.d548163d.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/140.6f0e2449.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/141.25fa2479.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/142.dbbf3675.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/143.50d1c2c7.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/144.ba7322be.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/145.9b01e005.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/146.a3b7fa06.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/147.10ebf0da.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/148.f1813bc1.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/149.558a4638.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/15.9cd1a424.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/150.9fb25f94.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/151.7aa93b4c.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/152.532b2a06.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/153.b44e17d2.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/154.22bb2b40.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/155.72912290.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/156.8fb9164a.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/157.2993ac86.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/158.941ffddc.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/159.9949acea.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/16.0c491dca.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/160.b0734e8c.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/161.64295a7b.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/162.af6a1a02.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/163.8a084ab0.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/164.b3a5ce11.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/165.006ba217.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/166.8673b3eb.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/167.174f47d0.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/168.ab558478.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/169.2924afe0.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/17.bc0ce024.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/170.938fb8fd.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/171.dba8105e.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/172.3ed2b9da.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/173.21e26430.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/174.cf558b90.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/175.e2dbf973.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/176.99fdd868.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/177.b749e041.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/178.50873a04.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/179.2b2b20b8.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/18.3daae30f.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/180.e02057f8.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/181.4db698f3.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/182.5f8824c7.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/183.6edf3c7c.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/184.1bd636af.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/185.36ff0829.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/186.5cf6e096.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/187.a5a1b8ff.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/188.afbe2342.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/189.03172795.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/19.3baab1b3.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/190.cdbd5be0.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/191.f0b571be.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/192.b17d8025.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/193.71f932fa.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/194.8c1effb7.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/195.97749178.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/196.1c2212a2.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/197.b11aec90.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/198.c944c329.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/199.89d6fb24.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/20.04915620.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/200.1f73ae03.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/201.a76ba977.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/202.6506ac4e.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/203.58b5a385.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/204.5c93632e.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/205.266be28d.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/206.8351bc41.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/207.6c3f0adc.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/209.c7197c50.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/21.612e714c.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/210.85568730.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/211.57ca633f.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/22.73e68385.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/23.e2dc9896.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/24.dd12884f.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/25.1657ab7c.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/26.fa7585ce.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/27.a745f91e.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/28.9fd9565c.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/29.4a93ed10.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/3.e80e214b.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/30.48d9f0d9.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/31.d1533b42.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/32.577b9985.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/33.804f824e.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/34.6673d1e7.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/35.467aab87.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/36.1ff1934f.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/37.94917ddd.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/38.267be9e6.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/39.6db92b69.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/4.5c19aee3.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/40.4baf779a.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/41.d1f2437d.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/42.7abdd1fb.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/43.daec0261.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/44.e62a9c60.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/45.2d73beaf.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/46.96498038.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/47.84482418.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/48.ec50c17c.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/49.865f9ad3.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/5.9fe40e58.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/50.6bccd4b4.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/51.2f1f7e9d.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/52.53c5b275.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/53.648f4af7.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/54.a8f675df.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/55.857005bf.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/56.21b8b93d.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/57.4267e8e7.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/58.6f22a666.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/59.7ce4c5d3.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/6.7a1e80d8.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/60.bb4d7708.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/61.3ae45564.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/62.36c8a921.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/63.0cf0550f.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/64.c236b268.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/65.3dd549de.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/66.132faef6.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/67.02c3c837.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/68.38da0121.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/69.cfea652f.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/7.e4a9cefa.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/70.115de5a1.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/71.2c0ab68b.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/72.6150c1bb.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/73.485cff3f.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/74.c0d67eb7.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/75.207d3d40.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/76.c4152b85.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/77.fd3d4523.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/78.fb0e3bfd.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/79.0c70e8a7.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/8.1c6e1779.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/80.8d44c6b0.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/81.3764c177.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/82.43478cb4.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/83.c46fe3ff.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/84.aed40128.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/85.9f8f2508.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/86.d250fe69.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/87.c7dfc942.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/88.0ac96029.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/89.5d8f5e20.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/9.4da03d4f.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/90.054f7950.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/91.e05ad0c1.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/92.52f350fe.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/93.26b6b24e.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/94.99e6ce73.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/95.ea8c8ea4.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/96.98e7d194.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/97.14c4ed1b.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/98.f5cdc1ab.js"><link rel="prefetch" href="/vuepress-tion-blog/assets/js/99.f92a6d95.js">
    <link rel="stylesheet" href="/vuepress-tion-blog/assets/css/0.styles.e8f25b53.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuepress-tion-blog/" class="home-link router-link-active"><img src="/vuepress-tion-blog/img/logo.png" alt="Onetion blog" class="logo"> <span class="site-name can-hide">Onetion blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vuepress-tion-blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文档中心" class="dropdown-title"><a href="/vuepress-tion-blog/learn/" class="link-title">文档中心</a> <span class="title" style="display:none;">文档中心</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>前端文章</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vuepress-tion-blog/pages/8143cc480faf9a11/" class="nav-link">JavaScript</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/javase/" class="nav-link">《JavaSE笔记》</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/javaweb/" class="nav-link">《JavaWeb》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/maven/" class="nav-link">《Maven》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/git/" class="nav-link">《Git》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/ssm/" class="nav-link">《SSM》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/mybatisplus/" class="nav-link">《MybatisPlus》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/reggietakeout/" class="nav-link">《ReggieTakeOut》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/microservice/" class="nav-link">《MicroService》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/xuechengplus/" class="nav-link">《XueChengPlus》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/flume/" class="nav-link">《Flume》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/python/" class="nav-link">《Python》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/scala/" class="nav-link">《Scala》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/linux/" class="nav-link">《Linux》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/hadoop/" class="nav-link">《Hadoop》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/designpatterns/" class="nav-link">《Java设计模式》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/htmlcssweb/" class="nav-link">《HTML-CSS-WEB》笔记</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="页面" class="dropdown-title"><a href="/vuepress-tion-blog/ui/" class="link-title">页面</a> <span class="title" style="display:none;">页面</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/8309a5b876fc95e3/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/0a83b083bdf257cb/" class="nav-link">CSS</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/vuepress-tion-blog/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/9a7ee40fc232253e/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/vuepress-tion-blog/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/baaa02/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/vuepress-tion-blog/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/vuepress-tion-blog/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/vuepress-tion-blog/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://jsd.cdn.zzko.cn/gh/xugaoyi/image_store/blog/20200103123203.jpg"> <div class="blogger-info"><h3>Evan Xu</h3> <span>前端界的小学生</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/vuepress-tion-blog/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文档中心" class="dropdown-title"><a href="/vuepress-tion-blog/learn/" class="link-title">文档中心</a> <span class="title" style="display:none;">文档中心</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>前端文章</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vuepress-tion-blog/pages/8143cc480faf9a11/" class="nav-link">JavaScript</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/javase/" class="nav-link">《JavaSE笔记》</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/javaweb/" class="nav-link">《JavaWeb》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/maven/" class="nav-link">《Maven》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/git/" class="nav-link">《Git》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/ssm/" class="nav-link">《SSM》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/mybatisplus/" class="nav-link">《MybatisPlus》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/reggietakeout/" class="nav-link">《ReggieTakeOut》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/microservice/" class="nav-link">《MicroService》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/xuechengplus/" class="nav-link">《XueChengPlus》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/flume/" class="nav-link">《Flume》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/python/" class="nav-link">《Python》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/scala/" class="nav-link">《Scala》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/linux/" class="nav-link">《Linux》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/hadoop/" class="nav-link">《Hadoop》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/designpatterns/" class="nav-link">《Java设计模式》笔记</a></li><li class="dropdown-subitem"><a href="/vuepress-tion-blog/note/htmlcssweb/" class="nav-link">《HTML-CSS-WEB》笔记</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="页面" class="dropdown-title"><a href="/vuepress-tion-blog/ui/" class="link-title">页面</a> <span class="title" style="display:none;">页面</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/8309a5b876fc95e3/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/0a83b083bdf257cb/" class="nav-link">CSS</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/vuepress-tion-blog/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/9a7ee40fc232253e/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/vuepress-tion-blog/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/pages/baaa02/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/vuepress-tion-blog/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/vuepress-tion-blog/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/vuepress-tion-blog/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/vuepress-tion-blog/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/vuepress-tion-blog/pages/6c93bc/" class="sidebar-link">学成在线项目开发工具配置v1.0</a></li><li><a href="/vuepress-tion-blog/pages/2e1f68/" class="sidebar-link">第1章-项目环境搭建v1.0</a></li><li><a href="/vuepress-tion-blog/pages/e2fb10/" class="sidebar-link">第2章-内容管理</a></li><li><a href="/vuepress-tion-blog/pages/a5a8d0/" class="sidebar-link">第2章-内容管理-实战</a></li><li><a href="/vuepress-tion-blog/pages/02b6b3/" class="sidebar-link">第3章-媒资管理模块</a></li><li><a href="/vuepress-tion-blog/pages/7a3e9f/" aria-current="page" class="active sidebar-link">第4章-课程发布</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/7a3e9f/#_1-1-模块介绍" class="sidebar-link">1.1 模块介绍</a></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/7a3e9f/#_1-2-业务流程" class="sidebar-link">1.2 业务流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_1-2-1-课程预览" class="sidebar-link">1.2.1 课程预览</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_1-2-2-课程审核" class="sidebar-link">1.2.2 课程审核</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_1-2-3-课程发布" class="sidebar-link">1.2.3 课程发布</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/7a3e9f/#_2-1-需求分析" class="sidebar-link">2.1 需求分析</a></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/7a3e9f/#_2-2-模板引擎" class="sidebar-link">2.2 模板引擎</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_2-2-1-什么是模板引擎" class="sidebar-link">2.2.1 什么是模板引擎</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_2-2-2-freemarker快速入门" class="sidebar-link">2.2.2 Freemarker快速入门</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/7a3e9f/#_2-3-测试静态页面" class="sidebar-link">2.3 测试静态页面</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_2-3-1-部署网站门户" class="sidebar-link">2.3.1 部署网站门户</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_2-3-2-课程详情页面" class="sidebar-link">2.3.2 课程详情页面</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_2-3-3-文件服务器" class="sidebar-link">2.3.3 文件服务器</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_2-3-4-视频播放页面" class="sidebar-link">2.3.4 视频播放页面</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/7a3e9f/#_2-4-接口定义" class="sidebar-link">2.4 接口定义</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_2-4-1-定义课程预览接口" class="sidebar-link">2.4.1 定义课程预览接口</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_2-4-2-配置反向代理" class="sidebar-link">2.4.2 配置反向代理</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/7a3e9f/#_2-5-接口开发" class="sidebar-link">2.5 接口开发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_2-5-1-数据模型" class="sidebar-link">2.5.1 数据模型</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_2-5-3-接口层完善" class="sidebar-link">2.5.3 接口层完善</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_2-5-4-前后端联调" class="sidebar-link">2.5.4 前后端联调</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_2-5-5-编写模板" class="sidebar-link">2.5.5 编写模板</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_2-5-6-视频播放页面接口" class="sidebar-link">2.5.6 视频播放页面接口</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/7a3e9f/#_3-1-需求分析" class="sidebar-link">3.1 需求分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_3-1-1-业务流程" class="sidebar-link">3.1.1 业务流程</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_3-1-2-数据模型" class="sidebar-link">3.1.2 数据模型</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/7a3e9f/#_3-2-接口定义" class="sidebar-link">3.2 接口定义</a></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/7a3e9f/#_3-3-接口开发" class="sidebar-link">3.3 接口开发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_3-3-1-dao开发" class="sidebar-link">3.3.1 Dao开发</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_3-3-1-service开发" class="sidebar-link">3.3.1 Service开发</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/7a3e9f/#_3-4-接口完善" class="sidebar-link">3.4 接口完善</a></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/7a3e9f/#_3-5-接口测试" class="sidebar-link">3.5 接口测试</a></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-1-需求分析" class="sidebar-link">4.1 需求分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-1-1-数据模型" class="sidebar-link">4.1.1 数据模型</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-2-分布式事务问题" class="sidebar-link">4.2 分布式事务问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-2-1-什么是分布式事务" class="sidebar-link">4.2.1 什么是分布式事务</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-2-2-什么是cap理论" class="sidebar-link">4.2.2 什么是CAP理论</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-2-3-分布式事务控制方案" class="sidebar-link">4.2.3 分布式事务控制方案</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-2-4-课程发布分布式事务控制" class="sidebar-link">4.2.4 课程发布分布式事务控制</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-3-课程发布接口" class="sidebar-link">4.3 课程发布接口</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-3-1-接口定义" class="sidebar-link">4.3.1 接口定义</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-3-3-接口开发" class="sidebar-link">4.3.3 接口开发</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-3-3-1-dao开发" class="sidebar-link">4.3.3.1 DAO开发</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-3-3-2-service开发" class="sidebar-link">4.3.3.2 Service开发</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-3-3-3-接口完善" class="sidebar-link">4.3.3.3 接口完善</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-3-4-接口测试" class="sidebar-link">4.3.4 接口测试</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-4-消息处理sdk" class="sidebar-link">4.4 消息处理SDK</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-4-1-消息模块技术方案" class="sidebar-link">4.4.1 消息模块技术方案</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-4-2-消息模块sdk测试" class="sidebar-link">4.4.2 消息模块SDK测试</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-4-3-集成消息sdk" class="sidebar-link">4.4.3 集成消息SDK</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-4-3-1-课程发布任务处理" class="sidebar-link">4.4.3.1 课程发布任务处理</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-4-3-2-开启任务调度" class="sidebar-link">4.4.3.2 开启任务调度</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-4-3-3-测试" class="sidebar-link">4.4.3.3 测试</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-5-页面静态化" class="sidebar-link">4.5 页面静态化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-5-1-什么是页面静态化" class="sidebar-link">4.5.1 什么是页面静态化</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-5-2-静态化测试" class="sidebar-link">4.5.2 静态化测试</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-5-3-上传文件测试" class="sidebar-link">4.5.3 上传文件测试</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-5-4-熔断降级处理" class="sidebar-link">4.5.4 熔断降级处理</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-5-4-1-什么是熔断降级" class="sidebar-link">4.5.4.1 什么是熔断降级</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-5-4-2-熔断降级处理" class="sidebar-link">4.5.4.2 熔断降级处理</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-5-4-课程静态化开发" class="sidebar-link">4.5.4 课程静态化开发</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-5-4-1-添加消息" class="sidebar-link">4.5.4.1 添加消息</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-5-4-2-课程静态化实现" class="sidebar-link">4.5.4.2 课程静态化实现</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/7a3e9f/#_4-5-4-3-测试" class="sidebar-link">4.5.4.3 测试</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-1-需求分析" class="sidebar-link">5.1 需求分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-1-1-模块介绍" class="sidebar-link">5.1.1 模块介绍</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-1-2-业务流程" class="sidebar-link">5.1.2 业务流程</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-2-准备环境" class="sidebar-link">5.2 准备环境</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-2-1-搭建elasticsearch" class="sidebar-link">5.2.1 搭建elasticsearch</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-2-3-创建索引" class="sidebar-link">5.2.3 创建索引</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-2-2-部署搜索工程" class="sidebar-link">5.2.2 部署搜索工程</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-3-索引管理" class="sidebar-link">5.3 索引管理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-3-1-rest-api" class="sidebar-link">5.3.1 REST API</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-3-1-1-添加文档" class="sidebar-link">5.3.1.1 添加文档</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-3-1-2-查询文档" class="sidebar-link">5.3.1.2 查询文档</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-3-1-3-更新文档" class="sidebar-link">5.3.1.3 更新文档</a></li><li class="sidebar-sub-header level4"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-3-1-4-删除文档" class="sidebar-link">5.3.1.4 删除文档</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-3-2-接口定义" class="sidebar-link">5.3.2 接口定义</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-3-3-接口开发" class="sidebar-link">5.3.3 接口开发</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-3-4-接口完善" class="sidebar-link">5.3.4 接口完善</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-3-5-接口测试" class="sidebar-link">5.3.5 接口测试</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-4-搜索" class="sidebar-link">5.4 搜索</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-4-1-需求分析" class="sidebar-link">5.4.1 需求分析</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-4-2-接口定义" class="sidebar-link">5.4.2 接口定义</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-4-3-基本功能实现" class="sidebar-link">5.4.3 基本功能实现</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-4-4-基本功能测试" class="sidebar-link">5.4.4 基本功能测试</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-4-5-根据条件搜索" class="sidebar-link">5.4.5 根据条件搜索</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-4-6-条件搜索测试" class="sidebar-link">5.4.6 条件搜索测试</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-4-7-聚合搜索" class="sidebar-link">5.4.7 聚合搜索</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-4-8-聚合搜索测试" class="sidebar-link">5.4.8 聚合搜索测试</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-4-9-高亮设置" class="sidebar-link">5.4.9 高亮设置</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-4-10-高亮设置测试" class="sidebar-link">5.4.10 高亮设置测试</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-5-课程信息索引同步" class="sidebar-link">5.5 课程信息索引同步</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-5-1-技术方案" class="sidebar-link">5.5.1 技术方案</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-5-2-课程索引任务开发" class="sidebar-link">5.5.2 课程索引任务开发</a></li><li class="sidebar-sub-header level3"><a href="/vuepress-tion-blog/pages/7a3e9f/#_5-5-3-测试" class="sidebar-link">5.5.3 测试</a></li></ul></li></ul></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/vuepress-tion-blog/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/vuepress-tion-blog/note/xuechengplus/#《XueChengPlus》笔记" data-v-06225672>《XueChengPlus》笔记</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/onetioner" target="_blank" title="作者" class="beLink" data-v-06225672>onetion</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2025-01-15</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">第4章-课程发布<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="第4章-课程发布"><a href="#第4章-课程发布" class="header-anchor">#</a> 第4章：课程发布</h1> <h1 id="_1-模块需求分析"><a href="#_1-模块需求分析" class="header-anchor">#</a> 1 模块需求分析</h1> <h2 id="_1-1-模块介绍"><a href="#_1-1-模块介绍" class="header-anchor">#</a> 1.1 模块介绍</h2> <p>课程信息编辑完毕即可发布课程，发布课程相当于一个确认操作，课程发布后学习者通过学成在线平台的网站可以搜索到课程，然后查看课程的详细信息，选课、学习。</p> <p>下边是课程编辑与发布的整体流程：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152106493.png" alt="image-20250115210652453"></p> <p>为了课程内容没有违规信息、课程内容安排合理，在课程发布之间平台运营方会进行课程审核，审核通过后课程方可发布。</p> <p>作为课程制作方即教学机构，在课程发布前通过课程预览功能可以看到课程发布后的效果，哪里的课程信息存在问题方便查看，及时修改。</p> <p>下图是课程预览的效果图，也是课程正式发布后的课程详情界面：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152109490.png" alt="image-20250115210945453"></p> <p>教学机构确认课程内容无误，提交审核，平台运营人员对课程内容审核，审核通过后教学机构人员发布课程成功。</p> <p>课程发布模块共包括三块功能：</p> <p>1、课程预览</p> <p>2、课程审核</p> <p>3、课程发布</p> <h2 id="_1-2-业务流程"><a href="#_1-2-业务流程" class="header-anchor">#</a> 1.2 业务流程</h2> <h3 id="_1-2-1-课程预览"><a href="#_1-2-1-课程预览" class="header-anchor">#</a> 1.2.1 课程预览</h3> <p>1.<strong>教育机构用户</strong>在课程管理中可对该机构内所管理的课程进行检索。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152112604.png" alt="image-20250115211258556"></p> <p>2.点击某课程数据后的预览链接，即可对该课程进行预览，可以看到发布后的详情页面效果。</p> <p>下图是课程详情首页，显示了课程的基本。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152113820.png" alt="image-20250115211327776"></p> <p>点击课程目录，显示课程计划，通过此界面去核实课程计划的信息是否存在问题。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152114716.png" alt="image-20250115211403674"></p> <p>点击课程目录中的具体章节，查看视频播放是否正常</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152116600.png" alt="image-20250115211616563"></p> <h3 id="_1-2-2-课程审核"><a href="#_1-2-2-课程审核" class="header-anchor">#</a> 1.2.2 课程审核</h3> <p>教学机构提交课程审核后，平台运营人员登录运营平台查询待审核的记录。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152117465.png" alt="image-20250115211713425"></p> <p>具体审核的过程与课程预览的过程类似，运营人员查看课程信息、课程视频等内容。</p> <p>如果存在问题则审核不通过，并附上审核不通过的原因供教学机构人员查看。</p> <p>如果课程内容没有违规信息且课程内容全面则审核通过。</p> <p>课程审核通过后教学机构发布课程成功。</p> <h3 id="_1-2-3-课程发布"><a href="#_1-2-3-课程发布" class="header-anchor">#</a> 1.2.3 课程发布</h3> <p>1.<strong>教育机构用户</strong>在课程管理中可对机构内课程进行检索。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152120675.png" alt="image-20250115212011598"></p> <p>2.点击某课程数据后的 发布 链接（审核状态为通过），即可对该课程进行发布。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152121119.png" alt="image-20250115212106067"></p> <p>3、课程发布后可通过课程搜索查询到课程信息，并查看课程的详细信息。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152121293.png" alt="image-20250115212134259"></p> <p>4 点击课程搜索页中课程列表的某个课程，可进入课程详情页。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152122672.png" alt="image-20250115212207634"></p> <h1 id="_2-课程预览"><a href="#_2-课程预览" class="header-anchor">#</a> 2 课程预览</h1> <h2 id="_2-1-需求分析"><a href="#_2-1-需求分析" class="header-anchor">#</a> 2.1 需求分析</h2> <p>课程预览就是把课程的相关信息进行整合，在课程详情界面进行展示，通过课程预览页面查看信息是否存在问题。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152122474.png" alt="image-20250115212258426"></p> <p>下图是课程预览的数据来源：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152123223.png" alt="image-20250115212323171"></p> <p>在课程预览页面点击&quot;视频播放图片&quot;打开视频播放页面，通过视频播放页面查看课程计划对应的视频是否存在问题。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152123682.png" alt="image-20250115212354636"></p> <p>课程预览的效果与最终课程发布后查看到的效果是一致的，所以课程预览时会通过网站门户域名地址进行预览，下图显示了整个课程预览的流程图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152124433.png" alt="image-20250115212419376"></p> <p>说明如下：</p> <p>1、点击课程预览，通过Nginx、后台服务网关请求内容管理服务进行课程预览。</p> <p>2、内容管理服务查询课程相关信息进行整合，并通过模板引擎技术在服务端渲染生成页面，返回给浏览器。</p> <p>3、通过课程预览页面点击”马上学习“打开视频播放页面。</p> <p>4、视频播放页面通过Nginx请求后台服务网关，查询课程信息展示课程计划目录，请求媒资管理查询课程计划绑定的视频文件地址，在浏览播放视频。</p> <h2 id="_2-2-模板引擎"><a href="#_2-2-模板引擎" class="header-anchor">#</a> 2.2 模板引擎</h2> <h3 id="_2-2-1-什么是模板引擎"><a href="#_2-2-1-什么是模板引擎" class="header-anchor">#</a> 2.2.1 什么是模板引擎</h3> <p>根据前边的数据模型分析，课程预览就是把课程的相关信息进行整合，在课程预览界面进行展示，课程预览界面与课程发布的课程详情界面一致，保证了教学机构人员发布前看到什么样，发布后也会看到什么样。</p> <p>项目采用模板引擎技术实现课程预览界面。什么是模板引擎？</p> <p>早期我们采用的jsp技术就是一种模板引擎技术，如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152125355.png" alt="image-20250115212522309"></p> <p>1、浏览器请求web服务器</p> <p>2、服务器渲染页面，渲染的过程就是向jsp页面(模板)内填充数据(模型)。</p> <p>3、服务器将渲染生成的页面返回给浏览器。</p> <p>所以模板引擎就是：模板+数据=输出，Jsp页面就是模板，页面中嵌入的jsp标签就是数据，两者相结合输出html网页。</p> <p>常用的java模板引擎还有哪些？</p> <p>Jsp、Freemarker、Thymeleaf 、Velocity 等。</p> <p>本项目采用Freemarker作为模板引擎技术。</p> <p>Freemarker官方地址：http://freemarker.foofun.cn/</p> <p>FreeMarker 是一款 <em>模板引擎</em>： 即一种基于模板和要改变的数据， 并用来生成输出文本(HTML网页，电子邮件，配置文件，源代码等)的通用工具。 它不是面向最终用户的，而是一个Java类库，是一款程序员可以嵌入他们所开发产品的组件。FreeMarker 是 <a href="http://www.fsf.org/philosophy/free-sw.html" target="_blank" rel="noopener noreferrer">免费的<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>， 基于Apache许可证2.0版本发布。</p> <h3 id="_2-2-2-freemarker快速入门"><a href="#_2-2-2-freemarker快速入门" class="header-anchor">#</a> 2.2.2 Freemarker快速入门</h3> <p>下边在内容管理接口层搭建Freemarker的运行环境并进行测试。</p> <p>在内容管理接口工层 添加Freemarker与SpringBoot的整合包</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- Spring Boot 对结果视图 Freemarker 集成 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-freemarker<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在nacos为内容管理接口层配置freemarker，新加一个freemarker-config-dev.yaml</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152126933.png" alt="image-20250115212634885"></p> <p>配置信息如下：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">freemarker</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">cache</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>   <span class="token comment">#关闭模板缓存，方便测试</span>
    <span class="token key atrule">settings</span><span class="token punctuation">:</span>
      <span class="token key atrule">template_update_delay</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">suffix</span><span class="token punctuation">:</span> .ftl   <span class="token comment">#页面模板后缀名</span>
    <span class="token key atrule">charset</span><span class="token punctuation">:</span> UTF<span class="token punctuation">-</span><span class="token number">8</span>
    <span class="token key atrule">template-loader-path</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>/templates/   <span class="token comment">#页面模板位置(默认为 classpath:/templates/)</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">add-mappings</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>   <span class="token comment">#关闭项目中的静态资源映射(static、resources文件夹下的资源)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>在内容管理接口工程添加freemarker-config-dev.yaml</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152127340.png" alt="image-20250115212731289"></p> <p>添加模板，在resources下创建templates目录，添加test.ftl模板文件</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>utf-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Hello World!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
Hello ${name}!
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>编写controller方法，准备模型数据</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>api</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>bouncycastle<span class="token punctuation">.</span>math<span class="token punctuation">.</span>raw<span class="token punctuation">.</span></span><span class="token class-name">Mod</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Controller</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ModelAndView</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author Mr.M
 * @version 1.0
 * @description freemarker测试
 * @date 2022/9/15 19:20
 */</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FreemarkerController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/testfreemarker&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ModelAndView</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">ModelAndView</span> modelAndView <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModelAndView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置模型数据</span>
        modelAndView<span class="token punctuation">.</span><span class="token function">addObject</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;小明&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置模板名称</span>
        modelAndView<span class="token punctuation">.</span><span class="token function">setViewName</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> modelAndView<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>启动内容管理接口工程，访问http://localhost:63040/content/testfreemarker</p> <p>屏幕输出：Hello 小明！</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152128057.png" alt="image-20250115212849000"></p> <p>freemarker提供很多指令用于解析各种类型的数据模型，参考地址：http://freemarker.foofun.cn/ref_directives.html</p> <h2 id="_2-3-测试静态页面"><a href="#_2-3-测试静态页面" class="header-anchor">#</a> 2.3 测试静态页面</h2> <h3 id="_2-3-1-部署网站门户"><a href="#_2-3-1-部署网站门户" class="header-anchor">#</a> 2.3.1 部署网站门户</h3> <p>在课程预览界面上要加载css、js、图片等内容，这里部署nginx来访问这些静态资源，对于SpringBoot服务的动态资源由Nginx去代理请求，如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152129456.png" alt="image-20250115212935398"></p> <p>Linux中  /usr/local/nginx</p> <p>这里直接使用mac中brew安装的nginx吧</p> <p>1、在本机安装 Nginx ，从课程资料目录获取nginx-1.23.1.zip并解压。</p> <p>2、运行nginx-1.23.1目录下的nginx.exe。</p> <p>默认端口为80，如果本机80端口被占用，则需要杀掉占用进程后再启动nginx。</p> <p>如果无法杀掉80端口占用进程则需要修改nginx-1.23.1目录下conf/nginx.conf配置文件</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152130473.png" alt="image-20250115213012412"></p> <p>将80端口修改为空闲端口。</p> <p>启动nginx，访问http://localhost 出现下边的网页表示启动成功</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152130312.png" alt="image-20250115213033262"></p> <p>下边开始部署前端工程：</p> <p>1、从课程资料目录获取xc-ui-pc-static-portal.zip 并解压。</p> <p>2、修改本机hosts文件，加入127.0.0.1 www.xuecheng-plus.com。</p> <p>window10操作系统hosts文件在C:\Windows\System32\drivers\etc下</p> <p>Centos7操作系统的hosts文件在/etc目录下。</p> <p>在hosts文件加入如下配置</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// 应该是直接在ip后面添加即可，多个可能是没有生效
127.0.0.1 www.xuecheng-plus.com file.xuecheng-plus.com ucenter.xuecheng-plus.com teacher.xuecheng-plus.com
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>3、在nginx-1.23.1目录中找到conf目录，配置目录下的nginx.conf文件。</p> <p>配置内容如下：</p> <p>/Users/onesion/Desktop/DeskOnesion/ComputerFiles/Code/xc-ui-pc-static-portal</p> <p>/Users/onesion/Desktop/DeskOnesion/Practice/10_XueCheng/xc-ui-pc-static-portal</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
        listen       80;
        server_name  www.xuecheng-plus.com localhost;
        #rewrite ^(.*) https://$server_name$1 permanent;
        #charset koi8-r;
        ssi on;
        ssi_silent_errors on;
        #access_log  logs/host.access.log  main;

        location / {
            alias   D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal/;
            index  index.html index.htm;
        }
        #静态资源
        location /static/img/ {  
                alias  D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal/img/;
        } 
        location /static/css/ {  
                alias   D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal/css/;
        } 
        location /static/js/ {  
                alias   D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal/js/;
        } 
        location /static/plugins/ {  
                alias   D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal/plugins/;
                add_header Access-Control-Allow-Origin http://ucenter.xuecheng-plus.com;  
                add_header Access-Control-Allow-Credentials true;  
                add_header Access-Control-Allow-Methods GET;
        } 
        location /plugins/ {  
                alias   D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal/plugins/;
        } 



        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

        # proxy the PHP scripts to Apache listening on 127.0.0.1:80
        #
        #location ~ \.php$ {
        #    proxy_pass   http://127.0.0.1;
        #}

        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
        #
        #location ~ \.php$ {
        #    root           html;
        #    fastcgi_pass   127.0.0.1:9000;
        #    fastcgi_index  index.php;
        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
        #    include        fastcgi_params;
        #}

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        #location ~ /\.ht {
        #    deny  all;
        #}
    }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><p>启动nginx:</p> <p>进入任务管理器，杀死nginx的两个进程</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152132157.png" alt="image-20250115213210104"></p> <p>杀死后再次双击nginx.exe。</p> <p>启动成功在任务管理器会出现nginx的进程。</p> <p>日志文件在nginx安装目录下的logs目录：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152132381.png" alt="image-20250115213231325"></p> <p>启动成功访问http://www.xuecheng-plus.com</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152132982.png" alt="image-20250115213254928"></p> <h3 id="_2-3-2-课程详情页面"><a href="#_2-3-2-课程详情页面" class="header-anchor">#</a> 2.3.2 课程详情页面</h3> <p>course_template.html是一个静态html页面，里边还没有添加freemarker标签，如果要预览该页面需要借助Nginx进行预览，因为页面需要加载一些css样式表、图片等内容。</p> <p>course_template.html文件在xc-ui-pc-static-portal\course目录下</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152133367.png" alt="image-20250115213329305"></p> <p>通过浏览器访问：http://www.xuecheng-plus.com/course/course_template.html</p> <p>效果如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152133836.png" alt="image-20250115213349780"></p> <p>出现这个画面说明模板文件正常浏览是没有问题的。</p> <h3 id="_2-3-3-文件服务器"><a href="#_2-3-3-文件服务器" class="header-anchor">#</a> 2.3.3 文件服务器</h3> <p>在进行课程预览时需要展示课程的图片，在线插放课程视频，课程图片、视频这些都在MinIO文件系统存储，下边统一由Nginx代理，通过文件服务域名统一访问。如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152134189.png" alt="image-20250115213427136"></p> <p>在hosts文件配置如下内容，如果已存在不要重复配置。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>127.0.0.1 www.xuecheng-plus.com file.xuecheng-plus.com
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在nginx.conf中配置文件服务器的代理地址</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#文件服务
  upstream fileserver{
    server 192.168.101.65:9000 weight=10;
  } 
   server {
        listen       80;
        server_name  file.xuecheng-plus.com;
        #charset koi8-r;
        ssi on;
        ssi_silent_errors on;
        #access_log  logs/host.access.log  main;
        location /video {
            proxy_pass   http://fileserver;
        }

        location /mediafiles {
            proxy_pass   http://fileserver;
        }
   }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>配置完毕，重新加载nginx配置文件。</p> <p>通过cmd进入nginx.exe所在目录,运行如下命令</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>nginx.exe -s reload
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>通过http://file.xuecheng-plus.com/video/视频文件地址 访问视频</p> <p>通过http://file.xuecheng-plus.com/mediafiles/图片文件地址 访问图片</p> <p>在媒资数据库的文件表中找一个视频、图片的地址进行测试。</p> <h3 id="_2-3-4-视频播放页面"><a href="#_2-3-4-视频播放页面" class="header-anchor">#</a> 2.3.4 视频播放页面</h3> <p>进入课程详情页面，点击马上学习或课程目录下的小节的名称将打开视频播放页面。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152136894.png" alt="image-20250115213606839"></p> <p>首先在nginx.conf中配置视频播放页面的地址</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>        location /course/preview/learning.html {
                alias D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal/course/learning.html;
        } 
        location /course/search.html {  
                root   D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal;
        } 
        location /course/learning.html {  
                root   D:/itcast2022/xc_edu3.0/code_1/xc-ui-pc-static-portal;
        } 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>加载nginx配置文件</p> <p>点击课程详情页面上的视频播放链接，打开视频播放页面，如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152137458.png" alt="image-20250115213701405"></p> <p>下边需要配置视频播放路径来测试视频播放页面，找到页面中videoObject对象的定义处，配置视频的播放地址</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152137022.png" alt="image-20250115213729967"></p> <p>配置完成，刷新页面，观察视频是否可以正常播放。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152137997.png" alt="image-20250115213752929"></p> <p>注意：此页面会去请求后台接口获取课程计划，这里暂时不处理，稍后在接口开发处进行处理。只要页面可以正常打开，可以播放视频就测试通过了。</p> <h2 id="_2-4-接口定义"><a href="#_2-4-接口定义" class="header-anchor">#</a> 2.4 接口定义</h2> <h3 id="_2-4-1-定义课程预览接口"><a href="#_2-4-1-定义课程预览接口" class="header-anchor">#</a> 2.4.1 定义课程预览接口</h3> <p>课程预览接口要将课程信息进行整合，在服务端渲染页面后返回浏览器。</p> <p>下边对课程预览接口进行分析：</p> <p>1、请求参数</p> <p>传入课程id，表示要预览哪一门课程。</p> <p>2、响应结果</p> <p>输出课程详情页面到浏览器。</p> <p>响应页面到浏览器使用freemarker模板引擎技术实现，首先从课程资料目录下获取课程预览页面course_template.html，拷贝至内容管理的接口工程的resources/templates下，并将其在本目录复制一份命名为course_template.ftl</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152145634.png" alt="image-20250115213849417"></p> <p>下边开始定义接口：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>api</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">CoursePreviewDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">CoursePublishService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Controller</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ModelAndView</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @description 课程预览，发布
 * @author Mr.M
 * @date 2022/9/16 14:48
 * @version 1.0
 */</span>
 <span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CoursePublishController</span> <span class="token punctuation">{</span>


 <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/coursepreview/{courseId}&quot;</span><span class="token punctuation">)</span>
 <span class="token keyword">public</span> <span class="token class-name">ModelAndView</span> <span class="token function">preview</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;courseId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>

      <span class="token class-name">ModelAndView</span> modelAndView <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModelAndView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      modelAndView<span class="token punctuation">.</span><span class="token function">addObject</span><span class="token punctuation">(</span><span class="token string">&quot;model&quot;</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      modelAndView<span class="token punctuation">.</span><span class="token function">setViewName</span><span class="token punctuation">(</span><span class="token string">&quot;course_template&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> modelAndView<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>重启内容管理接口工程，访问http://localhost:63040/content/coursepreview/74</p> <p>如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152139706.png" alt="image-20250115213934648"></p> <p>课程预览页面内容没有样式，稍后解决这个问题。</p> <h3 id="_2-4-2-配置反向代理"><a href="#_2-4-2-配置反向代理" class="header-anchor">#</a> 2.4.2 配置反向代理</h3> <p>课程预览接口虽然可以正常访问，但是页面没有样式，查看浏览器请求记录，发现图片、样式无法正常访问。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152140173.png" alt="image-20250115214017116"></p> <p>这些静态资源全在门户下，我们需要由Nginx反向代理访问课程预览接口，通过门户的URL去访问课程预览。</p> <p>在Nginx下配置：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#后台网关
  upstream gatewayserver{
    server 127.0.0.1:63010 weight=10;    } 
  server {
        listen       80;
        server_name  www.xuecheng-plus.com localhost;
        ....
        #api
        location /api/ {
                proxy_pass http://gatewayserver/;
        } 
        ....
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>重新加载Nginx配置文件：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>nginx<span class="token punctuation">.</span>exe <span class="token operator">-</span>s reload
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>此时访问新地址： http://www.xuecheng-plus.com/api/content/coursepreview/74</p> <p>输出如下，页面样式正常。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152141111.png" alt="image-20250115214124042"></p> <p>页面虽然正常，但是里边的内容都是静态内容，稍后接口层调用service方式获取模型数据并进行页面渲染。</p> <h2 id="_2-5-接口开发"><a href="#_2-5-接口开发" class="header-anchor">#</a> 2.5 接口开发</h2> <h3 id="_2-5-1-数据模型"><a href="#_2-5-1-数据模型" class="header-anchor">#</a> 2.5.1 数据模型</h3> <p>课程预览就是把课程基本信息、营销信息、课程计划、师资等课程的相关信息进行整合，在预览页面进行展示。如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152142875.png" alt="image-20250115214211810"></p> <p>在使用freemarker渲染生成视图时需要数据模型，此数据模型包括了基本信息、营销信息、课程计划、师资等信息。</p> <p>所以首先定义一个数据模型类：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">ToString</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @description 课程预览数据模型
 * @author Mr.M
 * @date 2022/9/16 15:03
 * @version 1.0
 */</span>
 <span class="token annotation punctuation">@Data</span>
 <span class="token annotation punctuation">@ToString</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CoursePreviewDto</span> <span class="token punctuation">{</span>

    <span class="token comment">//课程基本信息,课程营销信息</span>
    <span class="token class-name">CourseBaseInfoDto</span> courseBase<span class="token punctuation">;</span>


    <span class="token comment">//课程计划信息</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TeachplanDto</span><span class="token punctuation">&gt;</span></span> teachplans<span class="token punctuation">;</span>
    
    <span class="token comment">//师资信息暂时不加...</span>


<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>CourseBaseInfoDto：包括了课程基本信息、营销信息。

List&lt;TeachplanDto&gt; ：包括了课程计划列表。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>2.5.2 Service****接口</strong></p> <p>Service负责从数据库查询基本信息、营销信息、课程计划等课程相关信息，组成CoursePreviewDto 对象。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">CoursePreviewDto</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @description 课程预览、发布接口
 * @author Mr.M
 * @date 2022/9/16 14:59
 * @version 1.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CoursePublishService</span> <span class="token punctuation">{</span>


 <span class="token comment">/**
  * @description 获取课程预览信息
  * @param courseId 课程id
  * @return com.xuecheng.content.model.dto.CoursePreviewDto
  * @author Mr.M
  * @date 2022/9/16 15:36
 */</span>
   <span class="token keyword">public</span> <span class="token class-name">CoursePreviewDto</span> <span class="token function">getCoursePreviewInfo</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>接口实现如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">CourseBaseInfoDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">CoursePreviewDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">TeachplanTreeDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">CourseBaseInfoService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">CoursePublishService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">TeachplanService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @description TODO
 * @author Mr.M
 * @date 2022/9/16 15:37
 * @version 1.0
 */</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CoursePublishServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">CoursePublishService</span> <span class="token punctuation">{</span>

 <span class="token annotation punctuation">@Autowired</span>
 <span class="token class-name">CourseBaseInfoService</span> courseBaseInfoService<span class="token punctuation">;</span>

 <span class="token annotation punctuation">@Autowired</span>
 <span class="token class-name">TeachplanService</span> teachplanService<span class="token punctuation">;</span>


 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">CoursePreviewDto</span> <span class="token function">getCoursePreviewInfo</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">//课程基本信息、营销信息</span>
  <span class="token class-name">CourseBaseInfoDto</span> courseBaseInfo <span class="token operator">=</span> courseBaseInfoService<span class="token punctuation">.</span><span class="token function">getCourseBaseInfo</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//课程计划信息</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TeachplanDto</span><span class="token punctuation">&gt;</span></span> teachplanTree<span class="token operator">=</span> teachplanService<span class="token punctuation">.</span><span class="token function">findTeachplanTree</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">CoursePreviewDto</span> coursePreviewDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CoursePreviewDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  coursePreviewDto<span class="token punctuation">.</span><span class="token function">setCourseBase</span><span class="token punctuation">(</span>courseBaseInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  coursePreviewDto<span class="token punctuation">.</span><span class="token function">setTeachplans</span><span class="token punctuation">(</span>teachplanTree<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> coursePreviewDto<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h3 id="_2-5-3-接口层完善"><a href="#_2-5-3-接口层完善" class="header-anchor">#</a> 2.5.3 接口层完善</h3> <p>接口层Controller调用Service方法获取模板引擎需要的模型数据</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Autowired
   CoursePublishService coursePublishService;


@GetMapping(&quot;/coursepreview/{courseId}&quot;)
public ModelAndView preview(@PathVariable(&quot;courseId&quot;) Long courseId){

     //获取课程预览信息
     CoursePreviewDto coursePreviewInfo = coursePublishService.getCoursePreviewInfo(courseId);

     ModelAndView modelAndView = new ModelAndView();
     modelAndView.addObject(&quot;model&quot;,coursePreviewInfo);
     modelAndView.setViewName(&quot;course_template&quot;);
  return modelAndView;
 }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>课程预览接口编写完成，下边进行调试，一边调试一边编写模板页面。</p> <h3 id="_2-5-4-前后端联调"><a href="#_2-5-4-前后端联调" class="header-anchor">#</a> 2.5.4 前后端联调</h3> <p>目前是通过Nginx访问门户，Nginx是整个的项目最前方的代理服务器，如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152145547.png" alt="image-20250115214540483"></p> <p>原来前端直接指向后台网关地址，现在要更改为Nginx的地址，如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152146510.png" alt="image-20250115214624439"></p> <p>重启前端工程，进入课程列表点击&quot;预览&quot;按钮，正常打开课程预览页面http://www.xuecheng-plus.com/api/content/coursepreview/2</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152146220.png" alt="image-20250115214648157"></p> <h3 id="_2-5-5-编写模板"><a href="#_2-5-5-编写模板" class="header-anchor">#</a> 2.5.5 编写模板</h3> <p>模型数据准备好后下一步将模型数据填充到course_template.ftl上。</p> <p>填充时注意不要一定填充太多，一边填充一边刷新调试。</p> <p>freemarker提供很多指令用于解析各种类型的数据模型，参考地址：http://freemarker.foofun.cn/ref_directives.html</p> <p>修改模板后需要编译，如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152147211.png" alt="image-20250115214718146"></p> <p>在调试模板时，可以看出哪些信息有缺少，在课程管理处进行补充，比如下图显示课程计划信息不完整，需要进入课程计划界面添加课程计划。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152147696.png" alt="image-20250115214737627"></p> <p>完整的course_template.ftl模板在课程目录下，差不多学会了freemarker标签的使用方法，将课程资料下的course_template.ftl覆盖自己的工程下的course_template.ftl。</p> <h3 id="_2-5-6-视频播放页面接口"><a href="#_2-5-6-视频播放页面接口" class="header-anchor">#</a> 2.5.6 视频播放页面接口</h3> <p>从课程详情页面进入视频播放页面，在此页面需要从后台获取课程计划、根据课程计划获取对应的视频地址，这两个接口在前边的模块中已经完成，现在需要确认接口并进行测试。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152148416.png" alt="image-20250115214818344"></p> <p>获取课程计划接口：/open/content/course/whole/{courseId}</p> <p>根据课程计划获取视频地址接口：/open/media/preview/{mediaId}</p> <p>1、在nginx配置如下地址</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>        <span class="token comment">#openapi</span>
        location /open/content/ <span class="token punctuation">{</span>
                proxy_pass http://gatewayserver/content/open/<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
        location /open/media/ <span class="token punctuation">{</span>
                proxy_pass http://gatewayserver/media/open/<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>2、在内容管理接口层定义CourseOpenController类，并定义接口：获取课程计划接口：/open/content/course/whole/{courseId}</p> <p>代码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;课程公开查询接口&quot;</span><span class="token punctuation">,</span>tags <span class="token operator">=</span> <span class="token string">&quot;课程公开查询接口&quot;</span><span class="token punctuation">)</span>
 <span class="token annotation punctuation">@RestController</span>
 <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/open&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CourseOpenController</span> <span class="token punctuation">{</span>

 <span class="token annotation punctuation">@Autowired</span>
 <span class="token keyword">private</span> <span class="token class-name">CourseBaseInfoService</span> courseBaseInfoService<span class="token punctuation">;</span>

 <span class="token annotation punctuation">@Autowired</span>
 <span class="token keyword">private</span> <span class="token class-name">CoursePublishService</span> coursePublishService<span class="token punctuation">;</span>


<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/course/whole/{courseId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">CoursePreviewDto</span> <span class="token function">getPreviewInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;courseId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取课程预览信息</span>
    <span class="token class-name">CoursePreviewDto</span> coursePreviewInfo <span class="token operator">=</span> coursePublishService<span class="token punctuation">.</span><span class="token function">getCoursePreviewInfo</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> coursePreviewInfo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>3、在媒资管理服务media-api工程定义MediaOpenController类，并定义接口/open/media/preview/</p> <p>代码如下：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>@Api<span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;媒资文件管理接口&quot;</span>,tags <span class="token operator">=</span> <span class="token string">&quot;媒资文件管理接口&quot;</span><span class="token punctuation">)</span>
 @RestController
 @RequestMapping<span class="token punctuation">(</span><span class="token string">&quot;/open&quot;</span><span class="token punctuation">)</span>
public class MediaOpenController <span class="token punctuation">{</span>

  @Autowired
  MediaFileService mediaFileService<span class="token punctuation">;</span>

    @ApiOperation<span class="token punctuation">(</span><span class="token string">&quot;预览文件&quot;</span><span class="token punctuation">)</span>
    @GetMapping<span class="token punctuation">(</span><span class="token string">&quot;/preview/{mediaId}&quot;</span><span class="token punctuation">)</span>
    public RestResponse<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> getPlayUrlByMediaId<span class="token punctuation">(</span>@PathVariable String mediaId<span class="token punctuation">)</span><span class="token punctuation">{</span>

        MediaFiles mediaFiles <span class="token operator">=</span> mediaFileService.getFileById<span class="token punctuation">(</span>mediaId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        if<span class="token punctuation">(</span>mediaFiles <span class="token operator">==</span> null <span class="token operator">||</span> StringUtils.isEmpty<span class="token punctuation">(</span>mediaFiles.getUrl<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            XueChengPlusException.cast<span class="token punctuation">(</span><span class="token string">&quot;视频还没有转码处理&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token builtin class-name">return</span> RestResponse.success<span class="token punctuation">(</span>mediaFiles.getUrl<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>5、测试</p> <p>定义好后，启动内容管理、媒资管理、后台服务网关服务，测试视频播放页面是否可以正常获取课程计划，点击具体的课程计划是否正常可以播放视频。</p> <h1 id="_3-课程审核"><a href="#_3-课程审核" class="header-anchor">#</a> 3 课程审核</h1> <h2 id="_3-1-需求分析"><a href="#_3-1-需求分析" class="header-anchor">#</a> 3.1 需求分析</h2> <h3 id="_3-1-1-业务流程"><a href="#_3-1-1-业务流程" class="header-anchor">#</a> 3.1.1 业务流程</h3> <p>根据模块需求分析，课程发布前要先审核，审核通过方可发布。下图是课程审核及发布的流程图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152150831.png" alt="image-20250115215034758"></p> <p>为什么要课程审核通过才可以发布呢？</p> <p>这样做为了防止课程信息有违规情况，课程信息不完善对网站用户体验也不好，课程审核不仅起到监督作用，也是帮助教学机构规范使用平台的手段。</p> <p>如何控制课程审核通过才可以发布课程呢？</p> <p>在课程基本表course_base表设置课程审核状态字段，包括：未提交、已提交(未审核)、审核通过、审核不通过。</p> <p>下边是课程状态的转化关系：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152151843.png" alt="image-20250115215104774"></p> <p>说明如下：</p> <p>1、一门课程新增后它的审核状为”未提交“，发布状态为”未发布“。</p> <p>2、课程信息编辑完成，教学机构人员执行”提交审核“操作。此时课程的审核状态为”已提交“。</p> <p>3、当课程状态为已提交时运营平台人员对课程进行审核。</p> <p>4、运营平台人员审核课程，结果有两个：审核通过、审核不通过。</p> <p>5、课程审核过后不管状态是通过还是不通过，教学机构可以再次修改课程并提交审核，此时课程状态为”已提交“。此时运营平台人员再次审核课程。</p> <p>6、课程审核通过，教学机构人员可以发布课程，发布成功后课程的发布状态为”已发布“。</p> <p>7、课程发布后通过”下架“操作可以更改课程发布状态为”下架“</p> <p>8、课程下架后通过”上架“操作可以再次发布课程，上架后课程发布状态为“发布”。</p> <h3 id="_3-1-2-数据模型"><a href="#_3-1-2-数据模型" class="header-anchor">#</a> 3.1.2 数据模型</h3> <p>通过业务流程的分析，现在我们思考：</p> <p>1、课程提交审核后还允许修改课程吗？</p> <p>如果不允许修改是不合理的，因为提交审核后可以继续做下一个阶段的课程内容，比如添加课程计划，上传课程视频等。</p> <p>如果允许修改那么课程审核时看到的课程内容从哪里来？如果也从课程基本信息表、课程营销表、课程计划表查询那么存在什么问题呢？如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152151748.png" alt="image-20250115215148676"></p> <p>运营人员审核课程和教学机构编辑课程操作的数据是同一份，此时会导致冲突。比如：运营人员正在审核时教学机构把数据修改了。</p> <p>为了解决这个问题，专门设计课程预发布表。</p> <p>如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152152369.png" alt="image-20250115215213290"></p> <p>提交课程审核，将课程信息汇总后写入课程预发布表，课程预发布表记录了教学机构在某个时间点要发布的课程信息。</p> <p>课程审核人员从预发布表查询信息进行审核。</p> <p>课程审核的同时可以对课程进行修改，修改的内容不会写入课程预发布表。</p> <p>课程审核通过执行课程发布，将课程预发布表的信息写入课程发布表。</p> <p>2、提交审核课程后，也修改了课程信息，可以再次提交审核吗？</p> <p>这个问题在上边分析课程审核状态时已经有了答案，如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152152700.png" alt="image-20250115215236624"></p> <p>提交审核课程后，必须等到课程审核完成才可以再次提交课程。</p> <p>课程审核功能涉及教学机构提交审核，运营人员进行课程审核。在课堂上我们仅实现教学机构提交审核功能，课程审核的结果通过手动修改数据库来实现。</p> <p>虽然课堂上不实现课程审核功能，完整的课程审核数据表设计需要理解。</p> <p>提交审核将信息写入课程预发布表，课程预发布表结构如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152153034.png" alt="image-20250115215300965"></p> <p>更新课程基本信息表的课程审核状态为：已经提交</p> <p>课程审核后更新课程基本信息表的审核状态、课程预发布表的审核状态，并将审核结果写入课程审核记录。</p> <p>审核记录表结构如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152153285.png" alt="image-20250115215323210"></p> <h2 id="_3-2-接口定义"><a href="#_3-2-接口定义" class="header-anchor">#</a> 3.2 接口定义</h2> <p>下边定义提交课程审核的接口，在课程发布Controller中定义接口如下：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code> @ResponseBody
@PostMapping (&quot;/courseaudit/commit/{courseId}&quot;)
public void commitAudit(@PathVariable(&quot;courseId&quot;) Long courseId){

 }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="_3-3-接口开发"><a href="#_3-3-接口开发" class="header-anchor">#</a> 3.3 接口开发</h2> <h3 id="_3-3-1-dao开发"><a href="#_3-3-1-dao开发" class="header-anchor">#</a> 3.3.1 Dao开发</h3> <p>1、查询课程基本信息、课程营销信息、课程计划信息等课程相关信息，整合为课程预发布信息。</p> <p>2、向课程预发布表course_publish_pre插入一条记录，如果已经存在则更新，审核状态为：已提交。</p> <p>3、更新课程基本表course_base课程审核状态为：已提交。</p> <p>约束：</p> <p>1、未提交或审核完成后方可提交审核。</p> <p>2、本机构只允许提交本机构的课程。</p> <p>3、没有上传图片不允许提交审核。</p> <p>4、没有添加课程计划不允许提交审核。</p> <p>使用代码生成器生成课程发布表、课程预发布表的PO、Mpper，并拷贝到相应的工程下。</p> <h3 id="_3-3-1-service开发"><a href="#_3-3-1-service开发" class="header-anchor">#</a> 3.3.1 Service开发</h3> <p>在课程发布Service类中定义接口如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @description 提交审核
 * @param courseId  课程id
 * @return void
 * @author Mr.M
 * @date 2022/9/18 10:31
*/</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commitAudit</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>接口实现如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commitAudit</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">{</span>

 <span class="token comment">//约束校验</span>
 <span class="token class-name">CourseBase</span> courseBase <span class="token operator">=</span> courseBaseMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//课程审核状态</span>
 <span class="token class-name">String</span> auditStatus <span class="token operator">=</span> courseBase<span class="token punctuation">.</span><span class="token function">getAuditStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//当前审核状态为已提交不允许再次提交</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">&quot;202003&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>auditStatus<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;当前为等待审核状态，审核完成可以再次提交。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">//本机构只允许提交本机构的课程</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>courseBase<span class="token punctuation">.</span><span class="token function">getCompanyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>companyId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;不允许提交其它机构的课程。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token comment">//课程图片是否填写</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>courseBase<span class="token punctuation">.</span><span class="token function">getPic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;提交失败，请上传课程图片&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token comment">//添加课程预发布记录</span>
 <span class="token class-name">CoursePublishPre</span> coursePublishPre <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CoursePublishPre</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//课程基本信息加部分营销信息</span>
 <span class="token class-name">CourseBaseInfoDto</span> courseBaseInfo <span class="token operator">=</span> courseBaseInfoService<span class="token punctuation">.</span><span class="token function">getCourseBaseInfo</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>courseBaseInfo<span class="token punctuation">,</span>coursePublishPre<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//课程营销信息</span>
 <span class="token class-name">CourseMarket</span> courseMarket <span class="token operator">=</span> courseMarketMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//转为json</span>
 <span class="token class-name">String</span> courseMarketJson <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>courseMarket<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//将课程营销信息json数据放入课程预发布表</span>
 coursePublishPre<span class="token punctuation">.</span><span class="token function">setMarket</span><span class="token punctuation">(</span>courseMarketJson<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">//查询课程计划信息</span>
 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TeachplanDto</span><span class="token punctuation">&gt;</span></span> teachplanTree <span class="token operator">=</span> teachplanService<span class="token punctuation">.</span><span class="token function">findTeachplanTree</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>teachplanTree<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;提交失败，还没有添加课程计划&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">//转json</span>
 <span class="token class-name">String</span> teachplanTreeString <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>teachplanTree<span class="token punctuation">)</span><span class="token punctuation">;</span>
 coursePublishPre<span class="token punctuation">.</span><span class="token function">setTeachplan</span><span class="token punctuation">(</span>teachplanTreeString<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">//设置预发布记录状态,已提交</span>
 coursePublishPre<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;202003&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//教学机构id</span>
 coursePublishPre<span class="token punctuation">.</span><span class="token function">setCompanyId</span><span class="token punctuation">(</span>companyId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//提交时间</span>
 coursePublishPre<span class="token punctuation">.</span><span class="token function">setCreateDate</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">CoursePublishPre</span> coursePublishPreUpdate <span class="token operator">=</span> coursePublishPreMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>coursePublishPreUpdate <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">//添加课程预发布记录</span>
  coursePublishPreMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>coursePublishPre<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
  coursePublishPreMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>coursePublishPre<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token comment">//更新课程基本表的审核状态</span>
 courseBase<span class="token punctuation">.</span><span class="token function">setAuditStatus</span><span class="token punctuation">(</span><span class="token string">&quot;202003&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 courseBaseMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>courseBase<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><h2 id="_3-4-接口完善"><a href="#_3-4-接口完善" class="header-anchor">#</a> 3.4 接口完善</h2> <p>完善接口层的代码</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code> <span class="token annotation punctuation">@ResponseBody</span>
<span class="token annotation punctuation">@PostMapping</span> <span class="token punctuation">(</span><span class="token string">&quot;/courseaudit/commit/{courseId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commitAudit</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;courseId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token class-name">Long</span> companyId <span class="token operator">=</span> <span class="token number">1232141425L</span><span class="token punctuation">;</span>
     coursePublishService<span class="token punctuation">.</span><span class="token function">commitAudit</span><span class="token punctuation">(</span>companyId<span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="_3-5-接口测试"><a href="#_3-5-接口测试" class="header-anchor">#</a> 3.5 接口测试</h2> <p>直接使用前端去测试。</p> <p>1、找一门信息不全的课程，测试各各约束条件。</p> <p>2、正常提交后，观察数据库中课程预发布表记录的内容是否完整。</p> <p>3、测试审核过后再次提交，提交后观察数据库中课程预发布表记录的内容是否正确。</p> <h1 id="_4-课程发布"><a href="#_4-课程发布" class="header-anchor">#</a> 4 课程发布</h1> <h2 id="_4-1-需求分析"><a href="#_4-1-需求分析" class="header-anchor">#</a> 4.1 需求分析</h2> <h3 id="_4-1-1-数据模型"><a href="#_4-1-1-数据模型" class="header-anchor">#</a> 4.1.1 数据模型</h3> <p>教学机构人员在课程审核通过后即可发布课程，课程发布后会公开展示在网站上供学生查看、选课和学习。</p> <p>在网站上展示课程信息需要解决课程信息显示的性能问题，如果速度慢(排除网速)会影响用户的体验性。</p> <p>如何去快速搜索课程？</p> <p>打开课程详情页面仍然去查询数据库可行吗？</p> <p>为了提高网站的速度需要将课程信息进行缓存，并且要将课程信息加入索引库方便搜索，下图显示了课程发布后课程信息的流转情况：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152156921.png" alt="image-20250115215650836"></p> <p>1、向内容管理数据库的课程发布表存储课程发布信息。</p> <p>2、向Redis存储课程缓存信息。</p> <p>3、向Elasticsearch存储课程索引信息。</p> <p>4、请求分布文件系统存储课程静态化页面(即html页面)，实现快速浏览课程详情页面。</p> <p>课程发布表的数据来源于课程预发布表，它们的结构基本一样，只是课程发布表中的状态是课程发布状态，如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152157156.png" alt="image-20250115215722079"></p> <p>redis中的课程缓存信息是将课程发布表中的数据转为json进行存储。</p> <p>elasticsearch中的课程索引信息是根据搜索需要将课程名称、课程介绍等信息进行索引存储。</p> <p>MinIO中存储了课程的静态化页面文件（html网页），查看课程详情是通过文件系统去浏览课程详情页面。</p> <h2 id="_4-2-分布式事务问题"><a href="#_4-2-分布式事务问题" class="header-anchor">#</a> 4.2 分布式事务问题</h2> <h3 id="_4-2-1-什么是分布式事务"><a href="#_4-2-1-什么是分布式事务" class="header-anchor">#</a> 4.2.1 什么是分布式事务</h3> <p>一次课程发布操作需要向数据库、redis、elasticsearch、MinIO写四份数据，这里存在分布式事务问题。</p> <p>什么是分布式事务？</p> <p>首先理解什么是本地事务？</p> <p>平常我们在程序中通过spring去控制事务是利用数据库本身的事务特性来实现的，因此叫数据库事务，由于应用主要靠关系数据库来控制事务，而数据库通常和应用在同一个服务器，所以基于关系型数据库的事务又被称为本地事务。</p> <p>本地事务具有ACID四大特性，数据库事务在实现时会将一次事务涉及的所有操作全部纳入到一个不可分割的执行单元，该执行单元中的所有操作 要么都成功，要么都失败，只要其中任一操作执行失败，都将导致整个事务的回滚。</p> <p>理解了本地事务，什么是分布式事务？</p> <p>现在的需求是课程发布操作后将数据写入数据库、redis、elasticsearch、MinIO四个地方，这四个地方已经不限制在一个数据库内，是由四个分散的服务去提供，与这四个服务去通信需要网络通信，而网络存在不可到达性，这种分布式系统环境下，通过与不同的服务进行网络通信去完成事务称之为<strong>分布式事务。</strong></p> <p>在分布式系统中分布式事务的场景很多：</p> <p>例如用户注册送积分，银行转账，创建订单减库存，这些都是分布式事务。</p> <p>拿转账举例：</p> <p>我们知道本地事务依赖数据库本身提供的事务特性来实现，因此以下逻辑可以控制本地事务：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>begin transaction； 
<span class="token comment">//1.本地数据库操作：张三减少金额 </span>
<span class="token comment">//2.本地数据库操作：李四增加金额 </span>
commit transation<span class="token punctuation">;</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>但是在分布式环境下，会变成下边这样：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>begin transaction； 
<span class="token comment">//1.本地数据库操作：张三减少金额 </span>
<span class="token comment">//2.远程调用：让李四增加金额 </span>
commit transation<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>可以设想，当远程调用让李四增加金额成功了，由于网络问题远程调用并没有返回，此时本地事务提交失败就回滚了张三减少金额的操作，此时张三和李四的数据就不一致了。</p> <p>因此在分布式架构的基础上，传统数据库事务就无法使用了，张三和李四的账户不在一个数据库中甚至不在一个应用系统里，实现转账事务需要通过远程调用，由于网络问题就会导致分布式事务问题。</p> <p>下边的场景都会产生分布式事务：</p> <p>微服务架构下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152158469.png" alt="image-20250115215852390"></p> <p>单服务多数据库：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152159298.png" alt="image-20250115215916218"></p> <p>多服务单数据库:</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152205717.png" alt="image-20250115215933544"></p> <h3 id="_4-2-2-什么是cap理论"><a href="#_4-2-2-什么是cap理论" class="header-anchor">#</a> 4.2.2 什么是CAP理论</h3> <p>控制分布式事务首先需要理解CAP理论，什么是CAP理论？</p> <p>CAP是 Consistency、Availability、Partition tolerance三个词语的缩写，分别表示一致性、可用性、分区容忍性。</p> <p>使用下边的分布式系统结构 进行说明：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152200276.png" alt="image-20250115220007182"></p> <p>客户端经过网关访问用户服务的两个结点，一致性是指用户不管访问哪一个结点拿到的数据都是最新的，比如查询小明的信息，不能出现在数据没有改变的情况下两次查询结果不一样。</p> <p>可用性是指任何时候查询用户信息都可以查询到结果，但不保证查询到最新的数据。</p> <p>分区容忍性也叫分区容错性，由于网络通信异常导致请求中断、消息丢失，但服务依然对外提供服务。</p> <p>CAP理论要强调的是在分布式系统中这三点不可能全部满足，由于是分布式系统就要满足分区容忍性，因为服务之间难免出现网络异常，不能因为局部网络异常导致整个系统不可用。</p> <p>满足P那么C和A不能同时满足：</p> <p>比如我们添加一个用户小明的信息，该信息先添加到结点1中，再同步到结点2中，如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152200907.png" alt="image-20250115220044816"></p> <p>如果要满足C一致性，必须等待小明的信息同步完成系统才可用（否则会出现请求到结点2时查询不到数据，违反了一致性），在信息同步过程中系统是不可用的，所以满足C的同时无法满足A。</p> <p>如果要满足A可用性，要时刻保证系统可用就不用等待信息同步完成，此时系统的一致性无法满足。</p> <p>所以在分布式系统中进行分布式事务控制，要么保证CP、要么保证AP。</p> <h3 id="_4-2-3-分布式事务控制方案"><a href="#_4-2-3-分布式事务控制方案" class="header-anchor">#</a> 4.2.3 分布式事务控制方案</h3> <p>学习CAP理论该如何控制分布式事务呢？</p> <p>学习了CAP理论我们知道进行分布式事务控制要在C和A中作出取舍，保证一致性就不要保证可用性，保证可用性就不要保证一致，首先你确认是要CP还是AP，具体要根据应用场景进行判断。</p> <p>CP的场景：满足C舍弃A，强调一致性。</p> <p>跨行转账：一次转账请求要等待双方银行系统都完成整个事务才算完成，只要其中一个失败另一方执行回滚操作。</p> <p>开户操作：在业务系统开户同时要在运营商开户，任何一方开户失败该用户都不可使用，所以要满足CP。</p> <p>AP的场景：满足A舍弃C，强调可用性。</p> <p>订单退款，今日退款成功，明日账户到账，只要用户可以接受在一定时间内到账即可。</p> <p>注册送积分，注册成功积分在24分到账。</p> <p>支付短信通信，支付成功发短信，短信发送可以有延迟，甚至没有发送成功。</p> <p>在实际应用中符合AP的场景较多，其实虽然AP舍弃C一致性，实际上最终数据还是达到了一致，也就满足了最终一致性，所以业界定义了BASE理论。</p> <p>什么是BASE理论？</p> <p>BASE 是 Basically Available(基本可用)、Soft state(软状态)和 Eventually consistent (最终一致性)三个短语的缩写。</p> <p>基本可用：当系统无法满足全部可用时保证核心服务可用即可，比如一个外卖系统，每到中午12点左右系统并发量很高，此时要保证下单流程涉及的服务可用，其它服务暂时不可用。</p> <p>软状态：是指可以存在中间状态，比如：打印自己的社保统计情况，该操作不会立即出现结果，而是提示你打印中，请在XXX时间后查收。虽然出现了中间状态，但最终状态是正确的。</p> <p>最终一致性：退款操作后没有及时到账，经过一定的时间后账户到账，舍弃强一致性，满足最终一致性。</p> <h3 id="_4-2-4-课程发布分布式事务控制"><a href="#_4-2-4-课程发布分布式事务控制" class="header-anchor">#</a> 4.2.4 课程发布分布式事务控制</h3> <p>学习了这么多的理论，回到课程发布，执行课程发布操作后要向数据库、redis、elasticsearch、MinIO写四份数据，这个场景用哪种方案？</p> <p>满足CP？</p> <p>如果要满足CP就表示课程发布操作后向数据库、redis、elasticsearch、MinIO写四份数据，只要有一份写失败其它的全部回滚。</p> <p>满足AP？</p> <p>课程发布操作后，先更新数据库中的课程发布状态，更新后向redis、elasticsearch、MinIO写课程信息，只要在一定时间内最终向redis、elasticsearch、MinIO写数据成功即可。</p> <p>课程发布满足AP即可，使用BASE理论实现。</p> <p>下图是具体的技术方案：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152202977.png" alt="image-20250115220216896"></p> <p>1、在内容管理服务的数据库中添加一个消息表，消息表和课程发布表在同一个数据库。</p> <p>2、点击课程发布通过本地事务向课程发布表写入课程发布信息，同时向消息表写课程发布的消息。两条记录保证同时存在或同时不存在。</p> <p>3、启动任务调度系统定时调度内容管理服务去定时扫描消息表的记录。</p> <p>4、当扫描到课程发布的消息时即开始完成向redis、elasticsearch、MinIO同步数据的操作。</p> <p>5、同步数据的任务完成后删除消息表记录。</p> <p>时序图如下：</p> <p>下图是课程发布操作的流程：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152202605.png" alt="image-20250115220249522"></p> <p>1、执行发布操作，内容管理服务存储课程发布表的同时向消息表添加一条“课程发布任务”。这里使用本地事务保证课程发布信息保存成功，同时消息表也保存成功。</p> <p>2、任务调度服务定时调度内容管理服务扫描消息表，由于课程发布操作后向消息表插入一条课程发布任务，此时扫描到一条任务。</p> <p>3、拿到任务开始执行任务，分别向redis、elasticsearch及文件系统存储数据。</p> <p>4、任务完成后删除消息表记录。</p> <h2 id="_4-3-课程发布接口"><a href="#_4-3-课程发布接口" class="header-anchor">#</a> 4.3 课程发布接口</h2> <h3 id="_4-3-1-接口定义"><a href="#_4-3-1-接口定义" class="header-anchor">#</a> 4.3.1 接口定义</h3> <p>根据课程发布的分布式事务控制方案，课程发布操作首先通过本地事务向课程发布表写入课程发布信息并向消息表插入一条消息，这里定义的课程发布接口要实现该功能。</p> <p>在内容管理接口工程中定义课程发布接口。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @description 课程预览，发布
 * @author Mr.M
 * @date 2022/9/16 14:48
 * @version 1.0
 */</span>
<span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;课程预览发布接口&quot;</span><span class="token punctuation">,</span>tags <span class="token operator">=</span> <span class="token string">&quot;课程预览发布接口&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CoursePublishController</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;课程发布&quot;</span><span class="token punctuation">)</span>
 <span class="token annotation punctuation">@ResponseBody</span>
 <span class="token annotation punctuation">@PostMapping</span> <span class="token punctuation">(</span><span class="token string">&quot;/coursepublish/{courseId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">coursepublish</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;courseId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>

<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="_4-3-3-接口开发"><a href="#_4-3-3-接口开发" class="header-anchor">#</a> 4.3.3 接口开发</h3> <h4 id="_4-3-3-1-dao开发"><a href="#_4-3-3-1-dao开发" class="header-anchor">#</a> 4.3.3.1 DAO开发</h4> <p>课程发布操作对数据库操作如下：</p> <p>1、向课程发布表course_publish插入一条记录，如果存在则更新，发布状态为：已发布。</p> <p>2、更新course_base表的课程发布状态为：已发布</p> <p>3、删除课程预发布表的对应记录。</p> <p>4、向mq_message消息表插入一条消息，消息类型为：course_publish</p> <p>约束：</p> <p>1、课程审核通过方可发布。</p> <p>2、本机构只允许发布本机构的课程。</p> <p>以上功能使用自动生成的mapper接口即可完成。</p> <p>1、在内容管理数据库创建mq_message消息表及消息历史消息表（历史表存储已经完成的消息）。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152204583.png" alt="image-20250115220435497"></p> <p>消息表结构如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152204812.png" alt="image-20250115220456729"></p> <p>2、生成mq_message消息表、course_publish课程发布表的po和mapper接口</p> <p>稍后会开发一个通用的消息处理组件，这里先不生成代码。</p> <h4 id="_4-3-3-2-service开发"><a href="#_4-3-3-2-service开发" class="header-anchor">#</a> 4.3.3.2 Service开发</h4> <p>定义Service接口：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @description 课程发布接口
 * @param companyId 机构id
 * @param courseId 课程id
 * @return void
 * @author Mr.M
 * @date 2022/9/20 16:23
*/</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">publish</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>编写课程发布Service方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code> <span class="token annotation punctuation">@Transactional</span>
 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">publish</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">//约束校验</span>
  <span class="token comment">//查询课程预发布表</span>
  <span class="token class-name">CoursePublishPre</span> coursePublishPre <span class="token operator">=</span> coursePublishPreMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>coursePublishPre <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;请先提交课程审核，审核通过才可以发布&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//本机构只允许提交本机构的课程</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>coursePublishPre<span class="token punctuation">.</span><span class="token function">getCompanyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>companyId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;不允许提交其它机构的课程。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  <span class="token comment">//课程审核状态</span>
  <span class="token class-name">String</span> auditStatus <span class="token operator">=</span> coursePublishPre<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//审核通过方可发布</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">&quot;202004&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>auditStatus<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;操作失败，课程审核通过方可发布。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//保存课程发布信息</span>
  <span class="token function">saveCoursePublish</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//保存消息表</span>
  <span class="token function">saveCoursePublishMessage</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">//删除课程预发布表对应记录</span>
  coursePublishPreMapper<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>

<span class="token comment">/**
 * @description 保存课程发布信息
 * @param courseId  课程id
 * @return void
 * @author Mr.M
 * @date 2022/9/20 16:32
*/</span>
 <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveCoursePublish</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token comment">//整合课程发布信息</span>
  <span class="token comment">//查询课程预发布表</span>
  <span class="token class-name">CoursePublishPre</span> coursePublishPre <span class="token operator">=</span> coursePublishPreMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>coursePublishPre <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;课程预发布数据为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">CoursePublish</span> coursePublish <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CoursePublish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//拷贝到课程发布对象</span>
  <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>coursePublishPre<span class="token punctuation">,</span>coursePublish<span class="token punctuation">)</span><span class="token punctuation">;</span>
  coursePublish<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;203002&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">CoursePublish</span> coursePublishUpdate <span class="token operator">=</span> coursePublishMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>coursePublishUpdate <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   coursePublishMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>coursePublish<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
   coursePublishMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>coursePublish<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//更新课程基本表的发布状态</span>
  <span class="token class-name">CourseBase</span> courseBase <span class="token operator">=</span> courseBaseMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  courseBase<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;203002&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  courseBaseMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>courseBase<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>

 <span class="token comment">/**
  * @description 保存消息表记录，稍后实现
  * @param courseId  课程id
  * @return void
  * @author Mr.M
  * @date 2022/9/20 16:32
  */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveCoursePublishMessage</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>


<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br></div></div><h4 id="_4-3-3-3-接口完善"><a href="#_4-3-3-3-接口完善" class="header-anchor">#</a> 4.3.3.3 接口完善</h4> <p>完善接口层代码</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code> <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;课程发布&quot;</span><span class="token punctuation">)</span>
 <span class="token annotation punctuation">@ResponseBody</span>
 <span class="token annotation punctuation">@PostMapping</span> <span class="token punctuation">(</span><span class="token string">&quot;/coursepublish/{courseId}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">coursepublish</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;courseId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token class-name">Long</span> companyId <span class="token operator">=</span> <span class="token number">1232141425L</span><span class="token punctuation">;</span>
     coursePublishService<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>companyId<span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_4-3-4-接口测试"><a href="#_4-3-4-接口测试" class="header-anchor">#</a> 4.3.4 接口测试</h3> <p>先使用httpclient方法测试：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>### 课程发布
<span class="token constant">POST</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>content_host<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">/</span>content<span class="token operator">/</span>coursepublish<span class="token operator">/</span><span class="token number">2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>先测试约束条件：</p> <p>1、在未提交审核时进行课程发布测试。</p> <p>2、在课程未审核通过时进行发布。</p> <p>正常流程测试：</p> <p>1、提交审核课程</p> <p>2、手动修改课程预发布表与课程基本信息的审核状态为审核通过。</p> <p>3、执行课程发布</p> <p>4、观察课程发布表记录是否正常，课程预发布表记录已经删除，课程基本信息表与课程发布表的发布状态为”发布“。</p> <p>使用前后端联调方式测试。</p> <h2 id="_4-4-消息处理sdk"><a href="#_4-4-消息处理sdk" class="header-anchor">#</a> 4.4 消息处理SDK</h2> <h3 id="_4-4-1-消息模块技术方案"><a href="#_4-4-1-消息模块技术方案" class="header-anchor">#</a> 4.4.1 消息模块技术方案</h3> <p>课程发布操作执行后需要扫描消息表的记录，有关消息表处理的有哪些？</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152208204.png" alt="image-20250115220830124"></p> <p>上图中红色框内的都是与消息处理相关的操作：</p> <p>1、新增消息表</p> <p>2、扫描消息表。</p> <p>3、更新消息表。</p> <p>4、删除消息表。</p> <p>使用消息表这种方式实现最终事务一致性的地方除了课程发布还有其它业务场景。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152208345.png" alt="image-20250115220854254"></p> <p>如果在每个地方都实现一套针对消息表定时扫描、处理的逻辑基本上都是重复的，软件的可复用性太低，成本太高。</p> <p>如何解决这个问题？</p> <p>针对这个问题可以想到将消息处理相关的逻辑做成一个通用的东西。</p> <p>是做成通用的服务，还是做成通用的代码组件呢？</p> <p>通用的服务是完成一个通用的独立功能，并提供独立的网络接口，比如：项目中的文件系统服务，提供文件的分布式存储服务。</p> <p>代码组件也是完成一个通用的独立功能，通常会提供API的方式供外部系统使用，比如：fastjson、Apache commons工具包等。</p> <p>如果将消息处理做成一个通用的服务，该服务需要连接多个数据库，因为它要扫描微服务数据库下的消息表，并且要提供与微服务通信的网络接口，单就针对当前需求而言开发成本有点高。</p> <p>如果将消息处理做一个SDK工具包相比通用服务不仅可以解决将消息处理通用化的需求，还可以降低成本。</p> <p>所以，本项目确定将对消息表相关的处理做成一个SDK组件供各微服务使用,如下图所示：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152209297.png" alt="image-20250115220921209"></p> <p>下边对消息SDK的设计内容进行说明：</p> <p>执行任务应该是sdk包含的功能吗？</p> <p>拿课程发布任务举例，执行课程发布任务是要向redis、索引库等同步数据，其它任务的执行逻辑是不同的，所以执行任务在sdk中不用实现，只需要提供一个抽象方法由具体的执行任务方去实现。</p> <p>还有一个问题，如何保证任务的幂等性？</p> <p>在视频处理章节介绍的视频处理的幂等性方案，这里可以采用类似方案，任务执行完成后会从消息表删除，如果消息的状态是完成或不存在消息表中则不用执行。</p> <p>如何保证任务不重复执行？</p> <p>采用和视频处理章节一致方案，除了保证任务的幂等性外，任务调度采用分片广播，获取等处理消息根据分片参数去获取，另外阻塞调度策略为丢弃任务。</p> <p>还有一个问题，根据消息表记录是否存在或消息表中的任务状态去保证任务的幂等性，如果一个任务有好几个小任务，比如：课程发布任务需要执行三个同步操作：存储课程到redis、存储课程到索引库，存储课程页面到文件系统。如果其中一个小任务已经完成也不应该去重复执行。这里该如何设计？</p> <p>将小任务作为任务的不同的阶段，在消息表中设计阶段状态。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152209984.png" alt="image-20250115220948894"></p> <p>每完成一个阶段在相应的阶段状态字段打上完成标记，即使这个大任务没有完成再重新执行时，如果小阶段任务完成了也不会重复执行某个小阶段的任务。</p> <p>综上所述，除了消息表的基本的增、删、改、查的接口外，消息SDK还具有如下接口功能：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">IService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MqMessage</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * &lt;p&gt;
 *  服务类
 * &lt;/p&gt;
 *
 * @author Mr.M
 * @since 2022-09-21
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MqMessageService</span> <span class="token keyword">extends</span> <span class="token class-name">IService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MqMessage</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * @description 扫描消息表记录，采用与扫描视频处理表相同的思路
     * @param shardIndex 分片序号
     * @param shardTotal 分片总数
     * @param count 扫描记录数
     * @return java.util.List 消息记录
     * @author Mr.M
     * @date 2022/9/21 18:55
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MqMessage</span><span class="token punctuation">&gt;</span></span> <span class="token function">getMessageList</span><span class="token punctuation">(</span><span class="token keyword">int</span> shardIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> shardTotal<span class="token punctuation">,</span>  <span class="token class-name">String</span> messageType<span class="token punctuation">,</span><span class="token keyword">int</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * @description 完成任务
     * @param id 消息id
     * @return int 更新成功：1
     * @author Mr.M
     * @date 2022/9/21 20:49
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">completed</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * @description 完成阶段任务
     * @param id 消息id
     * @return int 更新成功：1
     * @author Mr.M
     * @date 2022/9/21 20:49
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">completedStageOne</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">completedStageTwo</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">completedStageThree</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">completedStageFour</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * @description 查询阶段状态
     * @param id
     * @return int
     * @author Mr.M
     * @date 2022/9/21 20:54
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getStageOne</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getStageTwo</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getStageThree</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getStageFour</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><p>消息SDK提供消息处理抽象类，此抽象类供使用方去继承，如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MqMessage</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author Mr.M
 * @version 1.0
 * @description 消息处理抽象类
 * @date 2022/9/21 19:44
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">MessageProcessAbstract</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">MqMessageService</span> mqMessageService<span class="token punctuation">;</span>


    <span class="token comment">/**
     * @param mqMessage 执行任务内容
     * @return boolean true:处理成功，false处理失败
     * @description 任务处理
     * @author Mr.M
     * @date 2022/9/21 19:47
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">boolean</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">MqMessage</span> mqMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">/**
     * @description 扫描消息表多线程执行任务
     * @param shardIndex 分片序号
     * @param shardTotal 分片总数
     * @param messageType  消息类型
     * @param count  一次取出任务总数
     * @param timeout 预估任务执行时间,到此时间如果任务还没有结束则强制结束 单位秒
     * @return void
     * @author Mr.M
     * @date 2022/9/21 20:35
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">int</span> shardIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> shardTotal<span class="token punctuation">,</span>  <span class="token class-name">String</span> messageType<span class="token punctuation">,</span><span class="token keyword">int</span> count<span class="token punctuation">,</span><span class="token keyword">long</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//扫描消息表获取任务清单</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MqMessage</span><span class="token punctuation">&gt;</span></span> messageList <span class="token operator">=</span> mqMessageService<span class="token punctuation">.</span><span class="token function">getMessageList</span><span class="token punctuation">(</span>shardIndex<span class="token punctuation">,</span> shardTotal<span class="token punctuation">,</span>messageType<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//任务个数</span>
            <span class="token keyword">int</span> size <span class="token operator">=</span> messageList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;取出待处理消息&quot;</span><span class="token operator">+</span>size<span class="token operator">+</span><span class="token string">&quot;条&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>size<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//创建线程池</span>
            <span class="token class-name">ExecutorService</span> threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//计数器</span>
            <span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            messageList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>message <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;开始任务:{}&quot;</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//处理任务</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token function">execute</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">{</span>
                            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;任务执行成功:{})&quot;</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">//更新任务状态,删除消息表记录,添加到历史表</span>
                            <span class="token keyword">int</span> completed <span class="token operator">=</span> mqMessageService<span class="token punctuation">.</span><span class="token function">completed</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>completed<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;任务执行成功:{}&quot;</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;任务执行失败:{}&quot;</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;任务出现异常:{},任务:{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//计数</span>
                    countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;结束任务:{}&quot;</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//等待,给一个充裕的超时时间,防止无限等待，到达超时时间还没有处理完成则结束任务</span>
            countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;结束....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br></div></div><h3 id="_4-4-2-消息模块sdk测试"><a href="#_4-4-2-消息模块sdk测试" class="header-anchor">#</a> 4.4.2 消息模块SDK测试</h3> <p>1、在内容管理数据库创建消息表和消息历史表</p> <p>建表脚本在课程资料下。</p> <p>2、拷贝到课程资料中的xuecheng-plus-message-sdk，如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152212637.png" alt="image-20250115221208549"></p> <p>下边测试消息SDK的接口。</p> <p>1、继承MessageProcessAbstract 抽象类编写任务执行方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MqMessage</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">MessageProcessAbstract</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">MqMessageService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @description 消息处理测试类，继承MessageProcessAbstract
 * @author Mr.M
 * @date 2022/9/21 21:44
 * @version 1.0
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageProcessClass</span> <span class="token keyword">extends</span> <span class="token class-name">MessageProcessAbstract</span> <span class="token punctuation">{</span>


    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">MqMessageService</span> mqMessageService<span class="token punctuation">;</span>

    <span class="token comment">//执行任务</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">MqMessage</span> mqMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> id <span class="token operator">=</span> mqMessage<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;开始执行任务:{}&quot;</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//取出阶段状态</span>
        <span class="token keyword">int</span> stageOne <span class="token operator">=</span> mqMessageService<span class="token punctuation">.</span><span class="token function">getStageOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>stageOne<span class="token operator">&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;开始执行第一阶段任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> i <span class="token operator">=</span> mqMessageService<span class="token punctuation">.</span><span class="token function">completedStageOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;完成第一阶段任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;无需执行第一阶段任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>2、编写测试类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDateTime</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author Mr.M
 * @version 1.0
 * @description TODO
 * @date 2022/9/21 21:51
 */</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageProcessClassTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">MessageProcessClass</span> messageProcessClass<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;开始执行-----》&quot;</span> <span class="token operator">+</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        messageProcessClass<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;结束执行-----》&quot;</span> <span class="token operator">+</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>3、准备测试数据，在消息表添加消息类型为&quot;test&quot;的消息，执行MessageProcessClassTest 类中的test()方法。</p> <h3 id="_4-4-3-集成消息sdk"><a href="#_4-4-3-集成消息sdk" class="header-anchor">#</a> 4.4.3 集成消息SDK</h3> <h4 id="_4-4-3-1-课程发布任务处理"><a href="#_4-4-3-1-课程发布任务处理" class="header-anchor">#</a> 4.4.3.1 课程发布任务处理</h4> <p>下一步在课程发布模块去集成SDK完成课程发布任务处理。首先集成SDK并测试通过，然后再添加各任务的执行逻辑。</p> <p>在内容管理服务添加消息处理sdk的依赖即可使用它，实现sdk中的MessageProcessAbstract类，重写execte方法。</p> <p>1、在内容管理service工程中添加sdk依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>XML
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.xuecheng<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>xuecheng-plus-message-sdk<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>2、实现sdk中的MessageProcessAbstract类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>service<span class="token punctuation">.</span>jobhandler</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk<span class="token punctuation">.</span>model<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">MqMessage</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>messagesdk<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">MessageProcessAbstract</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xxl<span class="token punctuation">.</span>job<span class="token punctuation">.</span>core<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">XxlJobHelper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xxl<span class="token punctuation">.</span>job<span class="token punctuation">.</span>core<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">XxlJob</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author Mr.M
 * @version 1.0
 * @description TODO
 * @date 2022/9/22 10:16
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CoursePublishTask</span> <span class="token keyword">extends</span> <span class="token class-name">MessageProcessAbstract</span> <span class="token punctuation">{</span>


    <span class="token comment">//课程发布任务处理</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">MqMessage</span> mqMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取消息相关的业务信息</span>
        <span class="token class-name">String</span> businessKey1 <span class="token operator">=</span> mqMessage<span class="token punctuation">.</span><span class="token function">getBusinessKey1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> courseId <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>businessKey1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//课程静态化</span>
        <span class="token function">generateCourseHtml</span><span class="token punctuation">(</span>mqMessage<span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//课程缓存</span>
        <span class="token function">saveCourseCache</span><span class="token punctuation">(</span>mqMessage<span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//课程索引</span>
        <span class="token function">saveCourseIndex</span><span class="token punctuation">(</span>mqMessage<span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">//生成课程静态化页面并上传至文件系统</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">generateCourseHtml</span><span class="token punctuation">(</span><span class="token class-name">MqMessage</span> mqMessage<span class="token punctuation">,</span><span class="token keyword">long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>

        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;开始进行课程静态化,课程id:{}&quot;</span><span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//消息id</span>
        <span class="token class-name">Long</span> id <span class="token operator">=</span> mqMessage<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//消息处理的service</span>
        <span class="token class-name">MqMessageService</span> mqMessageService <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMqMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//消息幂等性处理</span>
        <span class="token keyword">int</span> stageOne <span class="token operator">=</span> mqMessageService<span class="token punctuation">.</span><span class="token function">getStageOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>stageOne <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;课程静态化已处理直接返回，课程id:{}&quot;</span><span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//保存第一阶段状态</span>
        mqMessageService<span class="token punctuation">.</span><span class="token function">completedStageOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token comment">//将课程信息缓存至redis</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveCourseCache</span><span class="token punctuation">(</span><span class="token class-name">MqMessage</span> mqMessage<span class="token punctuation">,</span><span class="token keyword">long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;将课程信息缓存至redis,课程id:{}&quot;</span><span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


    <span class="token punctuation">}</span>
    <span class="token comment">//保存课程索引信息</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveCourseIndex</span><span class="token punctuation">(</span><span class="token class-name">MqMessage</span> mqMessage<span class="token punctuation">,</span><span class="token keyword">long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;保存课程索引信息,课程id:{}&quot;</span><span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br></div></div><h4 id="_4-4-3-2-开启任务调度"><a href="#_4-4-3-2-开启任务调度" class="header-anchor">#</a> 4.4.3.2 开启任务调度</h4> <p>1、首先在内容管理service工程中添加xxl-job依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.xuxueli<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>xxl-job-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>2、配置执行器</p> <p>在nacos中在content-service-dev.yaml中配置</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">xxl</span><span class="token punctuation">:</span>
  <span class="token key atrule">job</span><span class="token punctuation">:</span>
    <span class="token key atrule">admin</span><span class="token punctuation">:</span> 
      <span class="token key atrule">addresses</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//192.168.101.65<span class="token punctuation">:</span>8088/xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>admin
    <span class="token key atrule">executor</span><span class="token punctuation">:</span>
      <span class="token key atrule">appname</span><span class="token punctuation">:</span> coursepublish<span class="token punctuation">-</span>job
      <span class="token key atrule">address</span><span class="token punctuation">:</span> 
      <span class="token key atrule">ip</span><span class="token punctuation">:</span> 
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8999</span>
      <span class="token key atrule">logpath</span><span class="token punctuation">:</span> /data/applogs/xxl<span class="token punctuation">-</span>job/jobhandler
      <span class="token key atrule">logretentiondays</span><span class="token punctuation">:</span> <span class="token number">30</span>
    <span class="token key atrule">accessToken</span><span class="token punctuation">:</span> default_token
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>3、从媒资管理服务层工程中拷贝一个XxlJobConfig配置类到内容管理service工程中。</p> <p>在xxl-job-admin控制台中添加执行器</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152250612.png" alt="image-20250115225028501"></p> <p>3、编写任务调度入口</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CoursePublishTask</span> <span class="token keyword">extends</span> <span class="token class-name">MessageProcessAbstract</span> <span class="token punctuation">{</span>

    <span class="token comment">//课程发布消息类型</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">MESSAGE_TYPE</span> <span class="token operator">=</span> <span class="token string">&quot;course_publish&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">//任务调度入口</span>
    <span class="token annotation punctuation">@XxlJob</span><span class="token punctuation">(</span><span class="token string">&quot;CoursePublishJobHandler&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">coursePublishJobHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 分片参数</span>
        <span class="token keyword">int</span> shardIndex <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> shardTotal <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;shardIndex=&quot;</span><span class="token operator">+</span>shardIndex<span class="token operator">+</span><span class="token string">&quot;,shardTotal=&quot;</span><span class="token operator">+</span>shardTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//参数:分片序号、分片总数、消息类型、一次最多取到的任务数量、一次任务调度执行的超时时间</span>
        <span class="token function">process</span><span class="token punctuation">(</span>shardIndex<span class="token punctuation">,</span>shardTotal<span class="token punctuation">,</span><span class="token constant">MESSAGE_TYPE</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>4、在xxl-job添加任务</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152251967.png" alt="image-20250115225110857"></p> <p>任务配置如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152251222.png" alt="image-20250115225139135"></p> <p>到此SDK开发、集成完成，下一步添加课程发布后页面静态化、课程缓存、课程索引等任务。</p> <h4 id="_4-4-3-3-测试"><a href="#_4-4-3-3-测试" class="header-anchor">#</a> 4.4.3.3 测试</h4> <p>在消息表添加课程发布的消息，消息类型为course_publish,business_key1为发布课程的ID</p> <p>1、测试是否可以正常调度执行。</p> <p>2、测试任务幂等性</p> <p>在 saveCourseCache(mqMessage,courseId);处打断点，待执行到这里观察数据库第一阶段完成的标记预期标记为1。</p> <p>结束进程，再重新启动，观察第一阶段的任务预期不再执行。</p> <p>3、任务执行完成删除消息表记录，插入历史表，state状态字段为1</p> <h2 id="_4-5-页面静态化"><a href="#_4-5-页面静态化" class="header-anchor">#</a> 4.5 页面静态化</h2> <h3 id="_4-5-1-什么是页面静态化"><a href="#_4-5-1-什么是页面静态化" class="header-anchor">#</a> 4.5.1 什么是页面静态化</h3> <p>根据课程发布的操作流程，执行课程发布后要将课程详情信息页面静态化，生成html页面上传至文件系统。</p> <p>什么是页面静态化？</p> <p>课程预览功能通过模板引擎技术在页面模板中填充数据，生成html页面，这个过程是当客户端请求服务器时服务器才开始渲染生成html页面，最后响应给浏览器，这个过程支持并发是有限的。</p> <p>页面静态化则强调将生成html页面的过程提前，提前使用模板引擎技术生成html页面，当客户端请求时直接请求html页面，由于是静态页面可以使用nginx、apache等高性能的web服务器，并发性能高。</p> <p>什么时候能用页面静态化技术？</p> <p>当数据变化不频繁，一旦生成静态页面很长一段时间内很少变化，此时可以使用页面静态化。因为如果数据变化频繁，一旦改变就需要重新生成静态页面，导致维护静态页面的工作量很大。</p> <p>根据课程发布的业务需求，虽然课程发布后仍可以修改课程信息，但需要经过课程审核，且修改频度不大，所以适合使用页面静态化。</p> <h3 id="_4-5-2-静态化测试"><a href="#_4-5-2-静态化测试" class="header-anchor">#</a> 4.5.2 静态化测试</h3> <p>下边使用freemarker技术对页面静态化生成html页面。</p> <p>在内容管理service工程中添加freemarker依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-freemarker<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>编写测试方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">CoursePreviewDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">CoursePublishService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">freemarker<span class="token punctuation">.</span>template<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">freemarker<span class="token punctuation">.</span>template<span class="token punctuation">.</span></span><span class="token class-name">Template</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">freemarker<span class="token punctuation">.</span>template<span class="token punctuation">.</span></span><span class="token class-name">TemplateException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>freemarker<span class="token punctuation">.</span></span><span class="token class-name">FreeMarkerTemplateUtils</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileOutputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author Mr.M
 * @version 1.0
 * @description freemarker测试
 * @date 2022/9/20 18:42
 */</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FreemarkerTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">CoursePublishService</span> coursePublishService<span class="token punctuation">;</span>


    <span class="token comment">//测试页面静态化</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testGenerateHtmlByTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TemplateException</span> <span class="token punctuation">{</span>
        <span class="token comment">//配置freemarker</span>
        <span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span><span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//加载模板</span>
        <span class="token comment">//选指定模板路径,classpath下templates下</span>
        <span class="token comment">//得到classpath路径</span>
        <span class="token class-name">String</span> classpath <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        configuration<span class="token punctuation">.</span><span class="token function">setDirectoryForTemplateLoading</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>classpath <span class="token operator">+</span> <span class="token string">&quot;/templates/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置字符编码</span>
        configuration<span class="token punctuation">.</span><span class="token function">setDefaultEncoding</span><span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//指定模板文件名称</span>
        <span class="token class-name">Template</span> template <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getTemplate</span><span class="token punctuation">(</span><span class="token string">&quot;course_template.ftl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//准备数据</span>
        <span class="token class-name">CoursePreviewDto</span> coursePreviewInfo <span class="token operator">=</span> coursePublishService<span class="token punctuation">.</span><span class="token function">getCoursePreviewInfo</span><span class="token punctuation">(</span><span class="token number">2L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;model&quot;</span><span class="token punctuation">,</span> coursePreviewInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//静态化</span>
        <span class="token comment">//参数1：模板，参数2：数据模型</span>
        <span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token class-name">FreeMarkerTemplateUtils</span><span class="token punctuation">.</span><span class="token function">processTemplateIntoString</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将静态化内容输出到文件中</span>
        <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">toInputStream</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//输出流</span>
        <span class="token class-name">FileOutputStream</span> outputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">&quot;D:\\develop\\test.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> outputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br></div></div><p>执行测试方法，观察D:\develop\test.html 是否成功生成。</p> <h3 id="_4-5-3-上传文件测试"><a href="#_4-5-3-上传文件测试" class="header-anchor">#</a> 4.5.3 上传文件测试</h3> <p>静态化生成文件后需要上传至分布式文件系统，根据微服务的职责划分，媒资管理服务负责维护文件系统中的文件，所以内容管理服务对页面静态化生成html文件需要调用媒资管理服务的上传文件接口。如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152254113.png" alt="image-20250115225400010"></p> <p>微服务之间难免会存在远程调用，在Spring Cloud中可以使用Feign进行远程调用， Feign是什么？</p> <p>Feign是一个声明式的http客户端，官方地址：https://github.com/OpenFeign/feign</p> <p>其作用就是帮助我们优雅的实现http请求的发送，解决上面提到的问题。</p> <p>下边先准备Feign的开发环境，在内容管理content-service工程添加依赖：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- Spring Cloud 微服务远程调用 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.github.openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>feign-httpclient<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--feign支持Multipart格式传参--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.github.openfeign.form<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>feign-form<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.8.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.github.openfeign.form<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>feign-form-spring<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.8.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>在nacos配置feign-dev.yaml公用配置文件</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>YAML
feign:
  client:
    config:
      default: # default全局的配置
        loggerLevel: BASIC # 日志级别，BASIC就是基本的请求和响应信息
  httpclient:
    enabled: true # 开启feign对HttpClient的支持
    max-connections: 200 # 最大的连接数
    max-connections-per-route: 50 # 每个路径的最大连接数
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>在内容管理service工程和内容管理api工程都引入此配置文件</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">shared-configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> feign<span class="token punctuation">-</span>$<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>.yaml
    <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>common
    <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在内容管理service工程配置feign支持Multipart，拷贝课程资料下的MultipartSupportConfig 到content-service工程下的config包下。</p> <p>编写feign接口</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>feignclient</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">MultipartSupportConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">MediaType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestParam</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestPart</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>multipart<span class="token punctuation">.</span></span><span class="token class-name">MultipartFile</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @description 媒资管理服务远程接口
 * @author Mr.M
 * @date 2022/9/20 20:29
 * @version 1.0
 */</span>
 <span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;media-api&quot;</span><span class="token punctuation">,</span>configuration <span class="token operator">=</span> <span class="token class-name">MultipartSupportConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MediaServiceClient</span> <span class="token punctuation">{</span>

 <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/media/upload/coursefile&quot;</span><span class="token punctuation">,</span>consumes <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">MULTIPART_FORM_DATA_VALUE</span><span class="token punctuation">)</span>
 <span class="token class-name">String</span> <span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestPart</span><span class="token punctuation">(</span><span class="token string">&quot;filedata&quot;</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> upload<span class="token punctuation">,</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;folder&quot;</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> folder<span class="token punctuation">,</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;objectName&quot;</span><span class="token punctuation">,</span>required<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>在启动类添加@EnableFeignClients注解</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;com.xuecheng.content.feignclient&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>编写测试方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>feignclient<span class="token punctuation">.</span></span><span class="token class-name">MediaServiceClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>fileupload<span class="token punctuation">.</span></span><span class="token class-name">FileItem</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>fileupload<span class="token punctuation">.</span>disk<span class="token punctuation">.</span></span><span class="token class-name">DiskFileItemFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">MediaType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>multipart<span class="token punctuation">.</span></span><span class="token class-name">MultipartFile</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>multipart<span class="token punctuation">.</span>commons<span class="token punctuation">.</span></span><span class="token class-name">CommonsMultipartFile</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">OutputStream</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author Mr.M
 * @version 1.0
 * @description 测试使用feign远程上传文件
 * @date 2022/9/20 20:36
 */</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignUploadTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">MediaServiceClient</span> mediaServiceClient<span class="token punctuation">;</span>

    <span class="token comment">//远程调用，上传文件</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
        <span class="token class-name">MultipartFile</span> multipartFile <span class="token operator">=</span> <span class="token class-name">MultipartSupportConfig</span><span class="token punctuation">.</span><span class="token function">getMultipartFile</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;D:\\develop\\test.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaServiceClient<span class="token punctuation">.</span><span class="token function">uploadFile</span><span class="token punctuation">(</span>multipartFile<span class="token punctuation">,</span><span class="token string">&quot;course&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;test.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>执行测试方法，上传文件成功，进入minIO查看文件</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152256861.png" alt="image-20250115225611749"></p> <p>访问：http://192.168.101.65:9000/mediafiles/course/74b386417bb9f3764009dc94068a5e44.html</p> <p>查看是否可以正常访问。</p> <h3 id="_4-5-4-熔断降级处理"><a href="#_4-5-4-熔断降级处理" class="header-anchor">#</a> 4.5.4 熔断降级处理</h3> <h4 id="_4-5-4-1-什么是熔断降级"><a href="#_4-5-4-1-什么是熔断降级" class="header-anchor">#</a> 4.5.4.1 什么是熔断降级</h4> <p>微服务中难免存在服务之间的远程调用，比如：内容管理服务远程调用媒资服务的上传文件接口，当微服务运行不正常会导致无法正常调用微服务，此时会出现异常，如果这种异常不去处理可能导致雪崩效应。</p> <p>微服务的雪崩效应表现在服务与服务之间调用，当其中一个服务无法提供服务可能导致其它服务也死掉，比如：服务B调用服务A，由于A服务异常导致B服务响应缓慢，最后B、C等服务都不可用，像这样由一个服务所引起的一连串的多个服务无法提供服务即是微服务的雪崩效应，如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152257153.png" alt="image-20250115225707049"></p> <p>如何解决由于微服务异常引起的雪崩效应呢？</p> <p>可以采用熔断、降级的方法去解决。</p> <p>熔断降级的相同点都是为了解决微服务系统崩溃的问题，但它们是两个不同的技术手段，两者又存在联系。</p> <p>熔断：</p> <p>当下游服务异常而断开与上游服务的交互，它就相当于保险丝，下游服务异常触发了熔断，从而保证上游服务不受影响。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152257200.png" alt="image-20250115225736101"></p> <p>降级：</p> <p>当下游服务异常触发熔断后，上游服务就不再去调用异常的微服务而是执行了降级处理逻辑，这个降级处理逻辑可以是本地一个单独的方法。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152258824.png" alt="image-20250115225803720"></p> <p>两者都是为了保护系统，熔断是当下游服务异常时一种保护系统的手段，降级是熔断后上游服务处理熔断的方法。</p> <h4 id="_4-5-4-2-熔断降级处理"><a href="#_4-5-4-2-熔断降级处理" class="header-anchor">#</a> 4.5.4.2 熔断降级处理</h4> <p>项目使用Hystrix框架实现熔断、降级处理，在feign-dev.yaml中配置。</p> <p>1、开启Feign熔断保护</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">circuitbreaker</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>2、设置熔断的超时时间，为了防止一次处理时间较长触发熔断这里还需要设置请求和连接的超时时间，如下：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: <span class="token number">30000</span>  <span class="token comment">#熔断超时时间</span>
ribbon:
  ConnectTimeout: <span class="token number">60000</span> <span class="token comment">#连接超时时间</span>
  ReadTimeout: <span class="token number">60000</span> <span class="token comment">#读超时时间</span>
  MaxAutoRetries: <span class="token number">0</span> <span class="token comment">#重试次数</span>
  MaxAutoRetriesNextServer: <span class="token number">1</span> <span class="token comment">#切换实例的重试次数</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>3、定义降级逻辑</p> <p>两种方法：</p> <p>1）fallback</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Java</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;media-api&quot;</span><span class="token punctuation">,</span>configuration <span class="token operator">=</span> <span class="token class-name">MultipartSupportConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> <span class="token class-name">MediaServiceClientFallback</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/media&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MediaServiceClient</span><span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>定义一个fallback类MediaServiceClientFallback，此类实现了MediaServiceClient接口。</p> <p>第一种方法无法取出熔断所抛出的异常，第二种方法定义MediaServiceClientFallbackFactory 可以解决这个问题。</p> <p>2）fallbackFactory</p> <p>第二种方法在FeignClient中指定fallbackFactory ，如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;media-api&quot;</span><span class="token punctuation">,</span>configuration <span class="token operator">=</span> <span class="token class-name">MultipartSupportConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>fallbackFactory <span class="token operator">=</span> <span class="token class-name">MediaServiceClientFallbackFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>定义MediaServiceClientFallbackFactory如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MediaServiceClientFallbackFactory</span> <span class="token keyword">implements</span> <span class="token class-name">FallbackFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaServiceClient</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">MediaServiceClient</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MediaServiceClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token class-name">MultipartFile</span> upload<span class="token punctuation">,</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//降级方法</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;调用媒资管理服务上传文件时发生熔断，异常信息:{}&quot;</span><span class="token punctuation">,</span>throwable<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>降级处理逻辑：</p> <p>返回一个null对象，上游服务请求接口得到一个null说明执行了降级处理。</p> <p>测试：</p> <p>停止媒资管理服务或人为制造异常观察是否执行降级逻辑。</p> <h3 id="_4-5-4-课程静态化开发"><a href="#_4-5-4-课程静态化开发" class="header-anchor">#</a> 4.5.4 课程静态化开发</h3> <p>课程页面静态化和静态页面远程上传测试通过，下一步开发课程静态化功能，最终使用消息处理SDK去调度执行。</p> <h4 id="_4-5-4-1-添加消息"><a href="#_4-5-4-1-添加消息" class="header-anchor">#</a> 4.5.4.1 添加消息</h4> <p>课程发布操作使用本地事务保存课程发布信息、添加消息表。</p> <p>回到当初编写课程发布时的代码，如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">publish</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">{</span>

 <span class="token comment">//约束校验</span>
 <span class="token comment">//查询课程预发布表</span>
 <span class="token class-name">CoursePublishPre</span> coursePublishPre <span class="token operator">=</span> coursePublishPreMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>coursePublishPre <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;请先提交课程审核，审核通过才可以发布&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">//本机构只允许提交本机构的课程</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>coursePublishPre<span class="token punctuation">.</span><span class="token function">getCompanyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>companyId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;不允许提交其它机构的课程。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token comment">//课程审核状态</span>
 <span class="token class-name">String</span> auditStatus <span class="token operator">=</span> coursePublishPre<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//审核通过方可发布</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">&quot;202004&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>auditStatus<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;操作失败，课程审核通过方可发布。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">//保存课程发布信息</span>
 <span class="token function">saveCoursePublish</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">//保存消息表</span>
 <span class="token function">saveCoursePublishMessage</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//删除课程预发布表对应记录</span>
 coursePublishPreMapper<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>我们要填充的saveCoursePublishMessage(courseId)方法，如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
  * @description 保存消息表记录
  * @param courseId  课程id
  * @return void
  * @author Mr.M
  * @date 2022/9/20 16:32
  */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveCoursePublishMessage</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>
 <span class="token class-name">MqMessage</span> mqMessage <span class="token operator">=</span> mqMessageService<span class="token punctuation">.</span><span class="token function">addMessage</span><span class="token punctuation">(</span><span class="token class-name">CoursePublishTask</span><span class="token punctuation">.</span><span class="token constant">MESSAGE_TYPE</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>mqMessage<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token class-name">CommonError</span><span class="token punctuation">.</span><span class="token constant">UNKOWN_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>下边进行测试：</p> <p>发布一门课程，观察消息表是否正常添加消息。</p> <p>需要手动修改课程审核状态为审核通过执行发布操作，发布后可以修改发布状态为下架重新发布测试。</p> <h4 id="_4-5-4-2-课程静态化实现"><a href="#_4-5-4-2-课程静态化实现" class="header-anchor">#</a> 4.5.4.2 课程静态化实现</h4> <p>课程静态化包括两部分工作：生成课程静态化页面，上传静态页面到文件系统。</p> <p>在课程发布的service编写这两部分内容，最后通过消息去调度执行。</p> <p>1、接口定义</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @description 课程静态化
 * @param courseId  课程id
 * @return File 静态化文件
 * @author Mr.M
 * @date 2022/9/23 16:59
*/</span>
<span class="token keyword">public</span> <span class="token class-name">File</span> <span class="token function">generateCourseHtml</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * @description 上传课程静态化页面
 * @param file  静态化文件
 * @return void
 * @author Mr.M
 * @date 2022/9/23 16:59
*/</span>
<span class="token keyword">public</span> <span class="token keyword">void</span>  <span class="token function">uploadCourseHtml</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">,</span><span class="token class-name">File</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>2、接口实现</p> <p>将之前编写的静态化测试代码以及上传静态文件测试代码拷贝过来使用</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">File</span> <span class="token function">generateCourseHtml</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">//静态化文件</span>
        <span class="token class-name">File</span> htmlFile  <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//配置freemarker</span>
            <span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span><span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//加载模板</span>
            <span class="token comment">//选指定模板路径,classpath下templates下</span>
            <span class="token comment">//得到classpath路径</span>
            <span class="token class-name">String</span> classpath <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            configuration<span class="token punctuation">.</span><span class="token function">setDirectoryForTemplateLoading</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>classpath <span class="token operator">+</span> <span class="token string">&quot;/templates/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设置字符编码</span>
            configuration<span class="token punctuation">.</span><span class="token function">setDefaultEncoding</span><span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//指定模板文件名称</span>
            <span class="token class-name">Template</span> template <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getTemplate</span><span class="token punctuation">(</span><span class="token string">&quot;course_template.ftl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//准备数据</span>
            <span class="token class-name">CoursePreviewDto</span> coursePreviewInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCoursePreviewInfo</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;model&quot;</span><span class="token punctuation">,</span> coursePreviewInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//静态化</span>
            <span class="token comment">//参数1：模板，参数2：数据模型</span>
            <span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token class-name">FreeMarkerTemplateUtils</span><span class="token punctuation">.</span><span class="token function">processTemplateIntoString</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//            System.out.println(content);</span>
            <span class="token comment">//将静态化内容输出到文件中</span>
            <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">toInputStream</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//创建静态化文件</span>
            htmlFile <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">.</span><span class="token function">createTempFile</span><span class="token punctuation">(</span><span class="token string">&quot;course&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;课程静态化，生成静态文件:{}&quot;</span><span class="token punctuation">,</span>htmlFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//输出流</span>
            <span class="token class-name">FileOutputStream</span> outputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>htmlFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> outputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> htmlFile<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">uploadCourseHtml</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">,</span> <span class="token class-name">File</span> file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MultipartFile</span> multipartFile <span class="token operator">=</span> <span class="token class-name">MultipartSupportConfig</span><span class="token punctuation">.</span><span class="token function">getMultipartFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> course <span class="token operator">=</span> mediaServiceClient<span class="token punctuation">.</span><span class="token function">uploadFile</span><span class="token punctuation">(</span>multipartFile<span class="token punctuation">,</span> <span class="token string">&quot;course&quot;</span><span class="token punctuation">,</span> courseId<span class="token operator">+</span><span class="token string">&quot;.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p>完善课程发布任务CoursePublishTask类的代码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//生成课程静态化页面并上传至文件系统</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">generateCourseHtml</span><span class="token punctuation">(</span><span class="token class-name">MqMessage</span> mqMessage<span class="token punctuation">,</span><span class="token keyword">long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;开始进行课程静态化,课程id:{}&quot;</span><span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//消息id</span>
    <span class="token class-name">Long</span> id <span class="token operator">=</span> mqMessage<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//消息处理的service</span>
    <span class="token class-name">MqMessageService</span> mqMessageService <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMqMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//消息幂等性处理</span>
    <span class="token keyword">int</span> stageOne <span class="token operator">=</span> mqMessageService<span class="token punctuation">.</span><span class="token function">getStageOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>stageOne <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;课程静态化已处理直接返回，课程id:{}&quot;</span><span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//生成静态化页面</span>
    <span class="token class-name">File</span> file <span class="token operator">=</span> coursePublishService<span class="token punctuation">.</span><span class="token function">generateCourseHtml</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//上传静态化页面</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>file<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        coursePublishService<span class="token punctuation">.</span><span class="token function">uploadCourseHtml</span><span class="token punctuation">(</span>courseId<span class="token punctuation">,</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//保存第一阶段状态</span>
    mqMessageService<span class="token punctuation">.</span><span class="token function">completedStageOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h4 id="_4-5-4-3-测试"><a href="#_4-5-4-3-测试" class="header-anchor">#</a> 4.5.4.3 测试</h4> <p>1、启动网关、媒资管理服务工程。</p> <p>2、在内容管理api工程的启动类上配置FeignClient</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;com.xuecheng.content.feignclient&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>启动内容管理接口工程。</p> <p>在CoursePublishTask类的execute方法中打上断点。</p> <p>3、发布一门课程，保存消息表存在未处理的处理。</p> <p>4、启动xxl-job调度中心、启动课程发布任务，等待定时调度。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152303315.png" alt="image-20250115230324198"></p> <p>5、观察任务调度日志，观察任务是否可以正常处理。</p> <p>6、处理完成进入文件系统，查询mediafiles桶内是否存在以课程id命名的html文件</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152303846.png" alt="image-20250115230343730"></p> <p>如果不存在说明课程静态化存在问题，再仔细查看执行日志，排查问题。</p> <p>如果存在，用浏览器访问html文件是否可以正常浏览，下图表示可以正常浏览。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152304392.png" alt="image-20250115230411275"></p> <p>页面还没有样式，需要在nginx配置虚拟目录，在www.xucheng-plus.com下配置：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>        location /course/ {  
                proxy_pass http://fileserver/mediafiles/course/;
        } 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>加载nginx配置文件</p> <p>访问：http://www.xuecheng-plus.com/course/2.html</p> <p>2.html为以课程id命名的html文件。</p> <h1 id="_5-课程搜索"><a href="#_5-课程搜索" class="header-anchor">#</a> 5 课程搜索</h1> <h2 id="_5-1-需求分析"><a href="#_5-1-需求分析" class="header-anchor">#</a> 5.1 需求分析</h2> <h3 id="_5-1-1-模块介绍"><a href="#_5-1-1-模块介绍" class="header-anchor">#</a> 5.1.1 模块介绍</h3> <p>搜索功能是一个系统的重要功能，是信息查询的方式。课程搜索是课程展示的渠道，用户通过课程搜索找到课程信息，进一步去查看课程的详细信息，进行选课、支付、学习。</p> <p>本项目的课程搜索支持全文检索技术，什么是全文检索？</p> <p><a href="https://baike.baidu.com/item/%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2/8028630?fromModule=lemma_inlink" target="_blank" rel="noopener noreferrer">全文检索<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>是指计算机索引程序通过扫描文章中的每一个词，对每一个词建立一个索引，指明该词在文章中出现的次数和位置，当用户查询时，检索程序就根据事先建立的索引进行查找，并将查找的结果反馈给用户的检索方式。这个过程类似于通过字典中的检索字表查字的过程。全文搜索搜索引擎数据库中的数据。</p> <p>全文检索可以简单理解为通过索引搜索文章。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152305597.png" alt="image-20250115230553487"></p> <p>全文检索的速度非常快，早期应用在搜索引擎技术中，比如：百度、google等，现在通常一些大型网站的搜索功能都是采用全文检索技术。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152306740.png" alt="image-20250115230618635"></p> <p>课程搜索也要将课程信息建立索引，在课程发布时建立课程索引，索引建立好用户可通过搜索网页去查询课程信息。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152306766.png" alt="image-20250115230644652"></p> <p>所以，课程搜索模块包括两部分：课程索引、课程搜索。</p> <p>课程索引是将课程信息建立索引。</p> <p>课程搜索是通过前端网页，通过关键字等条件去搜索课程。</p> <h3 id="_5-1-2-业务流程"><a href="#_5-1-2-业务流程" class="header-anchor">#</a> 5.1.2 业务流程</h3> <p>根据模块介绍的内容，课程搜索模块包括课程索引、课程搜索两部分。</p> <p>1、课程索引</p> <p>在课程发布操作执行后通过消息处理方式创建课程索引，如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152307890.png" alt="image-20250115230726783"></p> <p>本项目使用elasticsearch作为索引及搜索服务。</p> <p>2、课程搜索</p> <p>课程索引创建完成，用户才可以通过前端搜索课程信息。</p> <p>课程搜索可以从首页进入搜索页面。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152307236.png" alt="image-20250115230748111"></p> <p>下图是搜索界面，可以通过课程分类、课程难度等级等条件进行搜索。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152308322.png" alt="image-20250115230810204"></p> <h2 id="_5-2-准备环境"><a href="#_5-2-准备环境" class="header-anchor">#</a> 5.2 准备环境</h2> <h3 id="_5-2-1-搭建elasticsearch"><a href="#_5-2-1-搭建elasticsearch" class="header-anchor">#</a> 5.2.1 搭建elasticsearch</h3> <p>在课前下发的虚拟中已经在docker容器中安装了elasticsearch和kibana。</p> <p>kibana 是 ELK（Elasticsearch , Logstash, Kibana ）之一，kibana 一款开源的数据分析和可视化平台，通过可视化界面访问elasticsearch的索引库，并可以生成一个数据报表。</p> <p>开发中主要使用kibana通过api对elasticsearch进行索引和搜索操作，通过浏览器访问 http://192.168.101.65:5601/app/dev_tools#/console进入kibana的开发工具界面。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152310107.png" alt="image-20250115230914090"></p> <p>可通过命令：GET /_cat/indices?v 查看所有的索引，通过此命令判断kibana是否正常连接elasticsearch。</p> <p><strong>5.2.2</strong> <strong>创建搜索工程</strong></p> <p>下边创建搜索工程，此工程作为项目的搜索服务，提供索引和搜索两部分的功能。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152309821.png" alt="image-20250115230958707"></p> <p>pom.xml如下：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>xuecheng-plus-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.xuecheng<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">&gt;</span></span>../xuecheng-plus-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>relativePath</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>xuecheng-plus-search<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>


    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.xuecheng<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>xuecheng-plus-base<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.elasticsearch.client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>elasticsearch-rest-high-level-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.elasticsearch<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>elasticsearch<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>



        <span class="token comment">&lt;!-- Spring Boot 的 Spring Web MVC 集成 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-validation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 排除 Spring Boot 依赖的日志包冲突 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-logging<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- Spring Boot 集成 Junit --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- Spring Boot 集成 log4j2 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-log4j2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!-- Spring Boot 集成 swagger --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.spring4all<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>swagger-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>



<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br></div></div><p>bootstrap.yml配置如下：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> search
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.101.65<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml
        <span class="token key atrule">refresh-enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">shared-configs</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> swagger<span class="token punctuation">-</span>$<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>.yaml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>common
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> logging<span class="token punctuation">-</span>$<span class="token punctuation">{</span>spring.profiles.active<span class="token punctuation">}</span>.yaml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>common
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>在nacos添加search-dev.yaml</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">servlet</span><span class="token punctuation">:</span>
    <span class="token key atrule">context-path</span><span class="token punctuation">:</span> /search
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">63080</span>

<span class="token key atrule">elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">hostlist</span><span class="token punctuation">:</span> 192.168.101.65<span class="token punctuation">:</span><span class="token number">9200</span> <span class="token comment">#多个结点中间用逗号分隔</span>
  <span class="token key atrule">course</span><span class="token punctuation">:</span>
    <span class="token key atrule">index</span><span class="token punctuation">:</span> course<span class="token punctuation">-</span>publish
    <span class="token key atrule">source_fields</span><span class="token punctuation">:</span> id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>grade<span class="token punctuation">,</span>mt<span class="token punctuation">,</span>st<span class="token punctuation">,</span>charge<span class="token punctuation">,</span>pic<span class="token punctuation">,</span>price<span class="token punctuation">,</span>originalPrice<span class="token punctuation">,</span>teachmode<span class="token punctuation">,</span>validDays<span class="token punctuation">,</span>createDate
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>编写elasticsearch配置类ElasticsearchConfig</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>package com.xuecheng.search.config;

import org.apache.http.HttpHost;
import org.elasticsearch.client.RestClient;
import org.elasticsearch.client.RestHighLevelClient;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class ElasticsearchConfig <span class="token punctuation">{</span>

    @Value(&quot;$<span class="token punctuation">{</span>elasticsearch.hostlist<span class="token punctuation">}</span>&quot;)
    private String hostlist;

    @Bean
    public RestHighLevelClient restHighLevelClient()<span class="token punctuation">{</span>
        //解析hostlist配置信息
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> split = hostlist.split(&quot;<span class="token punctuation">,</span>&quot;);
        //创建HttpHost数组，其中存放es主机和端口的配置信息
        HttpHost<span class="token punctuation">[</span><span class="token punctuation">]</span> httpHostArray = new HttpHost<span class="token punctuation">[</span>split.length<span class="token punctuation">]</span>;
        for(int i=0;i&lt;split.length;i++)<span class="token punctuation">{</span>
            String item = split<span class="token punctuation">[</span>i<span class="token punctuation">]</span>;
            httpHostArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> = new HttpHost(item.split(&quot;<span class="token punctuation">:</span>&quot;)<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Integer.parseInt(item.split(&quot;<span class="token punctuation">:</span>&quot;)<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>)<span class="token punctuation">,</span> &quot;http&quot;);
        <span class="token punctuation">}</span>
        //创建RestHighLevelClient客户端
        return new RestHighLevelClient(RestClient.builder(httpHostArray));
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h3 id="_5-2-3-创建索引"><a href="#_5-2-3-创建索引" class="header-anchor">#</a> 5.2.3 创建索引</h3> <p>要使用elasticsearch需要建立索引，索引相当于MySQL中的表，Elasticsearch与MySQL之间概念的对应关系见下表：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152312790.png" alt="image-20250115231256664"></p> <p>1、创建索引，并指定Mapping。</p> <p>PUT /course-publish</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;settings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;number_of_shards&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;number_of_replicas&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;mappings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;companyId&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;companyName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;search_analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;search_analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;users&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;search_analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;mt&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;mtName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;st&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;stName&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;grade&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;teachmode&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;pic&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;search_analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;createDate&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;format&quot;</span><span class="token operator">:</span> <span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;date&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;remark&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;charge&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;scaled_float&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;scaling_factor&quot;</span><span class="token operator">:</span> <span class="token number">100</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;originalPrice&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;scaled_float&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;scaling_factor&quot;</span><span class="token operator">:</span> <span class="token number">100</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;validDays&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;integer&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br></div></div><p>2、查询索引</p> <p>通过 GET /_cat/indices?v 查询所有的索引，查找course-publish是否创建成功。</p> <p>通过GET /course-publish/_mapping 查询course-publish的索引结构。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;course-publish&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;mappings&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;properties&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;charge&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;companyId&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;companyName&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;analyzer&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;search_analyzer&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;createDate&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;date&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;format&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;description&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;analyzer&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;search_analyzer&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;grade&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;id&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;mt&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;mtName&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;analyzer&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;search_analyzer&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;originalPrice&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;scaled_float&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;scaling_factor&quot;</span> <span class="token operator">:</span> <span class="token number">100.0</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;pic&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;index&quot;</span> <span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;price&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;scaled_float&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;scaling_factor&quot;</span> <span class="token operator">:</span> <span class="token number">100.0</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;remark&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;index&quot;</span> <span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;st&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;stName&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;status&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;tags&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;analyzer&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;search_analyzer&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;ik_smart&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;teachmode&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;users&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;index&quot;</span> <span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;validDays&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;integer&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br></div></div><p>3、删除索引</p> <p>如果发现创建的course-publish不正确可以删除重新创建。</p> <p>删除索引后当中的文档数据也同时删除，一定要谨慎操作！</p> <p>删除索引命令：DELETE /course-publish</p> <h3 id="_5-2-2-部署搜索工程"><a href="#_5-2-2-部署搜索工程" class="header-anchor">#</a> 5.2.2 部署搜索工程</h3> <p>拷贝课程资料中的xuecheng-plus-search搜索工程到自己的工程目录。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152314392.png" alt="image-20250115231437272"></p> <p>修改bootstrap.xml中nacos的namespace为自己的命名空间。</p> <p>启动网关、搜索服务。</p> <p>部署完成通过httpclient进行测试</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>### 添加课程索引
<span class="token constant">POST</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>search_host<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">/</span>search<span class="token operator">/</span>index<span class="token operator">/</span>course
<span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span><span class="token operator">:</span> application<span class="token operator">/</span>json

<span class="token punctuation">{</span>
  <span class="token string">&quot;charge&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;201000&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;companyId&quot;</span> <span class="token operator">:</span> <span class="token number">100000</span><span class="token punctuation">,</span>
  <span class="token string">&quot;companyName&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;北京黑马程序&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;createDate&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2022-09-25 09:36:11&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;description&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;《Spring编程思想》是2007年6月1日机械工业出版社出版的图书，作者是埃克尔，译者是陈昊鹏。主要内容本书赢得了全球程序员的广泛赞誉，即使是最晦涩的概念，在Bruce Eckel的文字亲和力和小而直接的编程示例面前也会化解于无形。从Java的基础语法到最高级特性（深入的面向对象概念、多线程、自动项目构建、单元测试和调试等），本书都能逐步指导你轻松掌握。从本书获得的各项大奖以及来自世界各地的读者评论中，不难看出这是一本经典之作&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;grade&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;204001&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;id&quot;</span> <span class="token operator">:</span> <span class="token number">102</span><span class="token punctuation">,</span>
  <span class="token string">&quot;mt&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1-3&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;mtName&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;编程开发&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Spring编程思想&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;originalPrice&quot;</span> <span class="token operator">:</span> <span class="token number">200.0</span><span class="token punctuation">,</span>
  <span class="token string">&quot;pic&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;/mediafiles/2022/09/20/1d0f0e6ed8a0c4a89bfd304b84599d9c.png&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;price&quot;</span> <span class="token operator">:</span> <span class="token number">100.0</span><span class="token punctuation">,</span>
  <span class="token string">&quot;remark&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;没有备注&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;st&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1-3-2&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;stName&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Java语言&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;status&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;203002&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;tags&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;没有标签&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;teachmode&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;200002&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;validDays&quot;</span> <span class="token operator">:</span> <span class="token number">222</span>
<span class="token punctuation">}</span>



### 搜索课程
<span class="token constant">GET</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>search_host<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">/</span>search<span class="token operator">/</span>course<span class="token operator">/</span>list<span class="token operator">?</span>pageNo<span class="token operator">=</span><span class="token number">1</span><span class="token operator">&amp;</span>keywords<span class="token operator">=</span>spring
<span class="token class-name">Content</span><span class="token operator">-</span><span class="token class-name">Type</span><span class="token operator">:</span> application<span class="token operator">/</span>json
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>进入前端搜索界面http://www.51xuecheng.cn/course/search.html</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152315898.png" alt="image-20250115231530773"></p> <h2 id="_5-3-索引管理"><a href="#_5-3-索引管理" class="header-anchor">#</a> 5.3 索引管理</h2> <h3 id="_5-3-1-rest-api"><a href="#_5-3-1-rest-api" class="header-anchor">#</a> 5.3.1 REST API</h3> <h4 id="_5-3-1-1-添加文档"><a href="#_5-3-1-1-添加文档" class="header-anchor">#</a> 5.3.1.1 添加文档</h4> <p>索引创建好就可以向其它添加文档，此时elasticsearch会根据索引的mapping配置对有些字段进行分词。</p> <p>这里我们要向course_publish中添加课程信息。</p> <p>使用rest api进行测试，如下：</p> <p>使用post请求，/course-publish/_doc/103 第一部分为索引名称，_doc固定，103为文档的主键id，这里为课程id。</p> <p>课程内容使用json表示。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>POST /course-publish/_doc/<span class="token number">103</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;charge&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;201001&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;companyId&quot;</span> <span class="token operator">:</span> <span class="token number">100000</span><span class="token punctuation">,</span>
  <span class="token property">&quot;companyName&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;北京黑马程序&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;createDate&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2022-09-25 09:36:11&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;description&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;HTML/CSS&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;grade&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;204001&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;id&quot;</span> <span class="token operator">:</span> <span class="token number">102</span><span class="token punctuation">,</span>
  <span class="token property">&quot;mt&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1-1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;mtName&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;前端开发&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Html参考大全&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;originalPrice&quot;</span> <span class="token operator">:</span> <span class="token number">200.0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;pic&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;/mediafiles/2022/09/20/e726b71ba99c70e8c9d2850c2a7019d7.jpg&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;price&quot;</span> <span class="token operator">:</span> <span class="token number">100.0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;remark&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;没有备注&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;st&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1-1-1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;stName&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;HTML/CSS&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;status&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;203002&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;tags&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;没有标签&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;teachmode&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;200002&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;validDays&quot;</span> <span class="token operator">:</span> <span class="token number">222</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>如果要修改文档的内容可以使用上边相同的方法，如果没有则添加，如果存在则更新。</p> <h4 id="_5-3-1-2-查询文档"><a href="#_5-3-1-2-查询文档" class="header-anchor">#</a> 5.3.1.2 查询文档</h4> <p>添加文档成功后可以通过主键id查询该文档的信息。</p> <p>语法如下：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>GET /<span class="token punctuation">{</span>索引库名称<span class="token punctuation">}</span>/_doc/<span class="token punctuation">{</span>id<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_5-3-1-3-更新文档"><a href="#_5-3-1-3-更新文档" class="header-anchor">#</a> 5.3.1.3 更新文档</h4> <p>更新文档分为全量更新和局部更新。</p> <p>全量更新是指先删除再更新，语法如下：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>PUT /<span class="token punctuation">{</span>索引库名<span class="token punctuation">}</span>/_doc/文档id
<span class="token punctuation">{</span>
    <span class="token property">&quot;字段1&quot;</span><span class="token operator">:</span> <span class="token string">&quot;值1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;字段2&quot;</span><span class="token operator">:</span> <span class="token string">&quot;值2&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">// ... 略</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>局部更新语法如下：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>POST /<span class="token punctuation">{</span>索引库名<span class="token punctuation">}</span>/_update/文档id
<span class="token punctuation">{</span>
    <span class="token property">&quot;doc&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
         <span class="token property">&quot;字段名&quot;</span><span class="token operator">:</span> <span class="token string">&quot;新的值&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="_5-3-1-4-删除文档"><a href="#_5-3-1-4-删除文档" class="header-anchor">#</a> 5.3.1.4 删除文档</h4> <p>删除文档将从索引中删除文档的记录。</p> <p>语法如下：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>DELETE /<span class="token punctuation">{</span>索引库名<span class="token punctuation">}</span>/_doc/id值
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_5-3-2-接口定义"><a href="#_5-3-2-接口定义" class="header-anchor">#</a> 5.3.2 接口定义</h3> <p>当课程发布时请求添加课程接口添加课程信息到索引，当课程下架时请求删除课程接口从索引中删除课程信息，这里先实现添加课程接口。</p> <p>根据索引的mapping结构创建po类：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>package com.xuecheng.search.po;

import com.alibaba.fastjson.annotation.JSONField;
import com.fasterxml.jackson.annotation.JsonFormat;
import lombok.Data;

import java.io.Serializable;
import java.time.LocalDateTime;

<span class="token comment">/**
 * &lt;p&gt;
 * 课程索引信息
 * &lt;/p&gt;
 *
 * @author itcast
 */</span>
@Data
public class CourseIndex implements Serializable <span class="token punctuation">{</span>

    private static final long serialVersionUID = 1L;

    <span class="token comment">/**
     * 主键
     */</span>
    private Long id;

    <span class="token comment">/**
     * 机构ID
     */</span>
    private Long companyId;

    <span class="token comment">/**
     * 公司名称
     */</span>
    private String companyName;

    <span class="token comment">/**
     * 课程名称
     */</span>
    private String name;

    <span class="token comment">/**
     * 适用人群
     */</span>
    private String users;

    <span class="token comment">/**
     * 标签
     */</span>
    private String tags;


    <span class="token comment">/**
     * 大分类
     */</span>
    private String mt;

    <span class="token comment">/**
     * 大分类名称
     */</span>
    private String mtName;

    <span class="token comment">/**
     * 小分类
     */</span>
    private String st;

    <span class="token comment">/**
     * 小分类名称
     */</span>
    private String stName;



    <span class="token comment">/**
     * 课程等级
     */</span>
    private String grade;

    <span class="token comment">/**
     * 教育模式
     */</span>
    private String teachmode;
    <span class="token comment">/**
     * 课程图片
     */</span>
    private String pic;

    <span class="token comment">/**
     * 课程介绍
     */</span>
    private String description;


    <span class="token comment">/**
     * 发布时间
     */</span>
    @JSONField(format=<span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)
    @JsonFormat(pattern = <span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)
    private LocalDateTime createDate;

    <span class="token comment">/**
     * 状态
     */</span>
    private String status;

    <span class="token comment">/**
     * 备注
     */</span>
    private String remark;

    <span class="token comment">/**
     * 收费规则，对应数据字典--203
     */</span>
    private String charge;

    <span class="token comment">/**
     * 现价
     */</span>
    private Float price;
    <span class="token comment">/**
     * 原价
     */</span>
    private Float originalPrice;

    <span class="token comment">/**
     * 课程有效期天数
     */</span>
    private Integer validDays;


<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br></div></div><p>创建索引接口如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>execption<span class="token punctuation">.</span></span><span class="token class-name">XueChengPlusException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">CourseIndex</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">IndexService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Api</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">ApiOperation</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestBody</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author Mr.M
 * @version 1.0
 * @description 课程索引接口
 * @date 2022/9/24 22:31
 */</span>
<span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;课程信息索引接口&quot;</span><span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token string">&quot;课程信息索引接口&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/index&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CourseIndexController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;添加课程索引&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;course&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">CourseIndex</span> courseIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>


    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h3 id="_5-3-3-接口开发"><a href="#_5-3-3-接口开发" class="header-anchor">#</a> 5.3.3 接口开发</h3> <p>定义service接口，请求elasticsearch添加课程信息。</p> <p>注意：为了适应其它文档信息，将添加文档定义为通用的添加文档接口，此接口不仅适应添加课程还适应添加其它信息。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">CourseIndex</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author Mr.M
 * @version 1.0
 * @description 课程索引service
 * @date 2022/9/24 22:40
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IndexService</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * @param indexName 索引名称
     * @param id 主键
     * @param object 索引对象
     * @return Boolean true表示成功,false失败
     * @description 添加索引
     * @author Mr.M
     * @date 2022/9/24 22:57
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">addCourseIndex</span><span class="token punctuation">(</span><span class="token class-name">String</span> indexName<span class="token punctuation">,</span><span class="token class-name">String</span> id<span class="token punctuation">,</span><span class="token class-name">Object</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>



<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>接口实现如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>execption<span class="token punctuation">.</span></span><span class="token class-name">XueChengPlusException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">CourseIndex</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">IndexService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span></span><span class="token class-name">DocWriteResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>delete<span class="token punctuation">.</span></span><span class="token class-name">DeleteRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>delete<span class="token punctuation">.</span></span><span class="token class-name">DeleteResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>index<span class="token punctuation">.</span></span><span class="token class-name">IndexRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>index<span class="token punctuation">.</span></span><span class="token class-name">IndexResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>update<span class="token punctuation">.</span></span><span class="token class-name">UpdateRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>update<span class="token punctuation">.</span></span><span class="token class-name">UpdateResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RequestOptions</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RestHighLevelClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>common<span class="token punctuation">.</span>xcontent<span class="token punctuation">.</span></span><span class="token class-name">XContentType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @description 课程索引管理接口实现
 * @author Mr.M
 * @date 2022/9/25 7:23
 * @version 1.0
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IndexServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">IndexService</span> <span class="token punctuation">{</span>



 <span class="token annotation punctuation">@Autowired</span>
 <span class="token class-name">RestHighLevelClient</span> client<span class="token punctuation">;</span>

 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">addCourseIndex</span><span class="token punctuation">(</span><span class="token class-name">String</span> indexName<span class="token punctuation">,</span><span class="token class-name">String</span> id<span class="token punctuation">,</span><span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">String</span> jsonString <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">IndexRequest</span> indexRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span>indexName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//指定索引文档内容</span>
  indexRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">,</span><span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//索引响应对象</span>
  <span class="token class-name">IndexResponse</span> indexResponse <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
   indexResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>indexRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;添加索引出错:{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;添加索引出错&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token class-name">String</span> name <span class="token operator">=</span> indexResponse<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> name<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">&quot;created&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> name<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">&quot;updated&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>

 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><h3 id="_5-3-4-接口完善"><a href="#_5-3-4-接口完善" class="header-anchor">#</a> 5.3.4 接口完善</h3> <p>完善接口：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>execption<span class="token punctuation">.</span></span><span class="token class-name">XueChengPlusException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">CourseIndex</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">IndexService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Api</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">ApiOperation</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestBody</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author Mr.M
 * @version 1.0
 * @description 课程索引接口
 * @date 2022/9/24 22:31
 */</span>
<span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;课程信息索引接口&quot;</span><span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token string">&quot;课程信息索引接口&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/index&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CourseIndexController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${elasticsearch.course.index}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> courseIndexStore<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">IndexService</span> indexService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;添加课程索引&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;course&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">CourseIndex</span> courseIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
        <span class="token class-name">Long</span> id <span class="token operator">=</span> courseIndex<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>id<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;课程id为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Boolean</span> result <span class="token operator">=</span> indexService<span class="token punctuation">.</span><span class="token function">addCourseIndex</span><span class="token punctuation">(</span>courseIndexStore<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> courseIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;添加课程索引失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><h3 id="_5-3-5-接口测试"><a href="#_5-3-5-接口测试" class="header-anchor">#</a> 5.3.5 接口测试</h3> <p>使用httpclient进行测试</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>### 添加课程索引
POST <span class="token punctuation">{</span><span class="token punctuation">{</span>search_host<span class="token punctuation">}</span><span class="token punctuation">}</span>/search/index/course
Content-Type<span class="token operator">:</span> application/json

<span class="token punctuation">{</span>
  <span class="token property">&quot;charge&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;201000&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;companyId&quot;</span> <span class="token operator">:</span> <span class="token number">100000</span><span class="token punctuation">,</span>
  <span class="token property">&quot;companyName&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;北京黑马程序员&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;createDate&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;2022-09-25 09:36:11&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;description&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;《Java编程思想》是2007年6月1日机械工业出版社出版的图书，作者是埃克尔，译者是陈昊鹏。主要内容本书赢得了全球程序员的广泛赞誉，即使是最晦涩的概念，在Bruce Eckel的文字亲和力和小而直接的编程示例面前也会化解于无形。从Java的基础语法到最高级特性（深入的面向对象概念、多线程、自动项目构建、单元测试和调试等），本书都能逐步指导你轻松掌握。从本书获得的各项大奖以及来自世界各地的读者评论中，不难看出这是一本经典之作&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;grade&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;204001&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;id&quot;</span> <span class="token operator">:</span> <span class="token number">102</span><span class="token punctuation">,</span>
  <span class="token property">&quot;mt&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1-3&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;mtName&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;编程开发&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Java编程思想&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;originalPrice&quot;</span> <span class="token operator">:</span> <span class="token number">200.0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;pic&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;/mediafiles/2022/09/20/1d0f0e6ed8a0c4a89bfd304b84599d9c.png&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;price&quot;</span> <span class="token operator">:</span> <span class="token number">100.0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;remark&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;没有备注&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;st&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;1-3-2&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;stName&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Java语言&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;status&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;203002&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;tags&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;没有标签&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;teachmode&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;200002&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;validDays&quot;</span> <span class="token operator">:</span> <span class="token number">222</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h2 id="_5-4-搜索"><a href="#_5-4-搜索" class="header-anchor">#</a> 5.4 搜索</h2> <h3 id="_5-4-1-需求分析"><a href="#_5-4-1-需求分析" class="header-anchor">#</a> 5.4.1 需求分析</h3> <p>索引信息维护完成下一步定义搜索接口搜索课程信息，首先需要搞清楚搜索功能的需求。</p> <p>进入搜索界面，如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152321259.png" alt="image-20250115232154118"></p> <p>根据搜索界面可知需求如下：</p> <p>1、根据一级分类、二级分类搜索课程信息。</p> <p>2、根据关键字搜索课程信息，搜索方式为全文检索，关键字需要匹配课程的名称、 课程内容。</p> <p>3、根据难度等级搜索课程。</p> <p>4、搜索结点分页显示。</p> <p>技术点：</p> <p>1、整体采用布尔查询。</p> <p>2、根据关键字搜索，采用MultiMatchQuery，搜索name、description字段。</p> <p>3、根据分类、课程等级搜索采用过虑器实现。</p> <p>4、分页查询。</p> <p>5、高亮显示。</p> <p>为什么课程分类、课程等待等查询使用过虑器方式？</p> <h3 id="_5-4-2-接口定义"><a href="#_5-4-2-接口定义" class="header-anchor">#</a> 5.4.2 接口定义</h3> <p>1、定义搜索条件DTO类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>dto</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">ToString</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @description 搜索课程参数dtl
 * @author Mr.M
 * @date 2022/9/24 22:36
 * @version 1.0
 */</span>
 <span class="token annotation punctuation">@Data</span>
 <span class="token annotation punctuation">@ToString</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchCourseParamDto</span> <span class="token punctuation">{</span>

  <span class="token comment">//关键字</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> keywords<span class="token punctuation">;</span>

  <span class="token comment">//大分类</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> mt<span class="token punctuation">;</span>

  <span class="token comment">//小分类</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> st<span class="token punctuation">;</span>
  <span class="token comment">//难度等级</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> grade<span class="token punctuation">;</span>


<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>2、为了适应后期的扩展，定义搜索结果类，让它继承PageResult</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>dto</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">PageResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">ToString</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author Mr.M
 * @version 1.0
 * @description TODO
 * @date 2022/9/25 17:51
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@ToString</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">PageResult</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">SearchPageResultDto</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> items<span class="token punctuation">,</span> <span class="token keyword">long</span> counts<span class="token punctuation">,</span> <span class="token keyword">long</span> page<span class="token punctuation">,</span> <span class="token keyword">long</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>items<span class="token punctuation">,</span> counts<span class="token punctuation">,</span> page<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>接口定义如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">PageParams</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">PageResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">SearchCourseParamDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">CourseIndex</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">CourseSearchService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Api</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>swagger<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">ApiOperation</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @description 课程搜索接口
 * @author Mr.M
 * @date 2022/9/24 22:31
 * @version 1.0
 */</span>
<span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;课程搜索接口&quot;</span><span class="token punctuation">,</span>tags <span class="token operator">=</span> <span class="token string">&quot;课程搜索接口&quot;</span><span class="token punctuation">)</span>
 <span class="token annotation punctuation">@RestController</span>
 <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/course&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CourseSearchController</span> <span class="token punctuation">{</span>



 <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;课程搜索列表&quot;</span><span class="token punctuation">)</span>
  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/list&quot;</span><span class="token punctuation">)</span>
 <span class="token keyword">public</span> <span class="token class-name">PageResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token class-name">PageParams</span> pageParams<span class="token punctuation">,</span> <span class="token class-name">SearchCourseParamDto</span> searchCourseParamDto<span class="token punctuation">)</span><span class="token punctuation">{</span>

    
   
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h3 id="_5-4-3-基本功能实现"><a href="#_5-4-3-基本功能实现" class="header-anchor">#</a> 5.4.3 基本功能实现</h3> <p>定义service接口，如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">PageParams</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">PageResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">SearchCourseParamDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">SearchPageResultDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">CourseIndex</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @description 课程搜索service
 * @author Mr.M
 * @date 2022/9/24 22:40
 * @version 1.0
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CourseSearchService</span> <span class="token punctuation">{</span>


    <span class="token comment">/**
     * @description 搜索课程列表
     * @param pageParams 分页参数
     * @param searchCourseParamDto 搜索条件
     * @return com.xuecheng.base.model.PageResult&lt;com.xuecheng.search.po.CourseIndex&gt; 课程列表
     * @author Mr.M
     * @date 2022/9/24 22:45
    */</span>
    <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryCoursePubIndex</span><span class="token punctuation">(</span><span class="token class-name">PageParams</span> pageParams<span class="token punctuation">,</span> <span class="token class-name">SearchCourseParamDto</span> searchCourseParamDto<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>搜索接口的内容较多，我们分几步实现，首先实现根据分页搜索，接口实现如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">PageParams</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">PageResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">SearchCourseParamDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">SearchPageResultDto</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token class-name">CourseIndex</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">CourseSearchService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>lucene<span class="token punctuation">.</span>search<span class="token punctuation">.</span></span><span class="token class-name">TotalHits</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>search<span class="token punctuation">.</span></span><span class="token class-name">SearchRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>action<span class="token punctuation">.</span>search<span class="token punctuation">.</span></span><span class="token class-name">SearchResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RequestOptions</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RestHighLevelClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>common<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">Text</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>index<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">BoolQueryBuilder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>index<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">MultiMatchQueryBuilder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>index<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">QueryBuilders</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>search<span class="token punctuation">.</span></span><span class="token class-name">SearchHit</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>search<span class="token punctuation">.</span></span><span class="token class-name">SearchHits</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>search<span class="token punctuation">.</span>aggregations<span class="token punctuation">.</span></span><span class="token class-name">AggregationBuilders</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>search<span class="token punctuation">.</span>aggregations<span class="token punctuation">.</span></span><span class="token class-name">Aggregations</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>search<span class="token punctuation">.</span>aggregations<span class="token punctuation">.</span>bucket<span class="token punctuation">.</span>terms<span class="token punctuation">.</span></span><span class="token class-name">Terms</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>search<span class="token punctuation">.</span>builder<span class="token punctuation">.</span></span><span class="token class-name">SearchSourceBuilder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>search<span class="token punctuation">.</span>fetch<span class="token punctuation">.</span>subphase<span class="token punctuation">.</span>highlight<span class="token punctuation">.</span></span><span class="token class-name">HighlightBuilder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>search<span class="token punctuation">.</span>fetch<span class="token punctuation">.</span>subphase<span class="token punctuation">.</span>highlight<span class="token punctuation">.</span></span><span class="token class-name">HighlightField</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author Mr.M
 * @version 1.0
 * @description 课程搜索service实现类
 * @date 2022/9/24 22:48
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CourseSearchServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">CourseSearchService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${elasticsearch.course.index}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> courseIndexStore<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${elasticsearch.course.source_fields}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> sourceFields<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RestHighLevelClient</span> client<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryCoursePubIndex</span><span class="token punctuation">(</span><span class="token class-name">PageParams</span> pageParams<span class="token punctuation">,</span> <span class="token class-name">SearchCourseParamDto</span> courseSearchParam<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">//设置索引</span>
        <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>courseIndexStore<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BoolQueryBuilder</span> boolQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//source源字段过虑</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sourceFieldsArray <span class="token operator">=</span> sourceFields<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">fetchSource</span><span class="token punctuation">(</span>sourceFieldsArray<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//分页</span>
        <span class="token class-name">Long</span> pageNo <span class="token operator">=</span> pageParams<span class="token punctuation">.</span><span class="token function">getPageNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> pageSize <span class="token operator">=</span> pageParams<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pageNo<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">toIntExact</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//布尔查询</span>
        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>boolQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//请求搜索</span>
        searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
       
        
        <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;课程搜索异常：{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//结果集处理</span>
        <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> searchHits <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//记录总数</span>
        <span class="token class-name">TotalHits</span> totalHits <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//数据列表</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> searchHits<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token class-name">String</span> sourceAsString <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CourseIndex</span> courseIndex <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>sourceAsString<span class="token punctuation">,</span> <span class="token class-name">CourseIndex</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>courseIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span> pageResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> totalHits<span class="token punctuation">.</span>value<span class="token punctuation">,</span>pageNo<span class="token punctuation">,</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

        

        <span class="token keyword">return</span> pageResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br></div></div><h3 id="_5-4-4-基本功能测试"><a href="#_5-4-4-基本功能测试" class="header-anchor">#</a> 5.4.4 基本功能测试</h3> <p>当输入查询条件时会查询全部课程信息并支持分页查询。</p> <p>1、准备测试</p> <p>启动nginx、网关、搜索服务。</p> <p>使用kibana通过rest api向索引库添加课程信息，或通过httpclient添加课程信息，至少添加两条信息。</p> <p>2、进入搜索界面</p> <p>默认查询出刚才添加的课程信息。</p> <p>3、修改分页参数测试分页</p> <p>打开course/ search.html页面 ，找到如下图所示位置：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152324914.png" alt="image-20250115232457765"></p> <p>修改pageSize为1,即一页显示一条记录。</p> <p>刷新搜索界面，每页显示一条记录，如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152325614.png" alt="image-20250115232525463"></p> <h3 id="_5-4-5-根据条件搜索"><a href="#_5-4-5-根据条件搜索" class="header-anchor">#</a> 5.4.5 根据条件搜索</h3> <p>下边实现根据关键、一级分类、二级分类、难度等级搜索。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryCoursePubIndex</span><span class="token punctuation">(</span><span class="token class-name">PageParams</span> pageParams<span class="token punctuation">,</span> <span class="token class-name">SearchCourseParamDto</span> courseSearchParam<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//设置索引</span>
    <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>courseIndexStore<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BoolQueryBuilder</span> boolQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//source源字段过虑</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sourceFieldsArray <span class="token operator">=</span> sourceFields<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">fetchSource</span><span class="token punctuation">(</span>sourceFieldsArray<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>courseSearchParam<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        courseSearchParam <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchCourseParamDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//关键字</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getKeywords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//匹配关键字</span>
        <span class="token class-name">MultiMatchQueryBuilder</span> multiMatchQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">multiMatchQuery</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getKeywords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;description&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置匹配占比</span>
        multiMatchQueryBuilder<span class="token punctuation">.</span><span class="token function">minimumShouldMatch</span><span class="token punctuation">(</span><span class="token string">&quot;70%&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//提升另个字段的Boost值</span>
        multiMatchQueryBuilder<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        boolQueryBuilder<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span>multiMatchQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//过虑</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getMt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;mtName&quot;</span><span class="token punctuation">,</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getMt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getSt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;stName&quot;</span><span class="token punctuation">,</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getSt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getGrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;grade&quot;</span><span class="token punctuation">,</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getGrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//分页</span>
    <span class="token class-name">Long</span> pageNo <span class="token operator">=</span> pageParams<span class="token punctuation">.</span><span class="token function">getPageNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Long</span> pageSize <span class="token operator">=</span> pageParams<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pageNo<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">toIntExact</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//布尔查询</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>boolQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//请求搜索</span>
    searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
   
    <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;课程搜索异常：{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//结果集处理</span>
    <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> searchHits <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//记录总数</span>
    <span class="token class-name">TotalHits</span> totalHits <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//数据列表</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> searchHits<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">String</span> sourceAsString <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CourseIndex</span> courseIndex <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>sourceAsString<span class="token punctuation">,</span> <span class="token class-name">CourseIndex</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>courseIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span> pageResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> totalHits<span class="token punctuation">.</span>value<span class="token punctuation">,</span>pageNo<span class="token punctuation">,</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    

    <span class="token keyword">return</span> pageResult<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br></div></div><h3 id="_5-4-6-条件搜索测试"><a href="#_5-4-6-条件搜索测试" class="header-anchor">#</a> 5.4.6 条件搜索测试</h3> <p>进入搜索界面，输入关键字进行测试。</p> <p>一级分类、二级分类在下边的聚合搜索中测试。</p> <h3 id="_5-4-7-聚合搜索"><a href="#_5-4-7-聚合搜索" class="header-anchor">#</a> 5.4.7 聚合搜索</h3> <p>搜索界面上显示的一级分类、二级分类来源于搜索结果，使用聚合搜索实现找到搜索结果中的一级分类、二级分类。</p> <p>1、首先在搜索结构DTO中添加一级分类、二级分类列表</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>search<span class="token punctuation">.</span>dto</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>base<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">PageResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">ToString</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author Mr.M
 * @version 1.0
 * @description TODO
 * @date 2022/9/25 17:51
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@ToString</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">PageResult</span> <span class="token punctuation">{</span>

    <span class="token comment">//大分类列表</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> mtList<span class="token punctuation">;</span>
    <span class="token comment">//小分类列表</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stList<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SearchPageResultDto</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> items<span class="token punctuation">,</span> <span class="token keyword">long</span> counts<span class="token punctuation">,</span> <span class="token keyword">long</span> page<span class="token punctuation">,</span> <span class="token keyword">long</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>items<span class="token punctuation">,</span> counts<span class="token punctuation">,</span> page<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>2、搜索方法如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryCoursePubIndex</span><span class="token punctuation">(</span><span class="token class-name">PageParams</span> pageParams<span class="token punctuation">,</span> <span class="token class-name">SearchCourseParamDto</span> courseSearchParam<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//设置索引</span>
    <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>courseIndexStore<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BoolQueryBuilder</span> boolQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//source源字段过虑</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sourceFieldsArray <span class="token operator">=</span> sourceFields<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">fetchSource</span><span class="token punctuation">(</span>sourceFieldsArray<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>courseSearchParam<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        courseSearchParam <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchCourseParamDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//关键字</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getKeywords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//匹配关键字</span>
        <span class="token class-name">MultiMatchQueryBuilder</span> multiMatchQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">multiMatchQuery</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getKeywords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;description&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置匹配占比</span>
        multiMatchQueryBuilder<span class="token punctuation">.</span><span class="token function">minimumShouldMatch</span><span class="token punctuation">(</span><span class="token string">&quot;70%&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//提升另个字段的Boost值</span>
        multiMatchQueryBuilder<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        boolQueryBuilder<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span>multiMatchQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//过虑</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getMt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;mtName&quot;</span><span class="token punctuation">,</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getMt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getSt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;stName&quot;</span><span class="token punctuation">,</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getSt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getGrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;grade&quot;</span><span class="token punctuation">,</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getGrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//分页</span>
    <span class="token class-name">Long</span> pageNo <span class="token operator">=</span> pageParams<span class="token punctuation">.</span><span class="token function">getPageNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Long</span> pageSize <span class="token operator">=</span> pageParams<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pageNo<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">toIntExact</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//布尔查询</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>boolQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
   
   
    <span class="token comment">//请求搜索</span>
    searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//聚合设置</span>
    <span class="token function">buildAggregation</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;课程搜索异常：{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//结果集处理</span>
    <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> searchHits <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//记录总数</span>
    <span class="token class-name">TotalHits</span> totalHits <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//数据列表</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> searchHits<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">String</span> sourceAsString <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CourseIndex</span> courseIndex <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>sourceAsString<span class="token punctuation">,</span> <span class="token class-name">CourseIndex</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        

        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>courseIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span> pageResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> totalHits<span class="token punctuation">.</span>value<span class="token punctuation">,</span>pageNo<span class="token punctuation">,</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//获取聚合结果</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> mtList<span class="token operator">=</span> <span class="token function">getAggregation</span><span class="token punctuation">(</span>searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;mtAgg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stList <span class="token operator">=</span> <span class="token function">getAggregation</span><span class="token punctuation">(</span>searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;stAgg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    pageResult<span class="token punctuation">.</span><span class="token function">setMtList</span><span class="token punctuation">(</span>mtList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pageResult<span class="token punctuation">.</span><span class="token function">setStList</span><span class="token punctuation">(</span>stList<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> pageResult<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br></div></div><h3 id="_5-4-8-聚合搜索测试"><a href="#_5-4-8-聚合搜索测试" class="header-anchor">#</a> 5.4.8 聚合搜索测试</h3> <p>进入搜索界面，观察搜索请求的响应内容中是否存在mtList和stList.</p> <p>观察页面一级分类、二级分类是否有分类信息。</p> <p>注意：当选中一个一级分类时才会显示二级分类。</p> <h3 id="_5-4-9-高亮设置"><a href="#_5-4-9-高亮设置" class="header-anchor">#</a> 5.4.9 高亮设置</h3> <p>最后实现关键词在课程名称中高亮显示。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryCoursePubIndex</span><span class="token punctuation">(</span><span class="token class-name">PageParams</span> pageParams<span class="token punctuation">,</span> <span class="token class-name">SearchCourseParamDto</span> courseSearchParam<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//设置索引</span>
    <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span>courseIndexStore<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BoolQueryBuilder</span> boolQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//source源字段过虑</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sourceFieldsArray <span class="token operator">=</span> sourceFields<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">fetchSource</span><span class="token punctuation">(</span>sourceFieldsArray<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>courseSearchParam<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        courseSearchParam <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchCourseParamDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//关键字</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getKeywords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//匹配关键字</span>
        <span class="token class-name">MultiMatchQueryBuilder</span> multiMatchQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">multiMatchQuery</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getKeywords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;description&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置匹配占比</span>
        multiMatchQueryBuilder<span class="token punctuation">.</span><span class="token function">minimumShouldMatch</span><span class="token punctuation">(</span><span class="token string">&quot;70%&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//提升另个字段的Boost值</span>
        multiMatchQueryBuilder<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        boolQueryBuilder<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span>multiMatchQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//过虑</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getMt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;mtName&quot;</span><span class="token punctuation">,</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getMt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getSt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;stName&quot;</span><span class="token punctuation">,</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getSt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getGrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;grade&quot;</span><span class="token punctuation">,</span>courseSearchParam<span class="token punctuation">.</span><span class="token function">getGrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//分页</span>
    <span class="token class-name">Long</span> pageNo <span class="token operator">=</span> pageParams<span class="token punctuation">.</span><span class="token function">getPageNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Long</span> pageSize <span class="token operator">=</span> pageParams<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pageNo<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">toIntExact</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//布尔查询</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>boolQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//高亮设置</span>
    <span class="token class-name">HighlightBuilder</span> highlightBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HighlightBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    highlightBuilder<span class="token punctuation">.</span><span class="token function">preTags</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;font class='eslight'&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    highlightBuilder<span class="token punctuation">.</span><span class="token function">postTags</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/font&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置高亮字段</span>
    highlightBuilder<span class="token punctuation">.</span><span class="token function">fields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HighlightBuilder<span class="token punctuation">.</span>Field</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchSourceBuilder<span class="token punctuation">.</span><span class="token function">highlighter</span><span class="token punctuation">(</span>highlightBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//请求搜索</span>
    searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//聚合设置</span>
    <span class="token function">buildAggregation</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        searchResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;课程搜索异常：{}&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//结果集处理</span>
    <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> searchHits <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//记录总数</span>
    <span class="token class-name">TotalHits</span> totalHits <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//数据列表</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> searchHits<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">String</span> sourceAsString <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CourseIndex</span> courseIndex <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>sourceAsString<span class="token punctuation">,</span> <span class="token class-name">CourseIndex</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//取出source</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> sourceAsMap <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//课程id</span>
        <span class="token class-name">Long</span> id <span class="token operator">=</span> courseIndex<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//取出名称</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> courseIndex<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//取出高亮字段内容</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">HighlightField</span><span class="token punctuation">&gt;</span></span> highlightFields <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getHighlightFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>highlightFields<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">HighlightField</span> nameField <span class="token operator">=</span> highlightFields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>nameField<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">Text</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fragments <span class="token operator">=</span> nameField<span class="token punctuation">.</span><span class="token function">getFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">StringBuffer</span> stringBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Text</span> str <span class="token operator">:</span> fragments<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    stringBuffer<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                name <span class="token operator">=</span> stringBuffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        courseIndex<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        courseIndex<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>courseIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseIndex</span><span class="token punctuation">&gt;</span></span> pageResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchPageResultDto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> totalHits<span class="token punctuation">.</span>value<span class="token punctuation">,</span>pageNo<span class="token punctuation">,</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//获取聚合结果</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> mtList<span class="token operator">=</span> <span class="token function">getAggregation</span><span class="token punctuation">(</span>searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;mtAgg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stList <span class="token operator">=</span> <span class="token function">getAggregation</span><span class="token punctuation">(</span>searchResponse<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;stAgg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    pageResult<span class="token punctuation">.</span><span class="token function">setMtList</span><span class="token punctuation">(</span>mtList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pageResult<span class="token punctuation">.</span><span class="token function">setStList</span><span class="token punctuation">(</span>stList<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> pageResult<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br></div></div><h3 id="_5-4-10-高亮设置测试"><a href="#_5-4-10-高亮设置测试" class="header-anchor">#</a> 5.4.10 高亮设置测试</h3> <p>输入关键字，观察搜索结果，标题中是否对关键字信息进行高亮显示。</p> <h2 id="_5-5-课程信息索引同步"><a href="#_5-5-课程信息索引同步" class="header-anchor">#</a> 5.5 课程信息索引同步</h2> <h3 id="_5-5-1-技术方案"><a href="#_5-5-1-技术方案" class="header-anchor">#</a> 5.5.1 技术方案</h3> <p>通过向索引中添加课程信息最终实现了课程的搜索，我们发现课程信息是先保存在关系数据库中，而后再写入索引，这个过程是将关系数据中的数据同步到elasticsearch索引中的过程，可以简单成为索引同步。</p> <p>通常项目中使用elasticsearch需要完成索引同步，索引同步的方法很多：</p> <p>1、针对实时性非常高的场景需要满足数据的及时同步，可以同步调用，或使用Canal去实现。</p> <p>1）同步调用即在向MySQL写数据后远程调用搜索服务的接口写入索引，此方法简单但是耦合代码太高。</p> <p>2）可以使用一个中间的软件canal解决耦合性的问题，但存在学习与维护成本。</p> <p>canal主要用途是基于 MySQL 数据库增量日志解析，并能提供增量数据订阅和消费，实现将MySQL的数据同步到消息队列、Elasticsearch、其它数据库等，应用场景十分丰富。</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152328002.png" alt="image-20250115232850841"></p> <p>它的地址：</p> <p>github地址：https://github.com/alibaba/canal</p> <p>版本下载地址：https://github.com/alibaba/canal/releases</p> <p>文档地址：https://github.com/alibaba/canal/wiki/Docker-QuickStart</p> <p>Canal基于mysql的binlog技术实现数据同步，什么是binlog，它是一个文件，二进制格式，记录了对数据库更新的SQL语句，向数据库写数据的同时向binlog文件里记录对应的sql语句。当数据库服务器发生了故障就可以使用binlog文件对数据库进行恢复。</p> <p>所以，使用canal是需要开启mysql的binlog写入功能，Canal工作原理如下：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152329588.png" alt="image-20250115232923433"></p> <p>1、canal 模拟 MySQL slave 的交互协议，伪装自己为 MySQL slave ，向 MySQL master 发送dump</p> <p>协议</p> <p>2、MySQL master 收到 dump 请求，开始推送 binary log 给 slave (即 canal )</p> <p>3、canal 解析 binary log 对象(原始为 byte 流)</p> <p>详细使用Canal进行索引同步的步骤参考：Canal实现索引同步.pdf</p> <p>2、当索引同步的实时性要求不高时可用的技术比较多，比如：MQ、Logstash、任务调度等。</p> <p>MQ：向mysql写数据的时候向mq写入消息，搜索服务监听MQ，收到消息后写入索引。使用MQ的优势是代码解耦，但是需要处理消息可靠性的问题有一定的技术成本，做到消息可靠性需要做到生产者投递成功、消息持久化以及消费者消费成功三个方面，另外还要做好消息幂等性问题。</p> <p>Logstash： 开源实时日志分析平台 ELK包括Elasticsearch、Kibana、Logstash，Logstash负责收集、解析和转换日志信息，可以实现MySQL与Elasticsearch之间的数据同步。也可以实现解耦合并且是官方推荐，但需要增加学习与维护成本。</p> <p>任务调度：向mysql写数据的时候记录修改记录，开启一个定时任务根据修改记录将数据同步到Elasticsearch。</p> <p>根据本项目的需求，课程发布后信息同步的实时性要求不高，从提交审核到发布成功一般两个工作日完成。综合比较以上技术方案本项目的索引同步技术使用任务调度的方法。</p> <p>如下图：</p> <p><img src="https://raw.githubusercontent.com/onetioner/img/main/PicGo2/202501152329728.png" alt="image-20250115232944574"></p> <p>1、课程发布向消息表插入记录。</p> <p>2、由任务调度程序通过消息处理SDK对消息记录进行处理。</p> <p>3、向elasticsearch索引中保存课程信息。</p> <p>如何向向elasticsearch索引中保存课程信息？</p> <p>执行流程如下：</p> <p>由内容管理服务远程调用搜索服务添加课程信息索引，搜索服务再请求elasticsearch向课程索引中添加文档。</p> <h3 id="_5-5-2-课程索引任务开发"><a href="#_5-5-2-课程索引任务开发" class="header-anchor">#</a> 5.5.2 课程索引任务开发</h3> <p>1、拷贝CourseIndex 模型类到内容管理model 工程的dto包下。</p> <p>2、在内容管理服务中添加FeignClient</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>feignclient</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xuecheng<span class="token punctuation">.</span>content<span class="token punctuation">.</span>model<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">CourseIndex</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestBody</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @description 搜索服务远程接口
 * @author Mr.M
 * @date 2022/9/20 20:29
 * @version 1.0
 */</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;search&quot;</span><span class="token punctuation">,</span>fallbackFactory <span class="token operator">=</span> <span class="token class-name">SearchServiceClientFallbackFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SearchServiceClient</span> <span class="token punctuation">{</span>

 <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/search/index/course&quot;</span><span class="token punctuation">)</span>
 <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">CourseIndex</span> courseIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>定义SearchServiceClientFallbackFactory ：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchServiceClientFallbackFactory</span> <span class="token keyword">implements</span> <span class="token class-name">FallbackFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SearchServiceClient</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">SearchServiceClient</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SearchServiceClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">CourseIndex</span> courseIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                throwable<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;调用搜索发生熔断走降级方法,熔断异常:&quot;</span><span class="token punctuation">,</span> throwable<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>3、编写课程索引任务执行方法</p> <p>完善CoursePublishTask类中的saveCourseIndex方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//保存课程索引信息</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveCourseIndex</span><span class="token punctuation">(</span><span class="token class-name">MqMessage</span> mqMessage<span class="token punctuation">,</span><span class="token keyword">long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;保存课程索引信息,课程id:{}&quot;</span><span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//消息id</span>
    <span class="token class-name">Long</span> id <span class="token operator">=</span> mqMessage<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//消息处理的service</span>
    <span class="token class-name">MqMessageService</span> mqMessageService <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMqMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//消息幂等性处理</span>
    <span class="token keyword">int</span> stageTwo <span class="token operator">=</span> mqMessageService<span class="token punctuation">.</span><span class="token function">getStageTwo</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>stageTwo <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;课程索引已处理直接返回，课程id:{}&quot;</span><span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Boolean</span> result <span class="token operator">=</span> <span class="token function">saveCourseIndex</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//保存第一阶段状态</span>
        mqMessageService<span class="token punctuation">.</span><span class="token function">completedStageTwo</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">Boolean</span> <span class="token function">saveCourseIndex</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//取出课程发布信息</span>
    <span class="token class-name">CoursePublish</span> coursePublish <span class="token operator">=</span> coursePublishMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//拷贝至课程索引对象</span>
    <span class="token class-name">CourseIndex</span> courseIndex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CourseIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>coursePublish<span class="token punctuation">,</span>courseIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//远程调用搜索服务api添加课程信息到索引</span>
    <span class="token class-name">Boolean</span> add <span class="token operator">=</span> searchServiceClient<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>courseIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>add<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">&quot;添加索引失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> add<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h3 id="_5-5-3-测试"><a href="#_5-5-3-测试" class="header-anchor">#</a> 5.5.3 测试</h3> <p>测试流程如下：</p> <p>1、启动elasticsearch、kibana。</p> <p>2、启动网关、内容管理、搜索服务、nginx。</p> <p>3、启动xxl-job调度中心。</p> <p>4、在任务调度中心开始课程发布任务。</p> <p>5、发布一门课程，页面提示操作成功，查看发布课程任务是否写到任务表。</p> <p>6、经过任务调度将课程信息写入索引。</p> <p>7、通过门户进入搜索页面，查看课程信息是否展示。</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/xugaoyi/vuepress-theme-vdoing/edit/master/docs/《XueChengPlus》笔记/05.第4章-课程发布.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2025/01/16, 19:32:32</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/vuepress-tion-blog/pages/02b6b3/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">第3章-媒资管理模块</div></a> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/vuepress-tion-blog/pages/02b6b3/" class="prev">第3章-媒资管理模块</a></span> <!----></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/vuepress-tion-blog/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/vuepress-tion-blog/pages/31d7dd/"><div>
            05-大数据技术之Hadoop（Yarn）V3.3
            <!----></div></a> <span class="date">02-24</span></dt></dl><dl><dd>02</dd> <dt><a href="/vuepress-tion-blog/pages/fc670b/"><div>
            Linux实用操作
            <!----></div></a> <span class="date">02-22</span></dt></dl><dl><dd>03</dd> <dt><a href="/vuepress-tion-blog/pages/bdd22a/"><div>
            用户和权限
            <!----></div></a> <span class="date">02-22</span></dt></dl> <dl><dd></dd> <dt><a href="/vuepress-tion-blog/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:894072666@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/xugaoyi" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2025
    <span>Evan Xu | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a> | <a href="http://beian.miit.gov.cn/" target="_blank">桂ICP备2024034950号</a> | <img src="/img/beian.png" style="width: 15px; margin-bottom: -3px;" /> <a href="https://beian.mps.gov.cn/#/query/webSearch?code=45142202000030" rel="noreferrer" target="_blank">桂公网安备45142202000030</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/vuepress-tion-blog/assets/js/app.985e0c44.js" defer></script><script src="/vuepress-tion-blog/assets/js/2.1e9277be.js" defer></script><script src="/vuepress-tion-blog/assets/js/208.98b8311d.js" defer></script>
  </body>
</html>
